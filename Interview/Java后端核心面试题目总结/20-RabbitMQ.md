## RabbitMQ æ˜¯ä»€ä¹ˆï¼Ÿ

RabbitMQ æ˜¯ä¸€ä¸ªç”± Erlang è¯­è¨€å¼€å‘çš„ AMQP çš„å¼€æºå®ç°ã€‚

> AMQP ï¼šAdvanced Message Queueï¼Œé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ã€‚å®ƒæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ï¼ŒåŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—äº§å“ã€å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚

RabbitMQ æœ€åˆèµ·æºäºé‡‘èç³»ç»Ÿï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ï¼Œåœ¨æ˜“ç”¨æ€§ã€æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§ç­‰æ–¹é¢è¡¨ç°ä¸ä¿—ã€‚å…·ä½“ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- 1ã€å¯é æ€§ï¼ˆReliabilityï¼‰

  > RabbitMQ ä½¿ç”¨ä¸€äº›æœºåˆ¶æ¥ä¿è¯å¯é æ€§ï¼Œå¦‚æŒä¹…åŒ–ã€ä¼ è¾“ç¡®è®¤ã€å‘å¸ƒç¡®è®¤ã€‚

- 2ã€çµæ´»çš„è·¯ç”±ï¼ˆFlexible Routingï¼‰

  > åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œé€šè¿‡ Exchange æ¥è·¯ç”±æ¶ˆæ¯çš„ã€‚å¯¹äºå…¸å‹çš„è·¯ç”±åŠŸèƒ½ï¼ŒRabbitMQ å·²ç»æä¾›äº†ä¸€äº›å†…ç½®çš„ Exchange æ¥å®ç°ã€‚é’ˆå¯¹æ›´å¤æ‚çš„è·¯ç”±åŠŸèƒ½ï¼Œå¯ä»¥å°†å¤šä¸ª Exchange ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¹Ÿé€šè¿‡æ’ä»¶æœºåˆ¶å®ç°è‡ªå·±çš„ Exchange ã€‚

- 3ã€æ¶ˆæ¯é›†ç¾¤ï¼ˆClusteringï¼‰

  > å¤šä¸ª RabbitMQ æœåŠ¡å™¨å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå½¢æˆä¸€ä¸ªé€»è¾‘ Broker ã€‚

- 4ã€é«˜å¯ç”¨ï¼ˆHighly Available Queuesï¼‰

  > é˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šè¿›è¡Œé•œåƒï¼Œä½¿å¾—åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºé—®é¢˜çš„æƒ…å†µä¸‹é˜Ÿåˆ—ä»ç„¶å¯ç”¨ã€‚

- 5ã€å¤šç§åè®®ï¼ˆMulti-protocolï¼‰

  > RabbitMQ æ”¯æŒå¤šç§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ¯”å¦‚ STOMPã€MQTT ç­‰ç­‰ã€‚

- 6ã€å¤šè¯­è¨€å®¢æˆ·ç«¯ï¼ˆMany Clientsï¼‰

  > RabbitMQ å‡ ä¹æ”¯æŒæ‰€æœ‰å¸¸ç”¨è¯­è¨€ï¼Œæ¯”å¦‚ Javaã€.NETã€Ruby ç­‰ç­‰ã€‚

- 7ã€ç®¡ç†ç•Œé¢ï¼ˆManagement UIï¼‰

  > RabbitMQ æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ Broker çš„è®¸å¤šæ–¹é¢ã€‚

- 8ã€è·Ÿè¸ªæœºåˆ¶ï¼ˆTracingï¼‰

  > å¦‚æœæ¶ˆæ¯å¼‚å¸¸ï¼ŒRabbitMQ æä¾›äº†æ¶ˆæ¯è·Ÿè¸ªæœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥æ‰¾å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚

- 9ã€æ’ä»¶æœºåˆ¶ï¼ˆPlugin Systemï¼‰

  > RabbitMQ æä¾›äº†è®¸å¤šæ’ä»¶ï¼Œæ¥ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„æ’ä»¶ã€‚

æ›´è¯¦ç»†çš„ï¼Œæ¨èé˜…è¯» [ã€Šæ¶ˆæ¯é˜Ÿåˆ—ä¹‹ RabbitMQã€‹](http://www.iocoder.cn/RabbitMQ/yuliu/doc/?vip) ã€‚å®ƒæä¾›äº†ï¼š

- 1ã€RabbitMQ çš„ä»‹ç»
- 2ã€RabbitMQ çš„æ¦‚å¿µ
- 3ã€RabbitMQ çš„ Server å®‰è£…
- 4ã€RabbitMQ çš„ Java Client ä½¿ç”¨ç¤ºä¾‹
- 5ã€RabbitMQ çš„é›†ç¾¤

## RabbitMQ ä¸­çš„ Broker æ˜¯æŒ‡ä»€ä¹ˆï¼ŸCluster åˆæ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ

- Broker ï¼Œæ˜¯æŒ‡ä¸€ä¸ªæˆ–å¤šä¸ª erlang node çš„é€»è¾‘åˆ†ç»„ï¼Œä¸” node ä¸Šè¿è¡Œç€ RabbitMQ åº”ç”¨ç¨‹åºã€‚
- Cluster ï¼Œæ˜¯åœ¨ Broker çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¢åŠ äº† node ä¹‹é—´å…±äº«å…ƒæ•°æ®çš„çº¦æŸã€‚

ğŸ¦… **vhost æ˜¯ä»€ä¹ˆï¼Ÿèµ·ä»€ä¹ˆä½œç”¨ï¼Ÿ**

vhost å¯ä»¥ç†è§£ä¸ºè™šæ‹Ÿ Broker ï¼Œå³ mini-RabbitMQ server ã€‚å…¶å†…éƒ¨å‡å«æœ‰ç‹¬ç«‹çš„ queueã€exchange å’Œ binding ç­‰ï¼Œä½†æœ€æœ€é‡è¦çš„æ˜¯ï¼Œå…¶æ‹¥æœ‰ç‹¬ç«‹çš„æƒé™ç³»ç»Ÿï¼Œå¯ä»¥åšåˆ° vhost èŒƒå›´çš„ç”¨æˆ·æ§åˆ¶ã€‚å½“ç„¶ï¼Œä» RabbitMQ çš„å…¨å±€è§’åº¦ï¼Œvhost å¯ä»¥ä½œä¸ºä¸åŒæƒé™éš”ç¦»çš„æ‰‹æ®µï¼ˆä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ä¸åŒçš„åº”ç”¨å¯ä»¥è·‘åœ¨ä¸åŒçš„ vhost ä¸­ï¼‰ã€‚

> è¿™ä¸ªï¼Œå’Œ Tomcatã€Nginxã€Apache çš„ vhost æ˜¯ä¸€æ ·çš„æ¦‚å¿µã€‚

## ä»€ä¹ˆæ˜¯å…ƒæ•°æ®ï¼Ÿå…ƒæ•°æ®åˆ†ä¸ºå“ªäº›ç±»å‹ï¼ŸåŒ…æ‹¬å“ªäº›å†…å®¹ï¼Ÿ

åœ¨é Cluster æ¨¡å¼ä¸‹ï¼Œå…ƒæ•°æ®ä¸»è¦åˆ†ä¸ºï¼š

- Queue å…ƒæ•°æ®ï¼ˆqueue åå­—å’Œå±æ€§ç­‰ï¼‰
- Exchange å…ƒæ•°æ®ï¼ˆexchange åå­—ã€ç±»å‹å’Œå±æ€§ç­‰ï¼‰
- Binding å…ƒæ•°æ®ï¼ˆå­˜æ”¾è·¯ç”±å…³ç³»çš„æŸ¥æ‰¾è¡¨ï¼‰
- Vhost å…ƒæ•°æ®ï¼ˆvhost èŒƒå›´å†…é’ˆå¯¹å‰ä¸‰è€…çš„åå­—ç©ºé—´çº¦æŸå’Œå®‰å…¨å±æ€§è®¾ç½®ï¼‰ã€‚

ğŸ¦… **ä¸ Cluster ç›¸å…³çš„å…ƒæ•°æ®æœ‰å“ªäº›ï¼Ÿå…ƒæ•°æ®æ˜¯å¦‚ä½•ä¿å­˜çš„ï¼Ÿå…ƒæ•°æ®åœ¨ Cluster ä¸­æ˜¯å¦‚ä½•åˆ†å¸ƒçš„ï¼Ÿ**

åœ¨ Cluster æ¨¡å¼ä¸‹ï¼Œè¿˜åŒ…æ‹¬ Cluster ä¸­ node ä½ç½®ä¿¡æ¯å’Œ node å…³ç³»ä¿¡æ¯ã€‚

å…ƒæ•°æ®æ ¹æ® erlang node çš„ç±»å‹ç¡®å®šæ˜¯ä»…ä¿å­˜äº RAM ä¸­ï¼Œè¿˜æ˜¯åŒæ—¶ä¿å­˜åœ¨ RAM å’Œ disk ä¸Šã€‚å…ƒæ•°æ®åœ¨ Cluster ä¸­æ˜¯å…¨ node åˆ†å¸ƒçš„ã€‚

ä¸‹å›¾æ‰€ç¤ºä¸º queue çš„å…ƒæ•°æ®åœ¨å• node å’Œ cluster ä¸¤ç§æ¨¡å¼ä¸‹çš„åˆ†å¸ƒå›¾ï¼š

[![åˆ†å¸ƒå›¾](http://static.iocoder.cn/c7566feb7a61cb647296a7224ba7f39d)](http://static.iocoder.cn/c7566feb7a61cb647296a7224ba7f39d)åˆ†å¸ƒå›¾

ğŸ¦… **RAM node å’Œ Disk node çš„åŒºåˆ«ï¼Ÿ**

- RAM node ä»…å°† fabricï¼ˆå³ queueã€exchange å’Œ bindingç­‰ RabbitMQåŸºç¡€æ„ä»¶ï¼‰ç›¸å…³å…ƒæ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œä½† Disk node ä¼šåœ¨å†…å­˜å’Œç£ç›˜ä¸­å‡è¿›è¡Œå­˜å‚¨ã€‚
- RAM node ä¸Šå”¯ä¸€ä¼šå­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„å…ƒæ•°æ®æ˜¯ Cluster ä¸­ä½¿ç”¨çš„ Disk node çš„åœ°å€ã€‚å¹¶ä¸”è¦æ±‚åœ¨ RabbitMQ Cluster ä¸­è‡³å°‘å­˜åœ¨ä¸€ä¸ª Disk node ã€‚

## RabbitMQ æ¦‚å¿µé‡Œçš„ channelã€exchange å’Œ queue æ˜¯ä»€ä¹ˆï¼Ÿ

- queue å…·æœ‰è‡ªå·±çš„ erlang è¿›ç¨‹ï¼›
- exchange å†…éƒ¨å®ç°ä¸ºä¿å­˜ binding å…³ç³»çš„æŸ¥æ‰¾è¡¨ï¼›
- channel æ˜¯å®é™…è¿›è¡Œè·¯ç”±å·¥ä½œçš„å®ä½“ï¼Œå³è´Ÿè´£æŒ‰ç…§ routing_key å°† message æŠ•é€’ç»™ queue ã€‚

ç”± AMQP åè®®æè¿°å¯çŸ¥ï¼Œchannel æ˜¯çœŸå® TCP è¿æ¥ä¹‹ä¸Šçš„è™šæ‹Ÿè¿æ¥ï¼Œæ‰€æœ‰ AMQP å‘½ä»¤éƒ½æ˜¯é€šè¿‡ channel å‘é€çš„ï¼Œä¸”æ¯ä¸€ä¸ª channel æœ‰å”¯ä¸€çš„ ID ã€‚

- ä¸€ä¸ª channel åªèƒ½è¢«å•ç‹¬ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä½¿ç”¨ï¼Œæ•…æŠ•é€’åˆ°ç‰¹å®š channel ä¸Šçš„ message æ˜¯æœ‰é¡ºåºçš„ã€‚ä½†ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šå…è®¸ä½¿ç”¨å¤šä¸ª channel ã€‚

- channel å·ä¸º 0 çš„ channel ç”¨äºå¤„ç†æ‰€æœ‰å¯¹äºå½“å‰ connection å…¨å±€æœ‰æ•ˆçš„å¸§ï¼Œè€Œ 1-65535 å· channel ç”¨äºå¤„ç†å’Œç‰¹å®š channel ç›¸å…³çš„å¸§ã€‚

- AMQP åè®®ç»™å‡ºçš„ channel å¤ç”¨æ¨¡å‹å¦‚ä¸‹ï¼š

  ![channel å¤ç”¨æ¨¡å‹](http://static.iocoder.cn/0cb69bbcda6043bc0c9d7733de251d76)

  channel å¤ç”¨æ¨¡å‹

  - å…¶ä¸­æ¯ä¸€ä¸ª channel è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸Šï¼Œå¤šçº¿ç¨‹å…±äº«åŒä¸€ä¸ª socket ã€‚

ğŸ¦… **æ¶ˆæ¯åŸºäºä»€ä¹ˆä¼ è¾“ï¼Ÿ**

ç”±äº TCP è¿æ¥çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€è¾ƒå¤§ï¼Œä¸”å¹¶å‘æ•°å—ç³»ç»Ÿèµ„æºé™åˆ¶ï¼Œä¼šé€ æˆæ€§èƒ½ç“¶é¢ˆã€‚RabbitMQ ä½¿ç”¨ä¿¡é“çš„æ–¹å¼æ¥ä¼ è¾“æ•°æ®ã€‚ä¿¡é“æ˜¯å»ºç«‹åœ¨çœŸå®çš„ TCP è¿æ¥å†…çš„è™šæ‹Ÿè¿æ¥ï¼Œä¸”æ¯æ¡ TCPè¿æ¥ä¸Šçš„ä¿¡é“æ•°é‡æ²¡æœ‰é™åˆ¶ã€‚

ğŸ¦… **RabbitMQ ä¸Šçš„ä¸€ä¸ª queue ä¸­å­˜æ”¾çš„ message æ˜¯å¦æœ‰æ•°é‡é™åˆ¶ï¼Ÿ**

å¯ä»¥è®¤ä¸ºæ˜¯æ— é™åˆ¶ï¼Œå› ä¸ºé™åˆ¶å–å†³äºæœºå™¨çš„å†…å­˜ï¼Œä½†æ˜¯æ¶ˆæ¯è¿‡å¤šä¼šå¯¼è‡´å¤„ç†æ•ˆç‡çš„ä¸‹é™ã€‚

> ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜ï¼ŒCluster ç›¸å…³ã€‚

ğŸ¦… **åœ¨å• node ç³»ç»Ÿå’Œå¤š node æ„æˆçš„ cluster ç³»ç»Ÿä¸­å£°æ˜ queueã€exchange ï¼Œä»¥åŠè¿›è¡Œ binding ä¼šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ**

- å½“ä½ åœ¨å• node ä¸Šå£°æ˜ queue æ—¶ï¼Œåªè¦è¯¥ node ä¸Šç›¸å…³å…ƒæ•°æ®è¿›è¡Œäº†å˜æ›´ï¼Œä½ å°±ä¼šå¾—åˆ° `Queue.Declare-ok` å›åº”ï¼›è€Œåœ¨ cluster ä¸Šå£°æ˜ queue ï¼Œåˆ™è¦æ±‚ cluster ä¸Šçš„å…¨éƒ¨ node éƒ½è¦è¿›è¡Œå…ƒæ•°æ®æˆåŠŸæ›´æ–°ï¼Œæ‰ä¼šå¾—åˆ° `Queue.Declare-ok` å›åº”ã€‚
- å¦å¤–ï¼Œè‹¥ node ç±»å‹ä¸º RAM node åˆ™å˜æ›´çš„æ•°æ®ä»…ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè‹¥ç±»å‹ä¸º Disk node åˆ™è¿˜è¦å˜æ›´ä¿å­˜åœ¨ç£ç›˜ä¸Šçš„æ•°æ®ã€‚

ğŸ¦… **å®¢æˆ·ç«¯è¿æ¥åˆ° Cluster ä¸­çš„ä»»æ„ node ä¸Šæ˜¯å¦éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ**

æ˜¯çš„ã€‚å®¢æˆ·ç«¯æ„Ÿè§‰ä¸åˆ°æœ‰ä½•ä¸åŒã€‚

ğŸ¦… **è‹¥ Cluster ä¸­æ‹¥æœ‰æŸä¸ª queue çš„ owner node å¤±æ•ˆäº†ï¼Œä¸”è¯¥ queue è¢«å£°æ˜å…·æœ‰ durable å±æ€§ï¼Œæ˜¯å¦èƒ½å¤ŸæˆåŠŸä»å…¶ä»– node ä¸Šé‡æ–°å£°æ˜è¯¥ queue ï¼Ÿ**

- ä¸èƒ½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å¾—åˆ° 404 NOT_FOUND é”™è¯¯ã€‚åªèƒ½ç­‰ queue æ‰€å±çš„ node æ¢å¤åæ‰èƒ½ä½¿ç”¨è¯¥ queue ã€‚
- ä½†è‹¥è¯¥ queue æœ¬èº«ä¸å…·æœ‰ durable å±æ€§ï¼Œåˆ™å¯åœ¨å…¶ä»– node ä¸Šé‡æ–°å£°æ˜ã€‚

ğŸ¦… **Cluster ä¸­ node çš„å¤±æ•ˆä¼šå¯¹ consumer äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿè‹¥æ˜¯åœ¨ cluster ä¸­åˆ›å»ºäº† mirrored queue ï¼Œè¿™æ—¶ node å¤±æ•ˆä¼šå¯¹ consumer äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿ**

- è‹¥æ˜¯ consumer æ‰€è¿æ¥çš„é‚£ä¸ª node å¤±æ•ˆï¼ˆæ— è®ºè¯¥ node æ˜¯å¦ä¸º consumer æ‰€è®¢é˜… queue çš„ owner nodeï¼‰ï¼Œåˆ™ consumer ä¼šåœ¨å‘ç° TCP è¿æ¥æ–­å¼€æ—¶ï¼ŒæŒ‰æ ‡å‡†è¡Œä¸ºæ‰§è¡Œé‡è¿é€»è¾‘ï¼Œå¹¶æ ¹æ® â€œAssume Nothingâ€ åŸåˆ™é‡å»ºç›¸åº”çš„ fabric å³å¯ã€‚
- è‹¥æ˜¯å¤±æ•ˆçš„ node ä¸º consumer è®¢é˜… queue çš„ owner nodeï¼Œåˆ™ consumer åªèƒ½é€šè¿‡ Consumer Cancellation Notification æœºåˆ¶æ¥æ£€æµ‹ä¸è¯¥ queue è®¢é˜…å…³ç³»çš„ç»ˆæ­¢ï¼Œå¦åˆ™ä¼šå‡ºç°å‚»ç­‰å´æ²¡æœ‰ä»»ä½•æ¶ˆæ¯æ¥åˆ°çš„é—®é¢˜ã€‚

ğŸ¦… **Consumer Cancellation Notification æœºåˆ¶ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ**

ç”¨äºä¿è¯å½“é•œåƒ queue ä¸­ master æŒ‚æ‰æ—¶ï¼Œè¿æ¥åˆ° slave ä¸Šçš„ consumer å¯ä»¥æ”¶åˆ°è‡ªèº« consume è¢«å–æ¶ˆçš„é€šçŸ¥ï¼Œè¿›è€Œå¯ä»¥é‡æ–°æ‰§è¡Œ consume åŠ¨ä½œä»æ–°é€‰å‡ºçš„ master å‡ºè·å¾—æ¶ˆæ¯ã€‚

è‹¥ä¸é‡‡ç”¨è¯¥æœºåˆ¶ï¼Œè¿æ¥åˆ° slave ä¸Šçš„ consumer å°†ä¸ä¼šæ„ŸçŸ¥ master æŒ‚æ‰è¿™ä¸ªäº‹æƒ…ï¼Œå¯¼è‡´åç»­æ— æ³•å†æ”¶åˆ°æ–° master å¹¿æ’­å‡ºæ¥çš„ message ã€‚

å¦å¤–ï¼Œå› ä¸ºåœ¨é•œåƒ queue æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨å°† message è¿›è¡Œ requeue çš„å¯èƒ½ï¼Œæ‰€ä»¥å®ç° consumer çš„é€»è¾‘æ—¶éœ€è¦èƒ½å¤Ÿæ­£ç¡®å¤„ç†å‡ºç°é‡å¤ message çš„æƒ…å†µã€‚

ğŸ¦… **èƒ½å¤Ÿåœ¨åœ°ç†ä¸Šåˆ†å¼€çš„ä¸åŒæ•°æ®ä¸­å¿ƒä½¿ç”¨ RabbitMQ cluster ä¹ˆï¼Ÿ**

ä¸èƒ½ã€‚

- ç¬¬ä¸€ï¼Œä½ æ— æ³•æ§åˆ¶æ‰€åˆ›å»ºçš„ queue å®é™…åˆ†å¸ƒåœ¨ cluster é‡Œçš„å“ªä¸ª node ä¸Šï¼ˆä¸€èˆ¬ä½¿ç”¨ HAProxy + cluster æ¨¡å‹æ—¶éƒ½æ˜¯è¿™æ ·ï¼‰ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å„ç§è·¨åœ°åŸŸè®¿é—®æ—¶çš„å¸¸è§é—®é¢˜ã€‚
- ç¬¬äºŒï¼ŒErlang çš„ OTP é€šä¿¡æ¡†æ¶å¯¹å»¶è¿Ÿçš„å®¹å¿åº¦æœ‰é™ï¼Œè¿™å¯èƒ½ä¼šè§¦å‘å„ç§è¶…æ—¶ï¼Œå¯¼è‡´ä¸šåŠ¡ç–²äºå¤„ç†ã€‚
- ç¬¬ä¸‰ï¼Œåœ¨å¹¿åŸŸç½‘ä¸Šçš„è¿æ¥å¤±æ•ˆé—®é¢˜å°†å¯¼è‡´ç»å…¸çš„â€œè„‘è£‚â€é—®é¢˜ï¼Œè€Œ RabbitMQ ç›®å‰æ— æ³•å¤„ç†ã€‚ï¼ˆè¯¥é—®é¢˜ä¸»è¦æ˜¯è¯´ Mnesiaï¼‰

## å¦‚ä½•ç¡®ä¿æ¶ˆæ¯æ­£ç¡®åœ°å‘é€è‡³ RabbitMQï¼Ÿ

RabbitMQ ä½¿ç”¨**å‘é€æ–¹ç¡®è®¤æ¨¡å¼**ï¼Œç¡®ä¿æ¶ˆæ¯æ­£ç¡®åœ°å‘é€åˆ° RabbitMQã€‚

- å‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼šå°†ä¿¡é“è®¾ç½®æˆ confirm æ¨¡å¼ï¼ˆå‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼‰ï¼Œåˆ™æ‰€æœ‰åœ¨ä¿¡é“ä¸Šå‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„ ID ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°ç›®çš„é˜Ÿåˆ—åï¼Œæˆ–è€…æ¶ˆæ¯è¢«å†™å…¥ç£ç›˜åï¼ˆå¯æŒä¹…åŒ–çš„æ¶ˆæ¯ï¼‰ï¼Œä¿¡é“ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯å”¯ä¸€IDï¼‰ã€‚å¦‚æœ RabbitMQ å‘ç”Ÿå†…éƒ¨é”™è¯¯ä»è€Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œä¼šå‘é€ä¸€æ¡ nackï¼ˆnot acknowledgedï¼Œæœªç¡®è®¤ï¼‰æ¶ˆæ¯ã€‚
- å‘é€æ–¹ç¡®è®¤æ¨¡å¼æ˜¯å¼‚æ­¥çš„ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåœ¨ç­‰å¾…ç¡®è®¤çš„åŒæ—¶ï¼Œå¯ä»¥ç»§ç»­å‘é€æ¶ˆæ¯ã€‚å½“ç¡®è®¤æ¶ˆæ¯åˆ°è¾¾ç”Ÿäº§è€…åº”ç”¨ç¨‹åºï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºçš„å›è°ƒæ–¹æ³•å°±ä¼šè¢«è§¦å‘æ¥å¤„ç†ç¡®è®¤æ¶ˆæ¯ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ14. ç”Ÿäº§è€…çš„å‘é€ç¡®è®¤ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

ğŸ¦… **å‘ä¸å­˜åœ¨çš„ exchange å‘ publish æ¶ˆæ¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå‘ä¸å­˜åœ¨çš„ queue æ‰§è¡Œ consume åŠ¨ä½œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**

éƒ½ä¼šæ”¶åˆ° `Channel.Close` ä¿¡ä»¤å‘Šä¹‹ä¸å­˜åœ¨ï¼ˆå†…å«åŸå›  404 NOT_FOUNDï¼‰ã€‚

ğŸ¦… **ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç° blackholed é—®é¢˜ï¼Ÿ**

> blackholed ï¼Œå¯¹åº”ä¸­æ–‡ä¸ºâ€œé»‘æ´â€ã€‚

blackholed é—®é¢˜æ˜¯æŒ‡ï¼Œå‘ exchange æŠ•é€’äº† message ï¼Œè€Œç”±äºå„ç§åŸå› å¯¼è‡´è¯¥ message ä¸¢å¤±ï¼Œä½†å‘é€è€…å´ä¸çŸ¥é“ã€‚å¯å¯¼è‡´ blackholed çš„æƒ…å†µï¼š

- 1ã€å‘æœªç»‘å®š queue çš„ exchange å‘é€ message ã€‚
- 2ã€exchange ä»¥ binding_key key_A ç»‘å®šäº† queue queue_Aï¼Œä½†å‘è¯¥ exchange å‘é€ message ä½¿ç”¨çš„ routing_key å´æ˜¯ key_B ã€‚

ğŸ¦… **å¦‚ä½•é˜²æ­¢å‡ºç° blackholed é—®é¢˜ï¼Ÿ**

æ²¡æœ‰ç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œåªèƒ½åœ¨å…·ä½“å®è·µä¸­é€šè¿‡å„ç§æ–¹å¼ä¿è¯ç›¸å…³ fabric çš„å­˜åœ¨ã€‚å¦å¤–ï¼Œå¦‚æœåœ¨æ‰§è¡Œ `Basic.Publish` æ—¶è®¾ç½® `mandatory=true` ï¼Œåˆ™åœ¨é‡åˆ°å¯èƒ½å‡ºç° blackholed æƒ…å†µæ—¶ï¼ŒæœåŠ¡å™¨ä¼šé€šè¿‡è¿”å› `Basic.Return` å‘Šä¹‹å½“å‰ message æ— æ³•è¢«æ­£ç¡®æŠ•é€’ï¼ˆå†…å«åŸå›  312 NO_ROUTEï¼‰ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ14.3 ReturnCallbackã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

ğŸ¦… **routing_key å’Œ binding_key çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ**

255 å­—èŠ‚ã€‚

ğŸ¦… **æ¶ˆæ¯æ€ä¹ˆè·¯ç”±ï¼Ÿ**

ä»æ¦‚å¿µä¸Šæ¥è¯´ï¼Œæ¶ˆæ¯è·¯ç”±å¿…é¡»æœ‰ä¸‰éƒ¨åˆ†ï¼šäº¤æ¢å™¨ã€è·¯ç”±ã€ç»‘å®šã€‚

- ç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘å¸ƒåˆ°**äº¤æ¢å™¨**ä¸Šï¼›

- **ç»‘å®š**å†³å®šäº†æ¶ˆæ¯å¦‚ä½•ä»è·¯ç”±å™¨è·¯ç”±åˆ°ç‰¹å®šçš„é˜Ÿåˆ—ï¼›

  > å¦‚æœä¸€ä¸ªè·¯ç”±ç»‘å®šäº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆå‘é€ç»™è¯¥è·¯ç”±æ—¶ï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—éƒ½ä¼šå¢åŠ ä¸€æ¡æ¶ˆæ¯ã€‚

- æ¶ˆæ¯æœ€ç»ˆåˆ°è¾¾**é˜Ÿåˆ—**ï¼Œå¹¶è¢«æ¶ˆè´¹è€…æ¥æ”¶ã€‚

è¯¦ç»†æ¥è¯´ï¼Œå°±æ˜¯ï¼š

- æ¶ˆæ¯å‘å¸ƒåˆ°äº¤æ¢å™¨æ—¶ï¼Œæ¶ˆæ¯å°†æ‹¥æœ‰ä¸€ä¸ªè·¯ç”±é”®ï¼ˆrouting keyï¼‰ï¼Œåœ¨æ¶ˆæ¯åˆ›å»ºæ—¶è®¾å®šã€‚
- é€šè¿‡é˜Ÿåˆ—è·¯ç”±é”®ï¼Œå¯ä»¥æŠŠé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šã€‚
- æ¶ˆæ¯åˆ°è¾¾äº¤æ¢å™¨åï¼ŒRabbitMQ ä¼šå°†æ¶ˆæ¯çš„è·¯ç”±é”®ä¸é˜Ÿåˆ—çš„è·¯ç”±é”®è¿›è¡ŒåŒ¹é…ï¼ˆé’ˆå¯¹ä¸åŒçš„äº¤æ¢å™¨æœ‰ä¸åŒçš„è·¯ç”±è§„åˆ™ï¼‰ã€‚å¦‚æœèƒ½å¤ŸåŒ¹é…åˆ°é˜Ÿåˆ—ï¼Œåˆ™æ¶ˆæ¯ä¼šæŠ•é€’åˆ°ç›¸åº”é˜Ÿåˆ—ä¸­ï¼›å¦‚æœä¸èƒ½åŒ¹é…åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œæ¶ˆæ¯å°†è¿›å…¥ â€œé»‘æ´â€ã€‚

å¸¸ç”¨çš„äº¤æ¢å™¨ä¸»è¦åˆ†ä¸ºä¸€ä¸‹ä¸‰ç§ï¼š

- directï¼šå¦‚æœè·¯ç”±é”®å®Œå…¨åŒ¹é…ï¼Œæ¶ˆæ¯å°±è¢«æŠ•é€’åˆ°ç›¸åº”çš„é˜Ÿåˆ—ã€‚
- fanoutï¼šå¦‚æœäº¤æ¢å™¨æ”¶åˆ°æ¶ˆæ¯ï¼Œå°†ä¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸Šã€‚
- topicï¼šå¯ä»¥ä½¿æ¥è‡ªä¸åŒæºå¤´çš„æ¶ˆæ¯èƒ½å¤Ÿåˆ°è¾¾åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚ ä½¿ç”¨ topic äº¤æ¢å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œæ¯”å¦‚ï¼š`â€œ*â€` åŒ¹é…ç‰¹å®šä½ç½®çš„ä»»æ„æ–‡æœ¬ï¼Œ `â€œ.â€` æŠŠè·¯ç”±é”®åˆ†ä¸ºäº†å‡ éƒ¨åˆ†ï¼Œ`â€œ#â€` åŒ¹é…æ‰€æœ‰è§„åˆ™ç­‰ã€‚ç‰¹åˆ«æ³¨æ„ï¼šå‘å¾€ topic äº¤æ¢å™¨çš„æ¶ˆæ¯ä¸èƒ½éšæ„çš„è®¾ç½®é€‰æ‹©é”®ï¼ˆrouting_keyï¼‰ï¼Œå¿…é¡»æ˜¯ç”± `"."` éš”å¼€çš„ä¸€ç³»åˆ—çš„æ ‡è¯†ç¬¦ç»„æˆã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ3. å¿«é€Ÿå…¥é—¨ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

## å¦‚ä½•ç¡®ä¿æ¶ˆæ¯æ¥æ”¶æ–¹æ¶ˆè´¹äº†æ¶ˆæ¯ï¼Ÿ

RabbitMQ ä½¿ç”¨**æ¥æ”¶æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶**ï¼Œç¡®ä¿æ¶ˆæ¯æ¥æ”¶æ–¹æ¶ˆè´¹äº†æ¶ˆæ¯ã€‚

- æ¥æ”¶æ–¹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼šæ¶ˆè´¹è€…æ¥æ”¶æ¯ä¸€æ¡æ¶ˆæ¯åéƒ½å¿…é¡»è¿›è¡Œç¡®è®¤ï¼ˆæ¶ˆæ¯æ¥æ”¶å’Œæ¶ˆæ¯ç¡®è®¤æ˜¯ä¸¤ä¸ªä¸åŒæ“ä½œï¼‰ã€‚åªæœ‰æ¶ˆè´¹è€…ç¡®è®¤äº†æ¶ˆæ¯ï¼ŒRabbitMQ æ‰èƒ½å®‰å…¨åœ°æŠŠæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚

è¿™é‡Œå¹¶æ²¡æœ‰ç”¨åˆ°è¶…æ—¶æœºåˆ¶ï¼ŒRabbitMQ ä»…é€šè¿‡ Consumer çš„è¿æ¥ä¸­æ–­æ¥ç¡®è®¤æ˜¯å¦éœ€è¦é‡æ–°å‘é€æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦è¿æ¥ä¸ä¸­æ–­ï¼ŒRabbitMQ ç»™äº† Consumer è¶³å¤Ÿé•¿çš„æ—¶é—´æ¥å¤„ç†æ¶ˆæ¯ã€‚

ä¸‹é¢ç½—åˆ—å‡ ç§ç‰¹æ®Šæƒ…å†µï¼š

- å¦‚æœæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œåœ¨ç¡®è®¤ä¹‹å‰æ–­å¼€äº†è¿æ¥æˆ–å–æ¶ˆè®¢é˜…ï¼ŒRabbitMQ ä¼šè®¤ä¸ºæ¶ˆæ¯æ²¡æœ‰è¢«åˆ†å‘ï¼Œç„¶åé‡æ–°åˆ†å‘ç»™ä¸‹ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ã€‚ï¼ˆå¯èƒ½å­˜åœ¨æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„éšæ‚£ï¼Œéœ€è¦æ ¹æ® bizId å»é‡ï¼‰
- å¦‚æœæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯å´æ²¡æœ‰ç¡®è®¤æ¶ˆæ¯ï¼Œè¿æ¥ä¹Ÿæœªæ–­å¼€ï¼Œåˆ™ RabbitMQ è®¤ä¸ºè¯¥æ¶ˆè´¹è€…ç¹å¿™ï¼Œå°†ä¸ä¼šç»™è¯¥æ¶ˆè´¹è€…åˆ†å‘æ›´å¤šçš„æ¶ˆæ¯ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ13. æ¶ˆè´¹è€…çš„æ¶ˆæ¯ç¡®è®¤ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

ğŸ¦… **å¦‚ä½•é¿å…æ¶ˆæ¯é‡å¤æŠ•é€’æˆ–é‡å¤æ¶ˆè´¹ï¼Ÿ**

åœ¨æ¶ˆæ¯ç”Ÿäº§æ—¶ï¼ŒMQ å†…éƒ¨é’ˆå¯¹æ¯æ¡ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ª inner-msg-id ï¼Œä½œä¸ºå»é‡å’Œå¹‚ç­‰çš„ä¾æ®ï¼ˆæ¶ˆæ¯æŠ•é€’å¤±è´¥å¹¶é‡ä¼ ï¼‰ï¼Œé¿å…é‡å¤çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—

åœ¨æ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼Œè¦æ±‚æ¶ˆæ¯ä½“ä¸­å¿…é¡»è¦æœ‰ä¸€ä¸ª bizIdï¼ˆå¯¹äºåŒä¸€ä¸šåŠ¡å…¨å±€å”¯ä¸€ï¼Œå¦‚æ”¯ä»˜ IDã€è®¢å• IDã€å¸–å­ ID ç­‰ï¼‰ä½œä¸ºå»é‡å’Œå¹‚ç­‰çš„ä¾æ®ï¼Œé¿å…åŒä¸€æ¡æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹ã€‚

ğŸ¦… **æ¶ˆæ¯å¦‚ä½•åˆ†å‘ï¼Ÿ**

è‹¥è¯¥é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è®¢é˜…ï¼Œæ¶ˆæ¯å°†ä»¥å¾ªç¯ï¼ˆround-robinï¼‰çš„æ–¹å¼å‘é€ç»™æ¶ˆè´¹è€…ã€‚æ¯æ¡æ¶ˆæ¯åªä¼šåˆ†å‘ç»™ä¸€ä¸ªè®¢é˜…çš„æ¶ˆè´¹è€…ï¼ˆå‰ææ˜¯æ¶ˆè´¹è€…èƒ½å¤Ÿæ­£å¸¸å¤„ç†æ¶ˆæ¯å¹¶è¿›è¡Œç¡®è®¤ï¼‰ã€‚

ğŸ¦… **RabbitMQ æœ‰å‡ ç§æ¶ˆè´¹æ¨¡å¼ï¼Ÿ**

RabbitMQ æœ‰ pull å’Œ push ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ã€‚å…·ä½“çš„ä½¿ç”¨ï¼Œå¯å‚è§ [ã€ŠRabbitMQ ä¹‹ Consumer æ¶ˆè´¹æ¨¡å¼ï¼ˆPush & Pullï¼‰ã€‹](https://blog.csdn.net/u013256816/article/details/62890189) æ–‡ç« ã€‚

## ä¸ºä»€ä¹ˆä¸åº”è¯¥å¯¹æ‰€æœ‰çš„ message éƒ½ä½¿ç”¨æŒä¹…åŒ–æœºåˆ¶ï¼Ÿ

é¦–å…ˆï¼Œå¿…ç„¶å¯¼è‡´æ€§èƒ½çš„ä¸‹é™ï¼Œå› ä¸ºå†™ç£ç›˜æ¯”å†™ RAM æ…¢çš„å¤šï¼Œmessage çš„ååé‡å¯èƒ½æœ‰ 10 å€çš„å·®è·ã€‚

å…¶æ¬¡ï¼Œmessage çš„æŒä¹…åŒ–æœºåˆ¶ç”¨åœ¨ RabbitMQ çš„å†…ç½® Cluster æ–¹æ¡ˆæ—¶ä¼šå‡ºç°â€œå‘çˆ¹â€é—®é¢˜ã€‚çŸ›ç›¾ç‚¹åœ¨äºï¼š

- è‹¥ message è®¾ç½®äº† persistent å±æ€§ï¼Œä½† queue æœªè®¾ç½® durable å±æ€§ï¼Œé‚£ä¹ˆå½“è¯¥ queue çš„ owner node å‡ºç°å¼‚å¸¸åï¼Œåœ¨æœªé‡å»ºè¯¥ queue å‰ï¼Œå‘å¾€è¯¥ queue çš„ message å°†è¢« blackholed ã€‚
- è‹¥ message è®¾ç½®äº† persistent å±æ€§ï¼ŒåŒæ—¶ queue ä¹Ÿè®¾ç½®äº† durable å±æ€§ï¼Œé‚£ä¹ˆå½“ queue çš„ owner node å¼‚å¸¸ä¸”æ— æ³•é‡å¯çš„æƒ…å†µä¸‹ï¼Œåˆ™è¯¥ queue æ— æ³•åœ¨å…¶ä»– node ä¸Šé‡å»ºï¼Œåªèƒ½ç­‰å¾…å…¶ owner node é‡å¯åï¼Œæ‰èƒ½æ¢å¤è¯¥ queue çš„ä½¿ç”¨ï¼Œè€Œåœ¨è¿™æ®µæ—¶é—´å†…å‘é€ç»™è¯¥ queue çš„ message å°†è¢« blackholed ã€‚

æ‰€ä»¥ï¼Œæ˜¯å¦è¦å¯¹ message è¿›è¡ŒæŒä¹…åŒ–ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘æ€§èƒ½éœ€è¦ï¼Œä»¥åŠå¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚è‹¥æƒ³è¾¾åˆ° 100,000 æ¡/ç§’ä»¥ä¸Šçš„æ¶ˆæ¯ååé‡ï¼ˆå• RabbitMQ æœåŠ¡å™¨ï¼‰ï¼Œåˆ™è¦ä¹ˆä½¿ç”¨å…¶ä»–çš„æ–¹å¼æ¥ç¡®ä¿ message çš„å¯é  delivery ï¼Œè¦ä¹ˆä½¿ç”¨éå¸¸å¿«é€Ÿçš„å­˜å‚¨ç³»ç»Ÿä»¥æ”¯æŒå…¨æŒä¹…åŒ–ï¼ˆä¾‹å¦‚ä½¿ç”¨ SSDï¼‰ã€‚å¦å¤–ä¸€ç§å¤„ç†åŸåˆ™æ˜¯ï¼šä»…å¯¹å…³é”®æ¶ˆæ¯ä½œæŒä¹…åŒ–å¤„ç†ï¼ˆæ ¹æ®ä¸šåŠ¡é‡è¦ç¨‹åº¦ï¼‰ï¼Œä¸”åº”è¯¥ä¿è¯å…³é”®æ¶ˆæ¯çš„é‡ä¸ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚

ğŸ¦… **RabbitMQ å…è®¸å‘é€çš„ message æœ€å¤§å¯è¾¾å¤šå¤§ï¼Ÿ**

æ ¹æ® AMQP åè®®è§„å®šï¼Œæ¶ˆæ¯ä½“çš„å¤§å°ç”± 64-bit çš„å€¼æ¥æŒ‡å®šï¼Œæ‰€ä»¥ä½ å°±å¯ä»¥çŸ¥é“åˆ°åº•èƒ½å‘å¤šå¤§çš„æ•°æ®äº†ã€‚

ğŸ¦… **ä¸ºä»€ä¹ˆè¯´ä¿è¯ message è¢«å¯é æŒä¹…åŒ–çš„æ¡ä»¶æ˜¯ queue å’Œ exchange å…·æœ‰ durable å±æ€§ï¼ŒåŒæ—¶ message å…·æœ‰ persistent å±æ€§æ‰è¡Œï¼Ÿ**

binding å…³ç³»å¯ä»¥è¡¨ç¤ºä¸º exchangeâ€“bindingâ€“queue ã€‚ä»æ–‡æ¡£ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œè‹¥è¦æ±‚æŠ•é€’çš„ message èƒ½å¤Ÿä¸ä¸¢å¤±ï¼Œè¦æ±‚ message æœ¬èº«è®¾ç½® persistent å±æ€§ï¼ŒåŒæ—¶è¦æ±‚ exchange å’Œ queue éƒ½è®¾ç½® durable å±æ€§ã€‚

- å…¶å®è¿™é—®é¢˜å¯ä»¥è¿™ä¹ˆæƒ³ï¼Œè‹¥ exchange æˆ– queue æœªè®¾ç½® durable å±æ€§ï¼Œåˆ™åœ¨å…¶ crash ä¹‹åå°±ä¼šæ— æ³•æ¢å¤ï¼Œé‚£ä¹ˆå³ä½¿ message è®¾ç½®äº† persistent å±æ€§ï¼Œä»ç„¶å­˜åœ¨ message è™½ç„¶èƒ½æ¢å¤ä½†å´æ— å¤„å®¹èº«çš„é—®é¢˜ã€‚
- åŒç†ï¼Œè‹¥ message æœ¬èº«æœªè®¾ç½® persistent å±æ€§ï¼Œåˆ™ message çš„æŒä¹…åŒ–æ›´æ— ä»è°ˆèµ·ã€‚

ğŸ¦… **å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ**

æ¶ˆæ¯æŒä¹…åŒ–çš„å‰ææ˜¯ï¼šå°†äº¤æ¢å™¨/é˜Ÿåˆ—çš„ durable å±æ€§è®¾ç½®ä¸º true ï¼Œè¡¨ç¤ºäº¤æ¢å™¨/é˜Ÿåˆ—æ˜¯æŒä¹…äº¤æ¢å™¨/é˜Ÿåˆ—ï¼Œåœ¨æœåŠ¡å™¨å´©æºƒæˆ–é‡å¯ä¹‹åä¸éœ€è¦é‡æ–°åˆ›å»ºäº¤æ¢å™¨/é˜Ÿåˆ—ï¼ˆäº¤æ¢å™¨/é˜Ÿåˆ—ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ã€‚

å¦‚æœæ¶ˆæ¯æƒ³è¦ä» RabbitMQ å´©æºƒä¸­æ¢å¤ï¼Œé‚£ä¹ˆæ¶ˆæ¯å¿…é¡»ï¼š

- åœ¨æ¶ˆæ¯å‘å¸ƒå‰ï¼Œé€šè¿‡æŠŠå®ƒçš„ â€œæŠ•é€’æ¨¡å¼â€ é€‰é¡¹è®¾ç½®ä¸º2ï¼ˆæŒä¹…ï¼‰æ¥æŠŠæ¶ˆæ¯æ ‡è®°æˆæŒä¹…åŒ–
- å°†æ¶ˆæ¯å‘é€åˆ°æŒä¹…äº¤æ¢å™¨
- æ¶ˆæ¯åˆ°è¾¾æŒä¹…é˜Ÿåˆ—

RabbitMQ ç¡®ä¿æŒä¹…æ€§æ¶ˆæ¯èƒ½ä»æœåŠ¡å™¨é‡å¯ä¸­æ¢å¤çš„æ–¹å¼æ˜¯ï¼Œå°†å®ƒä»¬å†™å…¥ç£ç›˜ä¸Šçš„ä¸€ä¸ªæŒä¹…åŒ–æ—¥å¿—æ–‡ä»¶ã€‚

- å½“å‘å¸ƒä¸€æ¡æŒä¹…æ€§æ¶ˆæ¯åˆ°æŒä¹…äº¤æ¢å™¨ä¸Šæ—¶ï¼ŒRabbitMQ ä¼šåœ¨æ¶ˆæ¯æäº¤åˆ°æ—¥å¿—æ–‡ä»¶åæ‰å‘é€å“åº”ï¼ˆå¦‚æœæ¶ˆæ¯è·¯ç”±åˆ°äº†éæŒä¹…é˜Ÿåˆ—ï¼Œå®ƒä¼šè‡ªåŠ¨ä»æŒä¹…åŒ–æ—¥å¿—ä¸­ç§»é™¤ï¼‰ã€‚
- ä¸€æ—¦æ¶ˆè´¹è€…ä»æŒä¹…é˜Ÿåˆ—ä¸­æ¶ˆè´¹äº†ä¸€æ¡æŒä¹…åŒ–æ¶ˆæ¯ï¼ŒRabbitMQ ä¼šåœ¨æŒä¹…åŒ–æ—¥å¿—ä¸­æŠŠè¿™æ¡æ¶ˆæ¯æ ‡è®°ä¸ºç­‰å¾…åƒåœ¾æ”¶é›†ã€‚å¦‚æœæŒä¹…åŒ–æ¶ˆæ¯åœ¨è¢«æ¶ˆè´¹ä¹‹å‰ RabbitMQ é‡å¯ï¼Œé‚£ä¹ˆ RabbitMQ ä¼šè‡ªåŠ¨é‡å»ºäº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼ˆä»¥åŠç»‘å®šï¼‰ï¼Œå¹¶é‡æ’­æŒä¹…åŒ–æ—¥å¿—æ–‡ä»¶ä¸­çš„æ¶ˆæ¯åˆ°åˆé€‚çš„é˜Ÿåˆ—æˆ–è€…äº¤æ¢å™¨ä¸Šã€‚

## ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ

DLXï¼ŒDead-Letter-Exchangeã€‚åˆ©ç”¨ DLX ï¼Œå½“æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡ï¼ˆdead messageï¼‰ä¹‹åï¼Œå®ƒèƒ½è¢«é‡æ–° publish åˆ°å¦ä¸€ä¸ª Exchange ï¼Œè¿™ä¸ª Exchange å°±æ˜¯DLXã€‚æ¶ˆæ¯å˜æˆæ­»ä¿¡ä¸€å‘æœ‰ä¸€ä¸‹å‡ ç§æƒ…å†µï¼š

- æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆbasic.reject / basic.nackï¼‰å¹¶ä¸” `requeue=false` ã€‚
- æ¶ˆæ¯ TTL è¿‡æœŸï¼ˆå‚è€ƒï¼šRabbitMQä¹‹TTLï¼ˆTime-To-Live è¿‡æœŸæ—¶é—´ï¼‰ï¼‰ã€‚
- é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ã€‚

è¯¦ç»†çš„ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠRabbitMQ ä¹‹æ­»ä¿¡é˜Ÿåˆ—ã€‹](http://www.iocoder.cn/RabbitMQ/dead-letter-queue/?vip) æ–‡ç« ã€‚

ğŸ¦… **â€œdead letterâ€queue çš„ç”¨é€”ï¼Ÿ**

å½“æ¶ˆæ¯è¢« RabbitMQ server æŠ•é€’åˆ° consumer åï¼Œä½† consumer å´é€šè¿‡ `Basic.Reject` è¿›è¡Œäº†æ‹’ç»æ—¶ï¼ˆåŒæ—¶è®¾ç½® `requeue=false`ï¼‰ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯ä¼šè¢«æ”¾å…¥ â€œdead letterâ€ queue ä¸­ã€‚è¯¥ queue å¯ç”¨äºæ’æŸ¥ message è¢« reject æˆ– undeliver çš„åŸå› ã€‚

ğŸ¦… **`Basic.Reject` çš„ç”¨æ³•æ˜¯ä»€ä¹ˆï¼Ÿ**

è¯¥ä¿¡ä»¤å¯ç”¨äº consumer å¯¹æ”¶åˆ°çš„ message è¿›è¡Œ reject ã€‚

- è‹¥åœ¨è¯¥ä¿¡ä»¤ä¸­è®¾ç½® `requeue=true` ï¼Œåˆ™å½“ RabbitMQ server æ”¶åˆ°è¯¥æ‹’ç»ä¿¡ä»¤åï¼Œä¼šå°†è¯¥ message é‡æ–°å‘é€åˆ°ä¸‹ä¸€ä¸ªå¤„äº consume çŠ¶æ€çš„ consumer å¤„ï¼ˆç†è®ºä¸Šä»å¯èƒ½å°†è¯¥æ¶ˆæ¯å‘é€ç»™å½“å‰ consumerï¼‰ã€‚
- è‹¥è®¾ç½® `requeue=false` ï¼Œåˆ™ RabbitMQ server åœ¨æ”¶åˆ°æ‹’ç»ä¿¡ä»¤åï¼Œå°†ç›´æ¥å°†è¯¥ message ä» queue ä¸­ç§»é™¤ã€‚

å¦å¤–ä¸€ç§ç§»é™¤ queue ä¸­ message çš„å°æŠ€å·§æ˜¯ï¼Œconsumer å›å¤ `Basic.Ack` ä½†ä¸å¯¹è·å–åˆ°çš„ message åšä»»ä½•å¤„ç†ã€‚è€Œ `Basic.Nack`æ˜¯å¯¹ Basic.Reject çš„æ‰©å±•ï¼Œä»¥æ”¯æŒä¸€æ¬¡æ‹’ç»å¤šæ¡ message çš„èƒ½åŠ›ã€‚

## RabbitMQ ä¸­çš„ clusterã€mirrored queueï¼Œä»¥åŠ warrens æœºåˆ¶åˆ†åˆ«ç”¨äºè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ğŸ¦… **1ï¼‰cluster**

- cluster æ˜¯ä¸ºäº†è§£å†³å½“ cluster ä¸­çš„ä»»æ„ node å¤±æ•ˆåï¼Œproducer å’Œ consumer å‡å¯ä»¥é€šè¿‡å…¶ä»– node ç»§ç»­å·¥ä½œï¼Œå³æé«˜äº†å¯ç”¨æ€§ï¼›å¦å¤–å¯ä»¥é€šè¿‡å¢åŠ  node æ•°é‡å¢åŠ  cluster çš„æ¶ˆæ¯ååé‡çš„ç›®çš„ã€‚
- cluster æœ¬èº«ä¸è´Ÿè´£ message çš„å¯é æ€§é—®é¢˜ï¼ˆè¯¥é—®é¢˜ç”± producer é€šè¿‡å„ç§æœºåˆ¶è‡ªè¡Œè§£å†³ï¼‰ï¼›cluster æ— æ³•è§£å†³è·¨æ•°æ®ä¸­å¿ƒçš„é—®é¢˜ï¼ˆå³è„‘è£‚é—®é¢˜ï¼‰ã€‚
- å¦å¤–ï¼Œåœ¨cluster å‰ä½¿ç”¨ HAProxy å¯ä»¥è§£å†³ node çš„é€‰æ‹©é—®é¢˜ï¼Œå³ä¸šåŠ¡æ— éœ€çŸ¥é“ cluster ä¸­å¤šä¸ª node çš„ ip åœ°å€ã€‚å¯ä»¥åˆ©ç”¨ HAProxy è¿›è¡Œå¤±æ•ˆ node çš„æ¢æµ‹ï¼Œå¯ä»¥ä½œè´Ÿè½½å‡è¡¡ã€‚ä¸‹å›¾ä¸º HAProxy + cluster çš„æ¨¡å‹ï¼š[HAProxy + cluster çš„æ¨¡å‹](https://img-blog.csdnimg.cn/20181219191433895)

ğŸ¦… **2ï¼‰Mirrored queue**

- Mirrored queue æ˜¯ä¸ºäº†è§£å†³ä½¿ç”¨ cluster æ—¶æ‰€åˆ›å»ºçš„ queue çš„å®Œæ•´ä¿¡æ¯ä»…å­˜åœ¨äºå•ä¸€ node ä¸Šçš„é—®é¢˜ï¼Œä»å¦ä¸€ä¸ªè§’åº¦å¢åŠ å¯ç”¨æ€§ã€‚
- è‹¥æƒ³æ­£ç¡®ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œéœ€è¦ä¿è¯ï¼š1ï¼‰consumer éœ€è¦æ”¯æŒ Consumer Cancellation Notification æœºåˆ¶ï¼›2ï¼‰consumer å¿…é¡»èƒ½å¤Ÿæ­£ç¡®å¤„ç†é‡å¤ message ã€‚

ğŸ¦… **3ï¼‰Warrens**

Warrens æ˜¯ä¸ºäº†è§£å†³ cluster ä¸­ message å¯èƒ½è¢« blackholed çš„é—®é¢˜ï¼Œå³ä¸èƒ½æ¥å— producer ä¸åœ republish message ä½† RabbitMQ server æ— å›åº”çš„æƒ…å†µã€‚

Warrens æœ‰ä¸¤ç§æ„æˆæ–¹å¼ï¼š

- ä¸€ç§æ¨¡å‹ï¼Œæ˜¯ä¸¤å°ç‹¬ç«‹çš„ RabbitMQ server + HAProxy ï¼Œå…¶ä¸­ä¸¤ä¸ª server çš„çŠ¶æ€åˆ†åˆ«ä¸º active å’Œ hot-standby ã€‚è¯¥æ¨¡å‹çš„ç‰¹ç‚¹ä¸ºï¼šä¸¤å° server ä¹‹é—´æ— ä»»ä½•æ•°æ®å…±äº«å’Œåè®®äº¤äº’ï¼Œä¸¤å° server å¯ä»¥åŸºäºä¸åŒçš„ RabbitMQ ç‰ˆæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[æ¨¡å‹ä¸€](https://img-blog.csdnimg.cn/20181219191433914)
- å¦ä¸€ç§æ¨¡å‹ï¼Œä¸ºä¸¤å°å…±äº«å­˜å‚¨çš„ RabbitMQ server + keepalived ï¼Œå…¶ä¸­ä¸¤ä¸ª server çš„çŠ¶æ€åˆ†åˆ«ä¸º active å’Œ cold-standby ã€‚è¯¥æ¨¡å‹çš„ç‰¹ç‚¹ä¸ºï¼šä¸¤å° server åŸºäºå…±äº«å­˜å‚¨å¯ä»¥åšåˆ°å®Œå…¨æ¢å¤ï¼Œè¦æ±‚å¿…é¡»åŸºäºå®Œå…¨ç›¸åŒçš„ RabbitMQ ç‰ˆæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[æ¨¡å‹äºŒ](https://img-blog.csdnimg.cn/20181219191433931)

Warrens æ¨¡å‹å­˜åœ¨çš„é—®é¢˜ï¼š

- å¯¹äºç¬¬ä¸€ç§æ¨¡å‹ï¼Œè™½ç„¶ç†è®ºä¸Šè®²ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ï¼Œä½†è‹¥åœ¨è¯¥æ¨¡å‹ä¸Šä½¿ç”¨æŒä¹…åŒ–æœºåˆ¶ï¼Œå°±ä¼šå‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå³è‹¥ä½œä¸º active çš„ server å¼‚å¸¸åï¼ŒæŒä¹…åŒ–åœ¨è¯¥ server ä¸Šçš„æ¶ˆæ¯å°†æš‚æ—¶æ— æ³•è¢« consume ï¼Œå› ä¸ºæ­¤æ—¶è¯¥ queue å°†æ— æ³•åœ¨ä½œä¸º hot-standby çš„ server ä¸Šè¢«é‡å»ºï¼Œæ‰€ä»¥ï¼Œåªèƒ½ç­‰åˆ°å¼‚å¸¸çš„ active server æ¢å¤åï¼Œæ‰èƒ½ä»å…¶ä¸Šçš„ queue ä¸­è·å–ç›¸åº”çš„ message è¿›è¡Œå¤„ç†ã€‚è€Œå¯¹äºä¸šåŠ¡æ¥è¯´ï¼Œéœ€è¦å…·æœ‰ï¼ša.æ„ŸçŸ¥ AMQP è¿æ¥æ–­å¼€åé‡å»ºå„ç§ fabric çš„èƒ½åŠ›ï¼›b.æ„ŸçŸ¥ active server æ¢å¤çš„èƒ½åŠ›ï¼›c.åˆ‡æ¢å› active server çš„æ—¶æœºæ§åˆ¶ï¼Œä»¥åŠåˆ‡å›åï¼Œé’ˆå¯¹ message å…ˆåé¡ºåºäº§ç”Ÿçš„å˜åŒ–è¿›è¡Œå¤„ç†çš„èƒ½åŠ›ã€‚
- å¯¹äºç¬¬äºŒç§æ¨¡å‹ï¼Œå› ä¸ºæ˜¯åŸºäºå…±äº«å­˜å‚¨çš„æ¨¡å¼ï¼Œæ‰€ä»¥å¯¼è‡´ active server å¼‚å¸¸çš„æ¡ä»¶ï¼Œå¯èƒ½åŒæ ·ä¼šå¯¼è‡´ cold-standby server å¼‚å¸¸ï¼›å¦å¤–ï¼Œåœ¨è¯¥æ¨¡å‹ä¸‹ï¼Œè¦æ±‚ active å’Œ cold-standby çš„ server å¿…é¡»å…·æœ‰ç›¸åŒçš„ node åå’Œ UID ï¼Œå¦åˆ™å°†äº§ç”Ÿè®¿é—®æƒé™é—®é¢˜ï¼›æœ€åï¼Œç”±äºè¯¥æ¨¡å‹æ˜¯å†·å¤‡æ–¹æ¡ˆï¼Œæ•…æ— æ³•ä¿è¯ cold-standby server èƒ½åœ¨ä½ è¦æ±‚çš„æ—¶é™å†…æˆåŠŸå¯åŠ¨ã€‚

## RabbitMQ å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ

> è¿™ä¸ªé—®é¢˜ï¼Œå’Œ [ã€ŒRabbitMQ ä¸­çš„ clusterã€mirrored queueï¼Œä»¥åŠ warrens æœºåˆ¶åˆ†åˆ«ç”¨äºè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) ä¼šæ¯”è¾ƒç±»ä¼¼ã€‚

RabbitMQ çš„é«˜å¯ç”¨ï¼Œæ˜¯åŸºäº**ä¸»ä»**åšé«˜å¯ç”¨æ€§çš„ã€‚å®ƒæœ‰ä¸‰ç§æ¨¡å¼ï¼š

- å•æœºæ¨¡å¼
- æ™®é€šé›†ç¾¤æ¨¡å¼
- é•œåƒé›†ç¾¤æ¨¡å¼

ğŸ¦… **1ï¼‰å•æœºæ¨¡å¼**

å•æœºæ¨¡å¼ï¼Œå°±æ˜¯å¯åŠ¨å•ä¸ª RabbitMQ èŠ‚ç‚¹ï¼Œä¸€èˆ¬ç”¨äºæœ¬åœ°å¼€å‘æˆ–è€…æµ‹è¯•ç¯å¢ƒã€‚å®é™…ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒåŸºæœ¬ä¸ä¼šä½¿ç”¨ã€‚

ğŸ¦… **æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰**

> è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯ä¸Šé¢é—®é¢˜çš„ **cluster** ã€‚

æ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯ä¸ªæœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚

- ä½ **åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Š**ï¼Œä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚
- ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥ã€‚

[![æ¶æ„å›¾](http://static.iocoder.cn/75d36ed17c91932e28b5eeba681ad8ec)](http://static.iocoder.cn/75d36ed17c91932e28b5eeba681ad8ec)æ¶æ„å›¾

è¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œ**æ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼**ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰**æ•°æ®æ‹‰å–çš„å¼€é”€**ï¼Œåè€…å¯¼è‡´**å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆ**ã€‚

è€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ **å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–**ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œ**æ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢**ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚

æ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±**æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§**ï¼Œ**è¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„**ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œã€‚

ğŸ¦… **é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰**

> è‰¿è‰¿ï¼šè¯·æ•™äº†ä¸‹èƒ–å‹ï¼Œä»–ä»¬é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚
>
> è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯ä¸Šé¢é—®é¢˜çš„ **Mirrored queue** ã€‚

è¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„ RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºå…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼š**å­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Š**ï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ª**å®Œæ•´é•œåƒ**ï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠ**æ¶ˆæ¯åŒæ­¥**åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚

[![æ¶æ„å›¾](http://static.iocoder.cn/20a6c4d82a08becf7e8d913662b00357)](http://static.iocoder.cn/20a6c4d82a08becf7e8d913662b00357)æ¶æ„å›¾

é‚£ä¹ˆ**å¦‚ä½•å¼€å¯è¿™ä¸ªé•œåƒé›†ç¾¤æ¨¡å¼**å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒRabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯**é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥**ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹ï¼Œå†æ¬¡åˆ›å»º queue çš„æ—¶å€™ï¼Œåº”ç”¨è¿™ä¸ªç­–ç•¥ï¼Œå°±ä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚

è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚åå¤„åœ¨äºï¼Œç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±**æ²¡æœ‰æ‰©å±•æ€§å¯è¨€**äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶**æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•**ä½ çš„ queueã€‚ä½ æƒ³ï¼Œå¦‚æœè¿™ä¸ª queue çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¤§åˆ°è¿™ä¸ªæœºå™¨ä¸Šçš„å®¹é‡æ— æ³•å®¹çº³äº†ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

## å¦‚ä½•ä½¿ç”¨ RabbitMQ å®ç° RPC

åŸºäº [RabbitMQ reply_to](https://www.rabbitmq.com/direct-reply-to.html) ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆè½»æ˜“ä½¿ç”¨ RabbitMQ å®ç° RPC åŠŸèƒ½ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ15. RPC è¿œç¨‹è°ƒç”¨ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

ğŸ¦… **ä½¿ç”¨ RabbitMQ å®ç° RPC æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**

- 1ã€å°†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è§£è€¦ï¼šå®¢æˆ·ç«¯åªæ˜¯å‘å¸ƒä¸€ä¸ªè¯·æ±‚åˆ° MQ å¹¶æ¶ˆè´¹è¿™ä¸ªè¯·æ±‚çš„å“åº”ã€‚å¹¶ä¸å…³å¿ƒå…·ä½“ç”±è°æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼ŒMQ å¦ä¸€ç«¯çš„è¯·æ±‚çš„æ¶ˆè´¹è€…å¯ä»¥éšæ„æ›¿æ¢æˆä»»ä½•å¯ä»¥å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸å½±å“åˆ°å®¢æˆ·ç«¯ã€‚

  > ç›¸å½“äº RPC çš„æ³¨å†Œå‘ç°åŠŸèƒ½ï¼Œäº¤ç»™ RabbitMQ æ¥å®ç°äº†ã€‚

- 2ã€å‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼šä¼ ç»Ÿçš„ RPC æ¨¡å¼ä¸­å¦‚æœå®¢æˆ·ç«¯å’Œè¯·æ±‚è¿‡å¤šï¼ŒæœåŠ¡å™¨çš„å‹åŠ›ä¼šè¿‡å¤§ã€‚ç”± MQ ä½œä¸ºä¸­é—´ä»¶çš„è¯ï¼Œè¿‡å¤šçš„è¯·æ±‚è€Œæ˜¯è¢« MQ æ¶ˆåŒ–æ‰ï¼ŒæœåŠ¡å™¨å¯ä»¥æ§åˆ¶æ¶ˆè´¹è¯·æ±‚çš„é¢‘æ¬¡ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°æœåŠ¡å™¨ã€‚

- 3ã€æœåŠ¡å™¨çš„æ¨ªå‘æ‰©å±•æ›´åŠ å®¹æ˜“ï¼šå¦‚æœæœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›ä¸èƒ½æ»¡è¶³è¯·æ±‚çš„é¢‘æ¬¡ï¼Œåªéœ€è¦å¢åŠ æœåŠ¡å™¨æ¥æ¶ˆè´¹ MQ çš„æ¶ˆæ¯å³å¯ï¼ŒMQä¼šå¸®æˆ‘ä»¬å®ç°æ¶ˆæ¯æ¶ˆè´¹çš„è´Ÿè½½å‡è¡¡ã€‚

- 4ã€å¯ä»¥çœ‹å‡º RabbitMQ å¯¹äº RPC æ¨¡å¼çš„æ”¯æŒä¹Ÿæ˜¯æ¯”è¾ƒå‹å¥½åœ°ï¼Œamq.rabbitmq.correlation_id

   è¿™äº›ç‰¹æ€§éƒ½è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼Œå†åŠ ä¸Šspring-rabbitçš„å®ç°ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾ˆç®€å•çš„ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼çš„ RPC è°ƒç”¨ã€‚
  
  > ä¾‹å¦‚è¯´ï¼š[`rabbitmq-jsonrpc`](https://github.com/rabbitmq/rabbitmq-jsonrpc) çš„å®ç°ã€‚

å½“ç„¶ï¼Œè™½ç„¶æœ‰è¿™äº›ä¼˜ç‚¹ï¼Œå®é™…åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šè¿™ä¹ˆåšã€‚ğŸ˜ˆ

ğŸ¦… **ä¸ºä»€ä¹ˆ heavy RPC çš„ä½¿ç”¨åœºæ™¯ä¸‹ä¸å»ºè®®é‡‡ç”¨ disk node ï¼Ÿ**

heavy RPC æ˜¯æŒ‡åœ¨ä¸šåŠ¡é€»è¾‘ä¸­é«˜é¢‘è°ƒç”¨ RabbitMQ æä¾›çš„ RPC æœºåˆ¶ï¼Œå¯¼è‡´ä¸æ–­åˆ›å»ºã€é”€æ¯ reply queue ï¼Œè¿›è€Œé€ æˆ disk node çš„æ€§èƒ½é—®é¢˜ï¼ˆå› ä¸ºä¼šé’ˆå¯¹å…ƒæ•°æ®ä¸æ–­å†™ç›˜ï¼‰ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ RPC æœºåˆ¶æ—¶éœ€è¦è€ƒè™‘è‡ªèº«çš„ä¸šåŠ¡åœºæ™¯ï¼Œä¸€èˆ¬æ¥è¯´ä¸å»ºè®®ã€‚

## RabbitMQ æ˜¯å¦ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ

> è‰¿è‰¿ï¼šè¿™ä¸ªé—®é¢˜ï¼ŒåŸºæœ¬æ˜¯æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„å‡ ä¸ªé—®é¢˜çš„æ€»ç»“åˆå¹¶ã€‚

![å¼„ä¸¢æ¶ˆæ¯çš„å‡ ç§æƒ…å†µ](http://static.iocoder.cn/6303e69011255831c54d605250a6aa67)

ğŸ¦… **ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

ç”Ÿäº§è€…å°†æ•°æ®å‘é€åˆ° RabbitMQ çš„æ—¶å€™ï¼Œå¯èƒ½æ•°æ®å°±åœ¨åŠè·¯ç»™æä¸¢äº†ï¼Œå› ä¸ºç½‘ç»œé—®é¢˜å•¥çš„ï¼Œéƒ½æœ‰å¯èƒ½ã€‚

> æ–¹æ¡ˆä¸€ï¼šäº‹åŠ¡åŠŸèƒ½

ğŸš€ æ­¤æ—¶å¯ä»¥é€‰æ‹©ç”¨ RabbitMQ æä¾›çš„ã€äº‹åŠ¡åŠŸèƒ½ã€‘ï¼Œå°±æ˜¯ç”Ÿäº§è€…**å‘é€æ•°æ®ä¹‹å‰**å¼€å¯ RabbitMQ äº‹åŠ¡`channel.txSelect`ï¼Œç„¶åå‘é€æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯æ²¡æœ‰æˆåŠŸè¢« RabbitMQ æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ä¼šæ”¶åˆ°å¼‚å¸¸æŠ¥é”™ï¼Œæ­¤æ—¶å°±å¯ä»¥å›æ»šäº‹åŠ¡`channel.txRollback`ï¼Œç„¶åé‡è¯•å‘é€æ¶ˆæ¯ï¼›å¦‚æœæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¯ä»¥æäº¤äº‹åŠ¡`channel.txCommit`ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// å¼€å¯äº‹åŠ¡
channel.txSelect
try {
    // è¿™é‡Œå‘é€æ¶ˆæ¯
} catch (Exception e) {
    channel.txRollback

    // è¿™é‡Œå†æ¬¡é‡å‘è¿™æ¡æ¶ˆæ¯
}

// æäº¤äº‹åŠ¡
channel.txCommit
```

- ä½†æ˜¯é—®é¢˜æ˜¯ï¼ŒRabbitMQ äº‹åŠ¡æœºåˆ¶ï¼ˆåŒæ­¥ï¼‰ä¸€æï¼ŒåŸºæœ¬ä¸Š**ååé‡ä¼šä¸‹æ¥ï¼Œå› ä¸ºå¤ªè€—æ€§èƒ½**ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ12. äº‹åŠ¡æ¶ˆæ¯ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

> æ–¹æ¡ˆäºŒï¼šconfirm åŠŸèƒ½ã€‚

ğŸš€ æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ è¦ç¡®ä¿è¯´å†™ RabbitMQ çš„æ¶ˆæ¯åˆ«ä¸¢ï¼Œå¯ä»¥å¼€å¯ ã€`confirm` æ¨¡å¼ã€‘ï¼Œåœ¨ç”Ÿäº§è€…é‚£é‡Œè®¾ç½®å¼€å¯ `confirm` æ¨¡å¼ä¹‹åï¼Œä½ æ¯æ¬¡å†™çš„æ¶ˆæ¯éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œç„¶åå¦‚æœå†™å…¥äº† RabbitMQ ä¸­ï¼ŒRabbitMQ ä¼šç»™ä½ å›ä¼ ä¸€ä¸ª `ack` æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ è¯´è¿™ä¸ªæ¶ˆæ¯ ok äº†ã€‚å¦‚æœ RabbitMQ æ²¡èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä¼šå›è°ƒä½ çš„ä¸€ä¸ª `nack` æ¥å£ï¼Œå‘Šè¯‰ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼Œä½ å¯ä»¥é‡è¯•ã€‚è€Œä¸”ä½ å¯ä»¥ç»“åˆè¿™ä¸ªæœºåˆ¶è‡ªå·±åœ¨å†…å­˜é‡Œç»´æŠ¤æ¯ä¸ªæ¶ˆæ¯ id çš„çŠ¶æ€ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯çš„å›è°ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥é‡å‘ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ14. ç”Ÿäº§è€…çš„å‘é€ç¡®è®¤ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚ã€‚

> å¯¹æ¯”æ€»ç»“

ğŸš€ äº‹åŠ¡æœºåˆ¶å’Œ `confirm` æœºåˆ¶æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œ**äº‹åŠ¡æœºåˆ¶æ˜¯åŒæ­¥çš„**ï¼Œä½ æäº¤ä¸€ä¸ªäº‹åŠ¡ä¹‹åä¼š**é˜»å¡**åœ¨é‚£å„¿ï¼Œä½†æ˜¯ `confirm` æœºåˆ¶æ˜¯**å¼‚æ­¥**çš„ï¼Œä½ å‘é€ä¸ªæ¶ˆæ¯ä¹‹åå°±å¯ä»¥å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åé‚£ä¸ªæ¶ˆæ¯ RabbitMQ æ¥æ”¶äº†ä¹‹åä¼šå¼‚æ­¥å›è°ƒä½ çš„ä¸€ä¸ªæ¥å£é€šçŸ¥ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶åˆ°äº†ã€‚

æ‰€ä»¥ä¸€èˆ¬åœ¨ç”Ÿäº§è€…è¿™å—**é¿å…æ•°æ®ä¸¢å¤±**ï¼Œéƒ½æ˜¯ç”¨ `confirm` æœºåˆ¶çš„ã€‚

> ğŸ˜ˆ ä¸è¿‡ confirm åŠŸèƒ½ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ä¸¢æ¶ˆæ¯çš„æƒ…å†µã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœå›è°ƒåˆ° `nack` æ¥å£ï¼Œæ­¤æ—¶ JVM æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ­¤æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚ï¼ˆè¿™ä¸ªæ˜¯è‰¿è‰¿çš„çŒœæƒ³ï¼Œè¿˜åœ¨æ‰¾èƒ–å‹æ¢è®¨ä¸­ã€‚å…³äºè¿™å—ï¼Œæ¬¢è¿æ˜Ÿçƒè®¨è®ºã€‚ï¼‰

ğŸ¦… **Broker å¼„ä¸¢äº†æ•°æ®**

å°±æ˜¯ Broker è‡ªå·±å¼„ä¸¢äº†æ•°æ®ï¼Œè¿™ä¸ªä½ å¿…é¡»**å¼€å¯ Broker çš„æŒä¹…åŒ–**ï¼Œå°±æ˜¯æ¶ˆæ¯å†™å…¥ä¹‹åä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå“ªæ€•æ˜¯ Broker è‡ªå·±æŒ‚äº†ï¼Œ**æ¢å¤ä¹‹åä¼šè‡ªåŠ¨è¯»å–ä¹‹å‰å­˜å‚¨çš„æ•°æ®**ï¼Œä¸€èˆ¬æ•°æ®ä¸ä¼šä¸¢ã€‚é™¤éæå…¶ç½•è§çš„æ˜¯ï¼ŒBroker è¿˜æ²¡æŒä¹…åŒ–ï¼Œè‡ªå·±å°±æŒ‚äº†ï¼Œ**å¯èƒ½å¯¼è‡´å°‘é‡æ•°æ®ä¸¢å¤±**ï¼Œä½†æ˜¯è¿™ä¸ªæ¦‚ç‡è¾ƒå°ã€‚

è®¾ç½®æŒä¹…åŒ–æœ‰**ä¸¤ä¸ªæ­¥éª¤**ï¼š

- åˆ›å»º queue çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–
  è¿™æ ·å°±å¯ä»¥ä¿è¯ RabbitMQ æŒä¹…åŒ– queue çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ä¼šæŒä¹…åŒ– queue é‡Œçš„æ•°æ®çš„ã€‚
- ç¬¬äºŒä¸ªæ˜¯å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†æ¶ˆæ¯çš„ `deliveryMode` è®¾ç½®ä¸º 2
  å°±æ˜¯å°†æ¶ˆæ¯è®¾ç½®ä¸ºæŒä¹…åŒ–çš„ï¼Œæ­¤æ—¶ RabbitMQ å°±ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šå»ã€‚

å¿…é¡»è¦åŒæ—¶è®¾ç½®è¿™ä¸¤ä¸ªæŒä¹…åŒ–æ‰è¡Œï¼ŒBroker å“ªæ€•æ˜¯æŒ‚äº†ï¼Œå†æ¬¡é‡å¯ï¼Œä¹Ÿä¼šä»ç£ç›˜ä¸Šé‡å¯æ¢å¤ queueï¼Œæ¢å¤è¿™ä¸ª queue é‡Œçš„æ•°æ®ã€‚

æ³¨æ„ï¼Œå“ªæ€•æ˜¯ä½ ç»™ Broker å¼€å¯äº†æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿæœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯è¿™ä¸ªæ¶ˆæ¯å†™åˆ°äº† Broker ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œç»“æœä¸å·§ï¼Œæ­¤æ—¶ Broker æŒ‚äº†ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜é‡Œçš„ä¸€ç‚¹ç‚¹æ•°æ®ä¸¢å¤±ã€‚

æ‰€ä»¥ï¼ŒæŒä¹…åŒ–å¯ä»¥è·Ÿç”Ÿäº§è€…é‚£è¾¹çš„ `confirm` æœºåˆ¶é…åˆèµ·æ¥ï¼Œåªæœ‰æ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åï¼Œæ‰ä¼šé€šçŸ¥ç”Ÿäº§è€… `ack` äº†ï¼Œæ‰€ä»¥å“ªæ€•æ˜¯åœ¨æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹å‰ï¼ŒBroker æŒ‚äº†ï¼Œæ•°æ®ä¸¢äº†ï¼Œç”Ÿäº§è€…æ”¶ä¸åˆ° `ack`ï¼Œä½ ä¹Ÿæ˜¯å¯ä»¥è‡ªå·±é‡å‘çš„ã€‚

ğŸ¦… **æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

RabbitMQ å¦‚æœä¸¢å¤±äº†æ•°æ®ï¼Œä¸»è¦æ˜¯å› ä¸ºä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œ**åˆšæ¶ˆè´¹åˆ°ï¼Œè¿˜æ²¡å¤„ç†ï¼Œç»“æœè¿›ç¨‹æŒ‚äº†**ï¼Œæ¯”å¦‚é‡å¯äº†ï¼Œé‚£ä¹ˆå°±å°´å°¬äº†ï¼ŒRabbitMQ è®¤ä¸ºä½ éƒ½æ¶ˆè´¹äº†ï¼Œè¿™æ•°æ®å°±ä¸¢äº†ã€‚

è¿™ä¸ªæ—¶å€™å¾—ç”¨ RabbitMQ æä¾›çš„ `ack` æœºåˆ¶ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½ å¿…é¡»å…³é—­ RabbitMQ çš„è‡ªåŠ¨ `ack`ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª api æ¥è°ƒç”¨å°±è¡Œï¼Œç„¶åæ¯æ¬¡ä½ è‡ªå·±ä»£ç é‡Œç¡®ä¿å¤„ç†å®Œçš„æ—¶å€™ï¼Œå†åœ¨ç¨‹åºé‡Œ `ack` ä¸€æŠŠã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœä½ è¿˜æ²¡å¤„ç†å®Œï¼Œä¸å°±æ²¡æœ‰ `ack` äº†ï¼Ÿé‚£ RabbitMQ å°±è®¤ä¸ºä½ è¿˜æ²¡å¤„ç†å®Œï¼Œè¿™ä¸ªæ—¶å€™ RabbitMQ ä¼šæŠŠè¿™ä¸ªæ¶ˆè´¹åˆ†é…ç»™åˆ«çš„ consumer å»å¤„ç†ï¼Œæ¶ˆæ¯æ˜¯ä¸ä¼šä¸¢çš„ã€‚

ğŸ¦… **æ€»ç»“**

![æ€»ç»“](http://static.iocoder.cn/83213e2ac79cd8899b09a66a5cf71669)

## RabbitMQ å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

å’Œ Kafka ä¸ RocketMQ ä¸åŒï¼ŒKafka ä¸å­˜åœ¨ç±»ä¼¼ç±»ä¼¼ Topic çš„æ¦‚å¿µï¼Œè€Œæ˜¯çœŸæ­£çš„ä¸€æ¡ä¸€æ¡é˜Ÿåˆ—ï¼Œå¹¶ä¸”æ¯ä¸ªé˜Ÿåˆ—å¯ä»¥è¢«å¤šä¸ª Consumer æ‹‰å–æ¶ˆæ¯ã€‚è¿™ä¸ªï¼Œæ˜¯éå¸¸å¤§çš„ä¸€ä¸ªå·®å¼‚ã€‚

ğŸš€ **æ¥çœ‹çœ‹ RabbitMQ é¡ºåºé”™ä¹±çš„åœºæ™¯**ï¼š

ä¸€ä¸ª queueï¼Œå¤šä¸ª consumerã€‚æ¯”å¦‚ï¼Œç”Ÿäº§è€…å‘ RabbitMQ é‡Œå‘é€äº†ä¸‰æ¡æ•°æ®ï¼Œé¡ºåºä¾æ¬¡æ˜¯ data1/data2/data3ï¼Œå‹å…¥çš„æ˜¯ RabbitMQ çš„ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ã€‚æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«ä» MQ ä¸­æ¶ˆè´¹è¿™ä¸‰æ¡æ•°æ®ä¸­çš„ä¸€æ¡ï¼Œç»“æœæ¶ˆè´¹è€… 2 å…ˆæ‰§è¡Œå®Œæ“ä½œï¼ŒæŠŠ data2 å­˜å…¥æ•°æ®åº“ï¼Œç„¶åæ˜¯ data1/data3ã€‚è¿™ä¸æ˜æ˜¾ä¹±äº†ã€‚ğŸ˜ˆ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¹±åºæ¶ˆè´¹çš„é—®é¢˜ã€‚

![ä¹±åº](http://static.iocoder.cn/29ea655479f826f9a6a5d9d005f46c7c)

ğŸš€ **è§£å†³æ–¹æ¡ˆ**ï¼š

- æ–¹æ¡ˆä¸€ï¼Œæ‹†åˆ†å¤šä¸ª queueï¼Œæ¯ä¸ª queue ä¸€ä¸ª consumerï¼Œå°±æ˜¯å¤šä¸€äº› queue è€Œå·²ï¼Œç¡®å®æ˜¯éº»çƒ¦ç‚¹ã€‚

  > è¿™ä¸ªæ–¹å¼ï¼Œæœ‰ç‚¹æ¨¡ä»¿ Kafka å’Œ RocketMQ ä¸­ Topic çš„æ¦‚å¿µã€‚ä¾‹å¦‚è¯´ï¼ŒåŸå…ˆä¸€ä¸ª queue å« `"xxx"` ï¼Œé‚£ä¹ˆå¤šä¸ª queue ï¼Œæˆ‘ä»¬å¯ä»¥å« `"xxx-01"`ã€`"xxx-02"` ç­‰ï¼Œç›¸åŒå‰ç¼€ï¼Œä¸åŒåç¼€ã€‚

- æ–¹æ¡ˆäºŒï¼Œæˆ–è€…å°±ä¸€ä¸ª queue ä½†æ˜¯å¯¹åº”ä¸€ä¸ª consumerï¼Œç„¶åè¿™ä¸ª consumer å†…éƒ¨ç”¨å†…å­˜é˜Ÿåˆ—åšæ’é˜Ÿï¼Œç„¶ååˆ†å‘ç»™åº•å±‚ä¸åŒçš„ worker æ¥å¤„ç†ã€‚

  > è¿™ç§æ–¹å¼ï¼Œå°±æ˜¯è®²ä¸€ä¸ª queue é‡Œçš„ï¼Œç›¸åŒçš„â€œkeyâ€ äº¤ç»™åŒä¸€ä¸ª worker æ¥æ‰§è¡Œã€‚å› ä¸º RabbitMQ æ˜¯å¯ä»¥å•æ¡æ¶ˆæ¯æ¥ ack ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚è¿™ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å’Œ RocketMQ å’Œ Kafka ä¸åŒçš„åœ°æ–¹ã€‚

![è§£å†³ä¹±åº](http://static.iocoder.cn/f1bd6c79deaa6fae89a62d0e53f1ad43)

å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸Šè¿°çš„ä¸¤ä¸ªæ–¹æ¡ˆï¼Œå‰æéƒ½æ˜¯ä¸€ä¸ª queue åªèƒ½å¯åŠ¨ä¸€ä¸ª consumer å¯¹åº”ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RabbitMQ å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ11. é¡ºåºæ¶ˆæ¯ã€](http://svip.iocoder.cn/RabbitMQ/Interview/#) å°èŠ‚

# 666. å½©è›‹

å†™çš„å¾ˆç³Ÿç³•ï¼Œä¸€åº¦æƒ³åˆ é™¤ã€‚åæ¥æƒ³æƒ³ï¼Œå…ˆå°±é…±ç´«ï¼Œå¯èƒ½è¿™å°±æ˜¯æ­¤æ—¶è‡ªå·±å¯¹ RabbitMQ æŒæ¡çš„æƒ…å†µã€‚åé¢ç­‰è‡ªå·±ä¸šåŠ¡åœºæ™¯çœŸçš„å¼€å§‹ä½¿ç”¨ RabbitMQ ä¹‹åï¼Œåœ¨å¥½å¥½å€’è…¾å€’è…¾ã€‚Sad But Tree ã€‚

å‚è€ƒä¸æ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- [ã€ŠRabbitMQ é¢è¯•ä¸“é¢˜ã€‹](https://blog.csdn.net/qq_30764991/article/details/80573352)
- [ã€Šå¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿã€‹](https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues.md)
- [ã€ŠRabbitMQ é¢è¯•è¦ç‚¹ã€‹](https://chaser520.iteye.com/blog/2428253)
- [ã€Šå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰ã€‹](https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages.md)