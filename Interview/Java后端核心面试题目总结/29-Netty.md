## å¯¹æ¯”Javaæ ‡å‡†NIOç±»åº“ï¼Œä½ çŸ¥é“Nettyæ˜¯å¦‚ä½•å®ç°æ›´é«˜æ€§èƒ½çš„å—ï¼Ÿ

å•ç‹¬ä»æ€§èƒ½è§’åº¦ï¼ŒNetty åœ¨åŸºç¡€çš„ NIO ç­‰ç±»åº“ä¹‹ä¸Šè¿›è¡Œäº†å¾ˆå¤šæ”¹è¿›ï¼Œä¾‹å¦‚ï¼š

- æ›´åŠ ä¼˜é›…çš„ Reactor æ¨¡å¼å®ç°ã€çµæ´»çš„çº¿ç¨‹æ¨¡å‹ã€åˆ©ç”¨ EventLoop ç­‰åˆ›æ–°æ€§çš„æœºåˆ¶ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆåœ°ç®¡ç†æˆç™¾ä¸Šåƒçš„ Channelã€‚
- å……åˆ†åˆ©ç”¨äº† Java çš„ Zero-Copy æœºåˆ¶ï¼Œå¹¶ä¸”ä»å¤šç§è§’åº¦ï¼Œâ€œæ–¤æ–¤è®¡è¾ƒâ€èˆ¬çš„é™ä½å†…å­˜åˆ†é…å’Œå›æ”¶çš„å¼€é”€ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨æ± åŒ–çš„ Direct Buffer ç­‰æŠ€æœ¯ï¼Œåœ¨æé«˜ IO æ€§èƒ½çš„åŒæ—¶ï¼Œå‡å°‘äº†å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ï¼›åˆ©ç”¨åå°„ç­‰æŠ€æœ¯ç›´æ¥æ“çºµ SelectionKeyï¼Œä½¿ç”¨æ•°ç»„è€Œä¸æ˜¯ Java å®¹å™¨ç­‰ã€‚
- ä½¿ç”¨æ›´å¤šæœ¬åœ°ä»£ç ã€‚ä¾‹å¦‚ï¼Œç›´æ¥åˆ©ç”¨ JNI è°ƒç”¨ Open SSL ç­‰æ–¹å¼ï¼Œè·å¾—æ¯” Java å†…å»º SSL å¼•æ“æ›´å¥½çš„æ€§èƒ½ã€‚
- åœ¨é€šä¿¡åè®®ã€åºåˆ—åŒ–ç­‰å…¶ä»–è§’åº¦çš„ä¼˜åŒ–ã€‚

æ€»çš„æ¥è¯´ï¼ŒNetty å¹¶æ²¡æœ‰ Java æ ¸å¿ƒç±»åº“é‚£äº›å¼ºçƒˆçš„é€šç”¨æ€§ã€è·¨å¹³å°ç­‰å„ç§è´Ÿæ‹…ï¼Œé’ˆå¯¹æ€§èƒ½ç­‰ç‰¹å®šç›®æ ‡ä»¥åŠ Linux ç­‰ç‰¹å®šç¯å¢ƒï¼Œé‡‡å–äº†ä¸€äº›æè‡´çš„ä¼˜åŒ–æ‰‹æ®µã€‚



## BIO æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ¦… **æ¦‚å¿µ**

- BIO ï¼Œå…¨ç§° Block-IO ï¼Œæ˜¯ä¸€ç§**é˜»å¡** + **åŒæ­¥**çš„é€šä¿¡æ¨¡å¼ã€‚
- æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¼ ç»Ÿçš„é€šä¿¡æ–¹å¼ï¼Œæ¨¡å¼ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚ä½†å¹¶å‘å¤„ç†èƒ½åŠ›ä½ï¼Œé€šä¿¡è€—æ—¶ï¼Œä¾èµ–ç½‘é€Ÿã€‚

ğŸ¦… **åŸç†**

- æœåŠ¡å™¨é€šè¿‡ä¸€ä¸ª Acceptor çº¿ç¨‹ï¼Œè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚å’Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹è¿›è¡Œé“¾è·¯å¤„ç†ã€‚å…¸å‹çš„**ä¸€è¯·æ±‚ä¸€åº”ç­”æ¨¡å¼**ã€‚
- è‹¥å®¢æˆ·ç«¯æ•°é‡å¢å¤šï¼Œé¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¼šç»™æœåŠ¡å™¨æ‰“å¼€å¾ˆå¤§çš„å‹åŠ›ã€‚åæ”¹è‰¯ä¸ºç”¨çº¿ç¨‹æ± çš„æ–¹å¼ä»£æ›¿æ–°å¢çº¿ç¨‹ï¼Œè¢«ç§°ä¸ºä¼ªå¼‚æ­¥ IO ã€‚

ğŸ¦… **ç¤ºä¾‹**

- ä»£ç å‚è§ [bio](https://github.com/ITDragonBlog/daydayup/tree/master/Netty/socket-io/src/com/itdragon/bio) ã€‚

ğŸ¦… **å°ç»“**

BIO æ¨¡å‹ä¸­ï¼Œé€šè¿‡ Socket å’Œ ServerSocket å®ç°å¥—æ¥å­—é€šé“çš„é€šä¿¡ã€‚é˜»å¡ï¼ŒåŒæ­¥ï¼Œå»ºç«‹è¿æ¥è€—æ—¶ã€‚

## NIO æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ¦… **æ¦‚å¿µ**

- NIO ï¼Œå…¨ç§° New IO ï¼Œä¹Ÿå« Non-Block IO ï¼Œæ˜¯ä¸€ç§**éé˜»å¡** + åŒæ­¥çš„é€šä¿¡æ¨¡å¼ã€‚
- [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆä¸€ï¼‰ä¹‹ç®€ä»‹ã€‹](http://svip.iocoder.cn/Netty/nio-1-intro/)

ğŸ¦… **åŸç†**

- NIO ç›¸å¯¹äº BIO æ¥è¯´ä¸€å¤§è¿›æ­¥ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´é€šè¿‡ Channel é€šä¿¡ã€‚NIO å¯ä»¥åœ¨ Channel è¿›è¡Œè¯»å†™æ“ä½œã€‚è¿™äº› Channel éƒ½ä¼šè¢«æ³¨å†Œåœ¨ Selector å¤šè·¯å¤ç”¨å™¨ä¸Šã€‚Selector é€šè¿‡ä¸€ä¸ªçº¿ç¨‹ä¸åœçš„è½®è¯¢è¿™äº› Channel ã€‚æ‰¾å‡ºå·²ç»å‡†å¤‡å°±ç»ªçš„ Channel æ‰§è¡Œ IO æ“ä½œã€‚
- NIO é€šè¿‡ä¸€ä¸ªçº¿ç¨‹è½®è¯¢ï¼Œå®ç°åƒä¸‡ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè¿™å°±æ˜¯éé˜»å¡ NIO çš„ç‰¹ç‚¹ã€‚
  - ç¼“å†²åŒº Buffer ï¼šå®ƒæ˜¯ NIO ä¸ BIO çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚
    - BIO æ˜¯å°†æ•°æ®ç›´æ¥å†™å…¥æˆ–è¯»å–åˆ°æµ Stream å¯¹è±¡ä¸­ã€‚
    - NIO çš„æ•°æ®æ“ä½œéƒ½æ˜¯åœ¨ Buffer ä¸­è¿›è¡Œçš„ã€‚Buffer å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚Buffer æœ€å¸¸è§çš„ç±»å‹æ˜¯ByteBufferï¼Œå¦å¤–è¿˜æœ‰ CharBufferï¼ŒShortBufferï¼ŒIntBufferï¼ŒLongBufferï¼ŒFloatBufferï¼ŒDoubleBufferã€‚
    - [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆä¸‰ï¼‰ä¹‹ Bufferã€‹](http://svip.iocoder.cn/Netty/nio-3-buffer/)
  - é€šé“ Channel ï¼šå’Œæµ Stream ä¸åŒï¼Œé€šé“æ˜¯åŒå‘çš„ã€‚NIOå¯ä»¥é€šè¿‡ Channel è¿›è¡Œæ•°æ®çš„è¯»ã€å†™å’ŒåŒæ—¶è¯»å†™æ“ä½œã€‚
    - é€šé“åˆ†ä¸ºä¸¤å¤§ç±»ï¼šä¸€ç±»æ˜¯ç½‘ç»œè¯»å†™ï¼ˆSelectableChannelï¼‰ï¼Œä¸€ç±»æ˜¯ç”¨äºæ–‡ä»¶æ“ä½œï¼ˆFileChannelï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å‰è€… SocketChannel å’Œ ServerSocketChannel ï¼Œéƒ½æ˜¯SelectableChannel çš„å­ç±»ã€‚
    - [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆäºŒï¼‰ä¹‹ Channelã€‹](http://svip.iocoder.cn/Netty/nio-2-channel/)
  - å¤šè·¯å¤ç”¨å™¨ Selector ï¼šNIO ç¼–ç¨‹çš„åŸºç¡€ã€‚å¤šè·¯å¤ç”¨å™¨æä¾›é€‰æ‹©å·²ç»å°±ç»ªçš„ä»»åŠ¡çš„èƒ½åŠ›ï¼šå°±æ˜¯ Selector ä¼šä¸æ–­åœ°è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„é€šé“ï¼ˆChannelï¼‰ï¼Œå¦‚æœæŸä¸ªé€šé“å¤„äºå°±ç»ªçŠ¶æ€ï¼Œä¼šè¢« Selector è½®è¯¢å‡ºæ¥ï¼Œç„¶åé€šè¿‡ SelectionKey å¯ä»¥å–å¾—å°±ç»ªçš„Channelé›†åˆï¼Œä»è€Œè¿›è¡Œåç»­çš„ IO æ“ä½œã€‚
    - æœåŠ¡å™¨ç«¯åªè¦æä¾›ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ Selector çš„è½®è¯¢ï¼Œå°±å¯ä»¥æ¥å…¥æˆåƒä¸Šä¸‡ä¸ªå®¢æˆ·ç«¯ï¼Œè¿™å°±æ˜¯ JDK NIO åº“çš„å·¨å¤§è¿›æ­¥ã€‚
    - [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆå››ï¼‰ä¹‹ Selectorã€‹](http://svip.iocoder.cn/Netty/nio-4-selector/)

ğŸ¦… **ç¤ºä¾‹**

- ä»£ç å‚è§ [nio](https://github.com/ITDragonBlog/daydayup/tree/master/Netty/socket-io/src/com/itdragon/nio)
- [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆäº”ï¼‰ä¹‹ç¤ºä¾‹ã€‹](http://svip.iocoder.cn/Netty/nio-5-demo/)

ğŸ¦… **å°ç»“**

NIO æ¨¡å‹ä¸­é€šè¿‡ SocketChannel å’Œ ServerSocketChannel å®ç°å¥—æ¥å­—é€šé“çš„é€šä¿¡ã€‚éé˜»å¡ï¼ŒåŒæ­¥ï¼Œé¿å…ä¸ºæ¯ä¸ª TCP è¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚

ğŸ¦… **ç»§ç»­æŒ–æ˜**

å¯èƒ½æœ‰èƒ–å‹å¯¹éé˜»å¡å’Œé˜»å¡ï¼ŒåŒæ­¥å’Œå¼‚æ­¥çš„å®šä¹‰æœ‰ç‚¹æ‡µé€¼ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆä¸€ï¼‰ä¹‹ç®€ä»‹ã€‹](http://svip.iocoder.cn/Netty/nio-1-intro/) æåˆ°çš„ä¸€æ®µè¯ï¼š

> è€è‰¿è‰¿ï¼šåœ¨ä¸€äº›æ–‡ç« ä¸­ï¼Œä¼šå°† Java NIO æè¿°æˆ**å¼‚æ­¥** IO ï¼Œå®é™…æ˜¯ä¸å¤ªæ­£ç¡®çš„ï¼š Java NIO æ˜¯**åŒæ­¥** IO ï¼ŒJava AIO ( ä¹Ÿç§°ä¸º NIO 2 )æ˜¯**å¼‚æ­¥** IOã€‚å…·ä½“åŸå› ï¼Œæ¨èé˜…è¯»æ–‡ç« ï¼š
>
> - [ã€Šå¼‚æ­¥å’Œéé˜»å¡ä¸€æ ·å—? (å†…å®¹æ¶‰åŠ BIO, NIO, AIO, Netty)ã€‹](https://blog.csdn.net/matthew_zhang/article/details/71328697) ã€‚
> - [ã€ŠBIOä¸NIOã€AIOçš„åŒºåˆ«(è¿™ä¸ªå®¹æ˜“ç†è§£)ã€‹](https://blog.csdn.net/skiof007/article/details/52873421)
>
> æ€»ç»“æ¥è¯´ï¼Œåœ¨ **Unix IO æ¨¡å‹**çš„è¯­å¢ƒä¸‹ï¼š
>
> - åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«ï¼šæ•°æ®æ‹·è´é˜¶æ®µæ˜¯å¦éœ€è¦å®Œå…¨ç”±æ“ä½œç³»ç»Ÿå¤„ç†ã€‚
> - é˜»å¡å’Œéé˜»å¡æ“ä½œï¼šæ˜¯é’ˆå¯¹å‘èµ· IO è¯·æ±‚æ“ä½œåï¼Œæ˜¯å¦æœ‰ç«‹åˆ»è¿”å›ä¸€ä¸ªæ ‡å¿—ä¿¡æ¯è€Œä¸è®©è¯·æ±‚çº¿ç¨‹ç­‰å¾…ã€‚
>
> å› æ­¤ï¼ŒJava NIO æ˜¯**åŒæ­¥**ä¸”éé˜»å¡çš„ IO ã€‚

- å¦å¤–ï¼Œèƒ–å‹åœ¨ç…ç…ä¸‹é¢è¿™ä¸ªå›¾æ¥ç†è§£ä¸‹ï¼š![Unix çš„ 5 ç§ IO æ¨¡å‹](http://static.iocoder.cn/images/Netty/2017_10_24/01.png)

## AIO æ˜¯ä»€ä¹ˆï¼Ÿ

> è‰¿è‰¿ï¼šè¿™ä¸ªé¢è¯•é¢˜ï¼Œé‡ç‚¹åœ¨äºé™ˆè¿°æˆ‘ä»¬å¯¹ BIOã€NIO çš„ç†è§£ï¼Œå¯¹äº AIO æ¥è¯´ï¼ŒåŸºæœ¬ç†è§£å³å¯ã€‚

ğŸ¦… **æ¦‚å¿µ**

- AIO ï¼Œå…¨ç§° Asynchronous IO ï¼Œä¹Ÿå« NIO**2** ï¼Œæ˜¯ä¸€ç§**éé˜»å¡** + **å¼‚æ­¥**çš„é€šä¿¡æ¨¡å¼ã€‚åœ¨ NIO çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥äº†æ–°çš„å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œå¹¶æä¾›äº†å¼‚æ­¥æ–‡ä»¶é€šé“å’Œå¼‚æ­¥å¥—æ¥å­—é€šé“çš„å®ç°ã€‚
- åŸç†ï¼š
- AIO å¹¶æ²¡æœ‰é‡‡ç”¨ NIO çš„å¤šè·¯å¤ç”¨å™¨ï¼Œè€Œæ˜¯ä½¿ç”¨å¼‚æ­¥é€šé“çš„æ¦‚å¿µã€‚å…¶ readï¼Œwrite æ–¹æ³•çš„è¿”å›ç±»å‹ï¼Œéƒ½æ˜¯ Future å¯¹è±¡ã€‚è€Œ Future æ¨¡å‹æ˜¯å¼‚æ­¥çš„ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å»ä¸»å‡½æ•°ç­‰å¾…æ—¶é—´**ã€‚

ğŸ¦… **ç¤ºä¾‹**

- ä»£ç å‚è§ [aio](https://github.com/ITDragonBlog/daydayup/tree/master/Netty/socket-io/src/com/itdragon/aio)

ğŸ¦… **å°ç»“**

AIO æ¨¡å‹ä¸­é€šè¿‡ AsynchronousSocketChannel å’Œ AsynchronousServerSocketChannel å®ç°å¥—æ¥å­—é€šé“çš„é€šä¿¡ã€‚éé˜»å¡ï¼Œå¼‚æ­¥ã€‚

## BIOã€NIO æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- çº¿ç¨‹æ¨¡å‹ä¸åŒ
  - BIOï¼šä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚æ‰€ä»¥ï¼Œçº¿ç¨‹å¼€é”€å¤§ã€‚å¯æ”¹è‰¯ä¸ºç”¨çº¿ç¨‹æ± çš„æ–¹å¼ä»£æ›¿æ–°åˆ›å»ºçº¿ç¨‹ï¼Œè¢«ç§°ä¸ºä¼ªå¼‚æ­¥ IO ã€‚
  - NIOï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†å®¢æˆ·ç«¯å‘é€çš„è¿æ¥è¯·æ±‚éƒ½ä¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰æ–°çš„ I/O è¯·æ±‚æ—¶ï¼Œæ‰å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚å¯æ”¹è‰¯ä¸ºä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚ï¼ŒåŸºäº [å¤š Reactor æ¨¡å‹](http://svip.iocoder.cn/Netty/EventLoop-1-Reactor-Model/)ã€‚
- BIO æ˜¯é¢å‘æµ( Stream )çš„ï¼Œè€Œ NIO æ˜¯é¢å‘ç¼“å†²åŒº( Buffer )çš„ã€‚
- BIO çš„å„ç§æ“ä½œæ˜¯é˜»å¡çš„ï¼Œè€Œ NIO çš„å„ç§æ“ä½œæ˜¯éé˜»å¡çš„ã€‚
- BIO çš„ Socket æ˜¯å•å‘çš„ï¼Œè€Œ NIO çš„ Channel æ˜¯åŒå‘çš„ã€‚

å¯èƒ½æ–‡å­—æ¯”è¾ƒéš¾è®°ï¼Œæ•´ç†å‡ºæ¥å°±æ˜¯ä¸‹å›¾ï¼š![BIO å¯¹æ¯” NIO å¯¹æ¯” AIO](http://static.iocoder.cn/images/Netty/2017_10_24/02.png)

- æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œè™½ç„¶å›¾ä¸­è¯´ NIO çš„æ€§èƒ½ä¸€èˆ¬ï¼Œä½†æ˜¯åœ¨ç»å¤§å¤šæ•°æˆ‘ä»¬æ—¥å¸¸ä¸šåŠ¡åœºæ™¯ï¼ŒNIO å’Œ AIO çš„æ€§èƒ½å·®è·å®é™…æ²¡è¿™ä¹ˆå¤§ã€‚åœ¨ Netty5 ä¸­ï¼ŒåŸºäº AIO æ”¹é€ å’Œæ”¯æŒï¼Œæœ€åå‘ç°ï¼Œæ€§èƒ½å¹¶æ²¡æœ‰æƒ³è±¡ä¸­è¿™ä¹ˆå¼ºæ‚ï¼Œæ‰€ä»¥ Netty5 è¢«åºŸå¼ƒï¼Œè€Œæ˜¯ç»§ç»­ä¿æŒ Netty4 ä¸ºä¸»ç‰ˆæœ¬ï¼Œä½¿ç”¨ NIO ä¸ºä¸»ã€‚

ä¸ºäº†èƒ–å‹èƒ½æ›´å¥½çš„è®°ä½å’Œç†è§£ BIOã€NIOã€AIO çš„æµç¨‹ï¼Œèƒ–å‹å¯ä»¥åœ¨ç†è§£ä¸‹å›¾ï¼š![BIOã€NIOã€AIO çš„æµç¨‹å›¾](http://static.iocoder.cn/images/Netty/2017_10_24/03.png)

## ä»€ä¹ˆæ˜¯ Netty ï¼Ÿ

> Netty æ˜¯ä¸€æ¬¾æä¾›å¼‚æ­¥çš„ã€äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶å’Œå·¥å…·ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¨‹åºã€‚
>
> ä¹Ÿå°±æ˜¯è¯´ï¼ŒNetty æ˜¯ä¸€ä¸ªåŸºäº NIO çš„å®¢æˆ·ã€æœåŠ¡å™¨ç«¯ç¼–ç¨‹æ¡†æ¶ã€‚ä½¿ç”¨ Netty å¯ä»¥ç¡®ä¿ä½ å¿«é€Ÿå’Œç®€å•åœ°å¼€å‘å‡ºä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œä¾‹å¦‚å®ç°äº†æŸç§åè®®çš„å®¢æˆ·ï¼ŒæœåŠ¡ç«¯åº”ç”¨ã€‚Netty ç›¸å½“ç®€åŒ–å’Œæµçº¿åŒ–äº†ç½‘ç»œåº”ç”¨çš„ç¼–ç¨‹å¼€å‘è¿‡ç¨‹ï¼Œä¾‹å¦‚ï¼ŒTCP å’Œ UDP çš„ socket æœåŠ¡å¼€å‘ã€‚
>
> ï¼ˆä»¥ä¸Šæ‘˜è‡ªç™¾åº¦ç™¾ç§‘ï¼‰ã€‚

Netty å…·æœ‰å¦‚ä¸‹ç‰¹æ€§( æ‘˜è‡ªã€ŠNetty in Actionã€‹ )

| åˆ†ç±»     | Nettyçš„ç‰¹æ€§                                                  |
| :------- | :----------------------------------------------------------- |
| è®¾è®¡     | 1. ç»Ÿä¸€çš„ API ï¼Œæ”¯æŒå¤šç§ä¼ è¾“ç±»å‹( é˜»å¡å’Œéé˜»å¡çš„ ) 2. ç®€å•è€Œå¼ºå¤§çš„çº¿ç¨‹æ¨¡å‹ 3. çœŸæ­£çš„æ— è¿æ¥æ•°æ®æŠ¥å¥—æ¥å­—( UDP )æ”¯æŒ 4. è¿æ¥é€»è¾‘ç»„ä»¶( ChannelHander ä¸­é¡ºåºå¤„ç†æ¶ˆæ¯ )ä»¥åŠç»„ä»¶å¤ç”¨( ä¸€ä¸ª ChannelHandel å¯ä»¥è¢«å¤šä¸ªChannelPipeLine å¤ç”¨ ) |
| æ˜“äºä½¿ç”¨ | 1. è¯¦å®çš„ Javadoc å’Œå¤§é‡çš„ç¤ºä¾‹é›† 2. ä¸éœ€è¦è¶…è¿‡ JDK 1.6+ çš„ä¾èµ– |
| æ€§èƒ½     | æ‹¥æœ‰æ¯” Java çš„æ ¸å¿ƒ API æ›´é«˜çš„ååé‡ä»¥åŠæ›´ä½çš„å»¶è¿Ÿ( å¾—ç›Šäºæ± åŒ–å’Œå¤ç”¨ )ï¼Œæ›´ä½çš„èµ„æºæ¶ˆè€—ä»¥åŠæœ€å°‘çš„å†…å­˜å¤åˆ¶ |
| å¥å£®æ€§   | 1. ä¸ä¼šå› ä¸ºæ…¢é€Ÿã€å¿«é€Ÿæˆ–è€…è¶…è½½çš„è¿æ¥è€Œå¯¼è‡´ OutOfMemoryError 2. æ¶ˆé™¤åœ¨é«˜é€Ÿç½‘ç»œä¸­ NIO åº”ç”¨ç¨‹åºå¸¸è§çš„ä¸å…¬å¹³è¯» / å†™æ¯”ç‡ |
| å®‰å…¨æ€§   | å®Œæ•´çš„ SSL/TLS ä»¥åŠ StartTLs æ”¯æŒï¼Œå¯ç”¨äºå—é™ç¯å¢ƒä¸‹ï¼Œå¦‚ Applet å’Œ OSGI |
| ç¤¾åŒºé©±åŠ¨ | å‘å¸ƒå¿«é€Ÿè€Œä¸”é¢‘ç¹                                             |

## ä¸ºä»€ä¹ˆé€‰æ‹© Netty ï¼Ÿ

- **ä½¿ç”¨ç®€å•**ï¼šAPI ä½¿ç”¨ç®€å•ï¼Œå¼€å‘é—¨æ§›ä½ã€‚
- **åŠŸèƒ½å¼ºå¤§**ï¼šé¢„ç½®äº†å¤šç§ç¼–è§£ç åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ä¸»æµåè®®ã€‚
- **å®šåˆ¶èƒ½åŠ›å¼º**ï¼šå¯ä»¥é€šè¿‡ ChannelHandler å¯¹é€šä¿¡æ¡†æ¶è¿›è¡Œçµæ´»çš„æ‰©å±•ã€‚
- **æ€§èƒ½é«˜**ï¼šé€šè¿‡ä¸å…¶å®ƒä¸šç•Œä¸»æµçš„ NIO æ¡†æ¶å¯¹æ¯”ï¼ŒNetty çš„ç»¼åˆæ€§èƒ½æœ€ä¼˜ã€‚
- **æˆç†Ÿç¨³å®š**ï¼šNetty ä¿®å¤äº†å·²ç»å‘ç°çš„æ‰€æœ‰ JDK NIO BUGï¼Œä¸šåŠ¡å¼€å‘äººå‘˜ä¸éœ€è¦å†ä¸º NIO çš„ BUG è€Œçƒ¦æ¼ã€‚
- **ç¤¾åŒºæ´»è·ƒ**ï¼šç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œå‘ç°çš„BUGå¯ä»¥è¢«åŠæ—¶ä¿®å¤ï¼ŒåŒæ—¶ï¼Œæ›´å¤šçš„æ–°åŠŸèƒ½ä¼šè¢«åŠ å…¥ã€‚
- **æ¡ˆä¾‹ä¸°å¯Œ**ï¼šç»å†äº†å¤§è§„æ¨¡çš„å•†ä¸šåº”ç”¨è€ƒéªŒï¼Œè´¨é‡å·²ç»å¾—åˆ°éªŒè¯ã€‚åœ¨äº’è”ç½‘ã€å¤§æ•°æ®ã€ç½‘ç»œæ¸¸æˆã€ä¼ä¸šåº”ç”¨ã€ç”µä¿¡è½¯ä»¶ç­‰ä¼—å¤šè¡Œä¸šå¾—åˆ°æˆåŠŸå•†ç”¨ï¼Œè¯æ˜äº†å®ƒå¯ä»¥å®Œå…¨æ»¡è¶³ä¸åŒè¡Œä¸šçš„å•†ä¸šåº”ç”¨ã€‚

å®é™…ä¸Šï¼Œè¿™ä¸ªä¹Ÿæ˜¯æˆ‘ä»¬åšæŠ€æœ¯é€‰å‹çš„ä¸€äº›å‚è€ƒç‚¹ï¼Œä¸ä»…ä»…é€‚ç”¨äº Netty ï¼Œä¹ŸåŒæ ·é€‚ç”¨äºå…¶ä»–æŠ€æœ¯æ ˆã€‚å½“ç„¶ï¼ŒğŸ˜ˆ é¢è¯•éƒ½å¯ä»¥é…±ç´«å›ç­”ï¼Œæ˜¾å¾—å¾ˆé«˜ç«¯ã€‚

## ä¸ºä»€ä¹ˆè¯´ Netty ä½¿ç”¨ç®€å•ï¼Ÿ

ğŸ¦… æˆ‘ä»¬å‡è®¾è¦æ­å»ºä¸€ä¸ª Server æœåŠ¡å™¨ï¼Œä½¿ç”¨ **Java NIO çš„æ­¥éª¤**å¦‚ä¸‹ï¼š

1. åˆ›å»º ServerSocketChannel ã€‚
   * ç»‘å®šç›‘å¬ç«¯å£ï¼Œå¹¶é…ç½®ä¸ºéé˜»å¡æ¨¡å¼ã€‚

2. åˆ›å»º Selectorï¼Œå°†ä¹‹å‰åˆ›å»ºçš„ ServerSocketChannel æ³¨å†Œåˆ° Selector ä¸Šï¼Œç›‘å¬ SelectionKey.OP_ACCEPT ã€‚
   * å¾ªç¯æ‰§è¡Œ Selector#select() æ–¹æ³•ï¼Œè½®è¯¢å°±ç»ªçš„ Channelã€‚	

3. è½®è¯¢å°±ç»ªçš„ Channel æ—¶ï¼Œå¦‚æœæ˜¯å¤„äº OP_ACCEPT çŠ¶æ€ï¼Œè¯´æ˜æ˜¯æ–°çš„å®¢æˆ·ç«¯æ¥å…¥ï¼Œè°ƒç”¨ServerSocketChannel#accept() æ–¹æ³•ï¼Œæ¥æ”¶æ–°çš„å®¢æˆ·ç«¯ã€‚

   * è®¾ç½®æ–°æ¥å…¥çš„ SocketChannel ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¹¶æ³¨å†Œåˆ° Selector ä¸Šï¼Œç›‘å¬ OP_READ ã€‚


4. å¦‚æœè½®è¯¢çš„ Channel çŠ¶æ€æ˜¯ OP_READ ï¼Œè¯´æ˜æœ‰æ–°çš„å°±ç»ªæ•°æ®åŒ…éœ€è¦è¯»å–ï¼Œåˆ™æ„é€  ByteBuffer å¯¹è±¡ï¼Œè¯»å–æ•°æ®ã€‚
   * è¿™é‡Œï¼Œè§£ç æ•°æ®åŒ…çš„è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ã€‚

> è‰¿è‰¿ï¼šæ³¨æ„å™¢ï¼Œä¸Šè¿°æ­¥éª¤è¿˜æ˜¯æœ€ç®€çš„ Java NIO å¯åŠ¨æ­¥éª¤ï¼Œä¸åŒ…æ‹¬**å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹**å™¢ï¼å¯èƒ½æœ‰èƒ–å‹ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ Reactor æ¨¡å‹ï¼Œåœ¨ [ã€Œä»€ä¹ˆæ˜¯ Reactor æ¨¡å‹ï¼Ÿã€](http://svip.iocoder.cn/Netty/Interview/#) é—®é¢˜ä¸­ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è§£é‡Šã€‚

ğŸ¦… ä½¿ç”¨ **Netty çš„æ­¥éª¤**å¦‚ä¸‹ï¼š

1. åˆ›å»º NIO çº¿ç¨‹ç»„ EventLoopGroup å’Œ ServerBootstrapã€‚
   - è®¾ç½® ServerBootstrap çš„å±æ€§ï¼šçº¿ç¨‹ç»„ã€SO_BACKLOG é€‰é¡¹ï¼Œè®¾ç½® NioServerSocketChannel ä¸º Channel
   - è®¾ç½®ä¸šåŠ¡å¤„ç† Handler å’Œ ç¼–è§£ç å™¨ Codec ã€‚
   - ç»‘å®šç«¯å£ï¼Œå¯åŠ¨æœåŠ¡å™¨ç¨‹åºã€‚
2. åœ¨ä¸šåŠ¡å¤„ç† Handler ä¸­ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œå¹¶ç»™å‡ºå“åº”ã€‚

ğŸ¦… é‚£ä¹ˆç›¸æ¯” Java NIOï¼Œä½¿ç”¨ Netty å¼€å‘ç¨‹åºï¼Œéƒ½**ç®€åŒ–äº†å“ªäº›æ­¥éª¤**å‘¢ï¼Ÿ

1. æ— éœ€å…³å¿ƒ `OP_ACCEPT`ã€`OP_READ`ã€`OP_WRITE` ç­‰ç­‰ **IO æ“ä½œ**ï¼ŒNetty å·²ç»å°è£…ï¼Œå¯¹æˆ‘ä»¬åœ¨ä½¿ç”¨æ˜¯é€æ˜æ— æ„Ÿçš„ã€‚
2. ä½¿ç”¨ boss å’Œ worker EventLoopGroup ï¼ŒNetty ç›´æ¥æä¾›**å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹**ã€‚
3. åœ¨ Netty ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä½¿ç”¨ä¸€ä¸ªè§£ç å™¨ FixedLengthFrameDecoderï¼Œå¯ä»¥ç”¨äºå¤„ç†å®šé•¿æ¶ˆæ¯çš„é—®é¢˜ï¼Œèƒ½å¤Ÿè§£å†³ **TCP ç²˜åŒ…æ‹†åŒ…**é—®é¢˜ï¼Œååˆ†æ–¹ä¾¿ã€‚å¦‚æœä½¿ç”¨ Java NIO ï¼Œéœ€è¦æˆ‘ä»¬è‡ªè¡Œå®ç°è§£ç å™¨ã€‚

------

ğŸ˜ˆ å¦‚æœèƒ–å‹ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨ Java NIO ç¼–å†™ä¸€ä¸ª Server ï¼Œå»ºè®®è‡ªå·±å»å®ç°ä»¥ä¸‹ã€‚
ğŸ˜ˆ å¦‚æœèƒ–å‹æ²¡æœ‰ä½¿ç”¨è¿‡ Netty ç¼–å†™ä¸€ä¸ª Server ï¼Œå»ºè®®å»å…¥é—¨ä¸‹ã€‚

## è¯´è¯´ä¸šåŠ¡ä¸­ Netty çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ

- æ„å»ºé«˜æ€§èƒ½ã€ä½æ—¶å»¶çš„å„ç§ Java ä¸­é—´ä»¶ï¼ŒNetty ä¸»è¦ä½œä¸ºåŸºç¡€é€šä¿¡æ¡†æ¶æä¾›é«˜æ€§èƒ½ã€ä½æ—¶å»¶çš„é€šä¿¡æœåŠ¡ã€‚ä¾‹å¦‚ï¼š
  - RocketMQ ï¼Œåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‚
  - Dubbo ï¼ŒæœåŠ¡è°ƒç”¨æ¡†æ¶ã€‚
  - Spring WebFlux ï¼ŒåŸºäºå“åº”å¼çš„ Web æ¡†æ¶ã€‚
  - HDFS ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚
- å…¬æœ‰æˆ–è€…ç§æœ‰åè®®æ ˆçš„åŸºç¡€é€šä¿¡æ¡†æ¶ï¼Œä¾‹å¦‚å¯ä»¥åŸºäº Netty æ„å»ºå¼‚æ­¥ã€é«˜æ€§èƒ½çš„ WebSocketã€Protobuf ç­‰åè®®çš„æ”¯æŒã€‚
- å„é¢†åŸŸåº”ç”¨ï¼Œä¾‹å¦‚å¤§æ•°æ®ã€æ¸¸æˆç­‰ï¼ŒNetty ä½œä¸ºé«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶ç”¨äºå†…éƒ¨å„æ¨¡å—çš„æ•°æ®åˆ†å‘ã€ä¼ è¾“å’Œæ±‡æ€»ç­‰ï¼Œå®ç°æ¨¡å—ä¹‹é—´é«˜æ€§èƒ½é€šä¿¡ã€‚

## è¯´è¯´ Netty å¦‚ä½•å®ç°é«˜æ€§èƒ½ï¼Ÿ

1. **çº¿ç¨‹æ¨¡å‹** ï¼šæ›´åŠ ä¼˜é›…çš„ Reactor æ¨¡å¼å®ç°ã€çµæ´»çš„çº¿ç¨‹æ¨¡å‹ã€åˆ©ç”¨ EventLoop ç­‰åˆ›æ–°æ€§çš„æœºåˆ¶ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆåœ°ç®¡ç†æˆç™¾ä¸Šåƒçš„ Channel ã€‚

2. **å†…å­˜æ± è®¾è®¡** ï¼šä½¿ç”¨æ± åŒ–çš„ Direct Buffer ç­‰æŠ€æœ¯ï¼Œåœ¨æé«˜ IO æ€§èƒ½çš„åŒæ—¶ï¼Œå‡å°‘äº†å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ã€‚å¹¶ä¸”ï¼Œå†…åƒåƒçš„å†…éƒ¨å®ç°æ˜¯ç”¨ä¸€é¢—äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ›´å¥½çš„ç®¡ç†å†…å­˜åˆ†é…æƒ…å†µã€‚

3. **å†…å­˜é›¶æ‹·è´** ï¼šä½¿ç”¨ Direct Buffer ï¼Œå¯ä»¥ä½¿ç”¨ Zero-Copy æœºåˆ¶ã€‚

   > Zero-Copy ï¼Œåœ¨æ“ä½œæ•°æ®æ—¶ï¼Œä¸éœ€è¦å°†æ•°æ® Buffer ä»ä¸€ä¸ªå†…å­˜åŒºåŸŸæ‹·è´åˆ°å¦ä¸€ä¸ªå†…å­˜åŒºåŸŸã€‚å› ä¸ºå°‘äº†ä¸€æ¬¡å†…å­˜çš„æ‹·è´ï¼Œå› æ­¤ CPU çš„æ•ˆç‡å°±å¾—åˆ°çš„æå‡ã€‚

4. **åè®®æ”¯æŒ** ï¼šæä¾›å¯¹ Protobuf ç­‰é«˜æ€§èƒ½åºåˆ—åŒ–åè®®æ”¯æŒã€‚

5. ä½¿ç”¨æ›´å¤šæœ¬åœ°ä»£ç 

   ã€‚ä¾‹å¦‚ï¼š

   - ç›´æ¥åˆ©ç”¨ JNI è°ƒç”¨ Open SSL ç­‰æ–¹å¼ï¼Œè·å¾—æ¯” Java å†…å»º SSL å¼•æ“æ›´å¥½çš„æ€§èƒ½ã€‚
   - åˆ©ç”¨ JNI æä¾›äº† Native Socket Transport ï¼Œåœ¨ä½¿ç”¨ Epoll edge-triggered çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æœ‰ä¸€å®šçš„æ€§èƒ½æå‡ã€‚

6. å…¶å®ƒï¼š

   - åˆ©ç”¨åå°„ç­‰æŠ€æœ¯ç›´æ¥æ“çºµ SelectionKey ï¼Œä½¿ç”¨æ•°ç»„è€Œä¸æ˜¯ Java å®¹å™¨ç­‰ã€‚
   - å®ç° [FastThreadLocal](https://segmentfault.com/a/1190000012926809) ç±»ï¼Œå½“è¯·æ±‚é¢‘ç¹æ—¶ï¼Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½ã€‚
   - â€¦.

å¦å¤–ï¼Œæ¨èé˜…è¯»ç™½è¡£å¤§å¤§çš„ä¸¤ç¯‡æ–‡ç« ï¼š

1. [ã€ŠNettyé«˜æ€§èƒ½ç¼–ç¨‹å¤‡å¿˜å½•(ä¸Š)ã€‹](http://calvin1978.blogcn.com/articles/netty-performance.html)
2. [ã€ŠNettyé«˜æ€§èƒ½ç¼–ç¨‹å¤‡å¿˜å½•ï¼ˆä¸‹ï¼‰ã€‹](http://calvin1978.blogcn.com/articles/netty-performance2.html)

> ä¸‹é¢ä¸‰è¿é—®ï¼
>
> Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ã€é«˜å¯é çš„ã€å¯æ‰©å±•çš„å¼‚æ­¥é€šä¿¡æ¡†æ¶ï¼Œé‚£ä¹ˆé«˜æ€§èƒ½ã€é«˜å¯é ã€å¯æ‰©å±•è®¾è®¡ä½“ç°åœ¨å“ªé‡Œå‘¢ï¼Ÿ

## Netty çš„é«˜æ€§èƒ½å¦‚ä½•ä½“ç°ï¼Ÿ

> è¿™ä¸ªé—®é¢˜ï¼Œå’Œ [ã€Œè¯´è¯´ Netty å¦‚ä½•å®ç°é«˜æ€§èƒ½ï¼Ÿã€](http://svip.iocoder.cn/Netty/Interview/#) é—®é¢˜ï¼Œä¼šæœ‰ç‚¹é‡å ã€‚æ²¡äº‹ï¼Œåæ­£ç†è§£å°±å¥½ï¼Œä¹ŸèƒŒä¸ä¸‹æ¥ã€‚å“ˆå“ˆå“ˆå“ˆã€‚

æ€§èƒ½æ˜¯è®¾è®¡å‡ºæ¥çš„ï¼Œè€Œä¸æ˜¯æµ‹è¯•å‡ºæ¥çš„ã€‚é‚£ä¹ˆï¼ŒNetty çš„æ¶æ„è®¾è®¡æ˜¯å¦‚ä½•å®ç°é«˜æ€§èƒ½çš„å‘¢ï¼Ÿ

1. **çº¿ç¨‹æ¨¡å‹** ï¼šé‡‡ç”¨å¼‚æ­¥éé˜»å¡çš„ I/O ç±»åº“ï¼ŒåŸºäº Reactor æ¨¡å¼å®ç°ï¼Œè§£å†³äº†ä¼ ç»ŸåŒæ­¥é˜»å¡ I/O æ¨¡å¼ä¸‹æœåŠ¡ç«¯æ— æ³•å¹³æ»‘å¤„ç†å®¢æˆ·ç«¯çº¿æ€§å¢é•¿çš„é—®é¢˜ã€‚

2. **å †å¤–å†…å­˜** ï¼šTCP æ¥æ”¶å’Œå‘é€ç¼“å†²åŒºé‡‡ç”¨ç›´æ¥å†…å­˜ä»£æ›¿å †å†…å­˜ï¼Œé¿å…äº†å†…å­˜å¤åˆ¶ï¼Œæå‡äº† I/O è¯»å–å’Œå†™å…¥æ€§èƒ½ã€‚

3. **å†…å­˜æ± è®¾è®¡** ï¼šæ”¯æŒé€šè¿‡å†…å­˜æ± çš„æ–¹å¼å¾ªç¯åˆ©ç”¨ ByteBufï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ ByteBuf å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚

4. **å‚æ•°é…ç½®** ï¼šå¯é…ç½®çš„ I/O çº¿ç¨‹æ•°ç›®å’Œ TCP å‚æ•°ç­‰ï¼Œä¸ºä¸åŒç”¨æˆ·æä¾›å®šåˆ¶åŒ–çš„è°ƒä¼˜å‚æ•°ï¼Œæ»¡è¶³ä¸åŒçš„æ€§èƒ½åœºæ™¯ã€‚

5. **é˜Ÿåˆ—ä¼˜åŒ–** ï¼šé‡‡ç”¨ç¯å½¢æ•°ç»„ç¼“å†²åŒºï¼Œå®ç°æ— é”åŒ–å¹¶å‘ç¼–ç¨‹ï¼Œä»£æ›¿ä¼ ç»Ÿçš„çº¿ç¨‹å®‰å…¨å®¹å™¨æˆ–é”ã€‚

6. **å¹¶å‘èƒ½åŠ›** ï¼šåˆç†ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨ã€åŸå­ç±»ç­‰ï¼Œæå‡ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ã€‚

7. **é™ä½é”ç«äº‰** ï¼šå…³é”®èµ„æºçš„ä½¿ç”¨é‡‡ç”¨å•çº¿ç¨‹ä¸²è¡ŒåŒ–çš„æ–¹å¼ï¼Œé¿å…å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å¸¦æ¥çš„é”ç«äº‰å’Œé¢å¤–çš„ CPU èµ„æºæ¶ˆè€—é—®é¢˜ã€‚

8. å†…å­˜æ³„éœ²æ£€æµ‹

    

   ï¼šé€šè¿‡å¼•ç”¨è®¡æ•°å™¨åŠæ—¶åœ°é‡Šæ”¾ä¸å†è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œç»†ç²’åº¦çš„å†…å­˜ç®¡ç†é™ä½äº† GC çš„é¢‘ç‡ï¼Œå‡å°‘é¢‘ç¹ GC å¸¦æ¥çš„æ—¶å»¶å¢å¤§å’Œ CPU æŸè€—ã€‚

   - [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆä¸‰ï¼‰å†…å­˜æ³„éœ²æ£€æµ‹ã€‹](http://svip.iocoder.cn/Netty/ByteBuf-1-3-ByteBuf-resource-leak-detector/)

## Netty çš„é«˜å¯é å¦‚ä½•ä½“ç°ï¼Ÿ

1. é“¾è·¯æœ‰æ•ˆæ€§æ£€æµ‹

   ï¼šç”±äºé•¿è¿æ¥ä¸éœ€è¦æ¯æ¬¡å‘é€æ¶ˆæ¯éƒ½åˆ›å»ºé“¾è·¯ï¼Œä¹Ÿä¸éœ€è¦åœ¨æ¶ˆæ¯å®Œæˆäº¤äº’æ—¶å…³é—­é“¾è·¯ï¼Œå› æ­¤ç›¸å¯¹äºçŸ­è¿æ¥æ€§èƒ½æ›´é«˜ã€‚ä¸ºäº†ä¿è¯é•¿è¿æ¥çš„é“¾è·¯æœ‰æ•ˆæ€§ï¼Œå¾€å¾€éœ€è¦é€šè¿‡å¿ƒè·³æœºåˆ¶å‘¨æœŸæ€§åœ°è¿›è¡Œé“¾è·¯æ£€æµ‹ã€‚ä½¿ç”¨å¿ƒè·³æœºåˆ¶çš„åŸå› æ˜¯ï¼Œé¿å…åœ¨ç³»ç»Ÿç©ºé—²æ—¶å› ç½‘ç»œé—ªæ–­è€Œæ–­å¼€è¿æ¥ï¼Œä¹‹ååˆé‡åˆ°æµ·é‡ä¸šåŠ¡å†²å‡»å¯¼è‡´æ¶ˆæ¯ç§¯å‹æ— æ³•å¤„ç†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å‘¨æœŸæ€§åœ°å¯¹é“¾è·¯è¿›è¡Œæœ‰æ•ˆæ€§æ£€æµ‹ï¼Œä¸€æ—¦å‘ç°é—®é¢˜ï¼Œå¯ä»¥åŠæ—¶å…³é—­é“¾è·¯ï¼Œé‡å»º TCP è¿æ¥ã€‚ä¸ºäº†æ”¯æŒå¿ƒè·³ï¼ŒNetty æä¾›äº†ä¸¤ç§é“¾è·¯ç©ºé—²æ£€æµ‹æœºåˆ¶ï¼š

   - è¯»ç©ºé—²è¶…æ—¶æœºåˆ¶ï¼šè¿ç»­ T å‘¨æœŸæ²¡æœ‰æ¶ˆæ¯å¯è¯»æ—¶ï¼Œå‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œè¿›è¡Œé“¾è·¯æ£€æµ‹ã€‚å¦‚æœè¿ç»­ N ä¸ªå‘¨æœŸæ²¡æœ‰è¯»å–åˆ°å¿ƒè·³æ¶ˆæ¯ï¼Œå¯ä»¥ä¸»åŠ¨å…³é—­é“¾è·¯ï¼Œé‡å»ºè¿æ¥ã€‚
   - å†™ç©ºé—²è¶…æ—¶æœºåˆ¶ï¼šè¿ç»­ T å‘¨æœŸæ²¡æœ‰æ¶ˆæ¯éœ€è¦å‘é€æ—¶ï¼Œå‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œè¿›è¡Œé“¾è·¯æ£€æµ‹ã€‚å¦‚æœè¿ç»­ N ä¸ªå‘¨æœŸæ²¡æœ‰è¯»å–å¯¹æ–¹å‘å›çš„å¿ƒè·³æ¶ˆæ¯ï¼Œå¯ä»¥ä¸»åŠ¨å…³é—­é“¾è·¯ï¼Œé‡å»ºè¿æ¥ã€‚
   - [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelHandlerï¼ˆäº”ï¼‰ä¹‹ IdleStateHandlerã€‹](http://svip.iocoder.cn/Netty/ChannelHandler-5-idle/)

2. å†…å­˜ä¿æŠ¤æœºåˆ¶

   ï¼šNetty æä¾›å¤šç§æœºåˆ¶å¯¹å†…å­˜è¿›è¡Œä¿æŠ¤ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

   - é€šè¿‡å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨å¯¹ ByteBuf è¿›è¡Œç»†ç²’åº¦çš„å†…å­˜ç”³è¯·å’Œé‡Šæ”¾ï¼Œå¯¹éæ³•çš„å¯¹è±¡å¼•ç”¨è¿›è¡Œæ£€æµ‹å’Œä¿æŠ¤ã€‚
   - å¯è®¾ç½®çš„å†…å­˜å®¹é‡ä¸Šé™ï¼ŒåŒ…æ‹¬ ByteBufã€çº¿ç¨‹æ± çº¿ç¨‹æ•°ç­‰ï¼Œé¿å…å¼‚å¸¸è¯·æ±‚è€—å…‰å†…å­˜ã€‚

3. ä¼˜é›…åœæœº

   ï¼šä¼˜é›…åœæœºåŠŸèƒ½æŒ‡çš„æ˜¯å½“ç³»ç»Ÿæ¨å‡ºæ—¶ï¼ŒJVM é€šè¿‡æ³¨å†Œçš„ Shutdown Hook æ‹¦æˆªåˆ°é€€å‡ºä¿¡å·é‡ï¼Œç„¶åæ‰§è¡Œæ¨å‡ºæ“ä½œï¼Œé‡Šæ”¾ç›¸å…³æ¨¡å—çš„èµ„æºå ç”¨ï¼Œå°†ç¼“å†²åŒºçš„æ¶ˆæ¯å¤„ç†å®Œæˆæˆ–æ¸…ç©ºï¼Œå°†å¾…åˆ·æ–°çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜å’Œæ•°æ®åº“ä¸­ï¼Œç­‰åˆ°èµ„æºå›æ”¶å’Œç¼“å†²åŒºæ¶ˆæ¯å¤„ç†å®Œæˆä¹‹åï¼Œå†é€€å‡ºã€‚

   - [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆå…«ï¼‰ä¹‹ EventLoop ä¼˜é›…å…³é—­ã€‹](http://svip.iocoder.cn/Netty/EventLoop-8-EventLoop-shutdown/)

## Netty çš„å¯æ‰©å±•å¦‚ä½•ä½“ç°ï¼Ÿ

å¯å®šåˆ¶ã€æ˜“æ‰©å±•ã€‚

- **è´£ä»»é“¾æ¨¡å¼** ï¼šChannelPipeline åŸºäºè´£ä»»é“¾æ¨¡å¼å¼€å‘ï¼Œä¾¿äºä¸šåŠ¡é€»è¾‘çš„æ‹¦æˆªã€å®šåˆ¶å’Œæ‰©å±•ã€‚
- **åŸºäºæ¥å£çš„å¼€å‘** ï¼šå…³é”®çš„ç±»åº“éƒ½æä¾›äº†æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œä¾¿äºç”¨æˆ·è‡ªå®šä¹‰å®ç°ã€‚
- **æä¾›å¤§é‡çš„å·¥å‚ç±»** ï¼šé€šè¿‡é‡è½½è¿™äº›å·¥å‚ç±»ï¼Œå¯ä»¥æŒ‰éœ€åˆ›å»ºå‡ºç”¨æˆ·éœ€è¦çš„å¯¹è±¡ã€‚
- **æä¾›å¤§é‡ç³»ç»Ÿå‚æ•°** ï¼šä¾›ç”¨æˆ·æŒ‰éœ€è®¾ç½®ï¼Œå¢å¼ºç³»ç»Ÿçš„åœºæ™¯å®šåˆ¶æ€§ã€‚

------

> è‰¿è‰¿ï¼šè¯´ä¸ªé¢˜å¤–è¯ã€‚
>
> å®é™…ä¸Šï¼Œä»»ä½•çš„æŠ€æœ¯çš„ç ”ç©¶ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å»æ€è€ƒï¼Œå®ƒçš„é«˜æ€§èƒ½æ˜¯æ€ä¹ˆä½“ç°çš„ï¼Œå®ƒçš„å¯é æ€§æ˜¯æ€ä¹ˆä½“ç°çš„ï¼Œå®ƒçš„å¯æ‹“å±•æ˜¯æ€ä¹ˆä½“ç°çš„ã€‚
>
> å½“ç„¶ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æœ‰è¿‘ä¹‰è¯ï¼Œæ‰€ä»¥ï¼š
>
> - é«˜æ€§èƒ½ => é«˜å¹¶å‘
> - å¯é æ€§ => é«˜å¯ç”¨
> - å¯æ‹“å±• => é«˜æ‹“å±•
>
> ä¾‹å¦‚è¯´ï¼ŒMySQL å¦‚ä½•å®ç°é«˜æ€§èƒ½ï¼ŒMySQL å¦‚ä½•æ­å»ºé«˜å¯ç”¨ï¼ŒğŸ˜ˆ MySQL å¦‚ä½•åšæ‹“å±•è²Œä¼¼æš‚æ—¶æ²¡ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚

## ç®€å•ä»‹ç» Netty çš„æ ¸å¿ƒç»„ä»¶ï¼Ÿ

Netty æœ‰å¦‚ä¸‹å…­ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

- Bootstrap & ServerBootstrap
- Channel
- ChannelFuture
- EventLoop & EventLoopGroup
- ChannelHandler
- ChannelPipeline

è¯¦ç»†çš„ï¼Œè¯·ç›´æ¥é˜…è¯» [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” Netty ç®€ä»‹ï¼ˆäºŒï¼‰ä¹‹æ ¸å¿ƒç»„ä»¶ã€‹](http://svip.iocoder.cn/Netty/intro-2/) ä¸€æ–‡ã€‚

## è¯´è¯´ Netty çš„é€»è¾‘æ¶æ„ï¼Ÿ

Netty é‡‡ç”¨äº†å…¸å‹çš„**ä¸‰å±‚ç½‘ç»œæ¶æ„**è¿›è¡Œè®¾è®¡å’Œå¼€å‘ï¼Œå…¶é€»è¾‘æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Netty é€»è¾‘æ¶æ„å›¾](http://static.iocoder.cn/85d98e3cb0e6e39f80d02234e039a4dd)

> è‰¿è‰¿ï¼šæ³¨æ„ï¼Œè¿™ä¸ªå›¾æ˜¯è‡ªä¸‹å‘ä¸Šçœ‹ã€‚å“ˆå“ˆå“ˆ~

1. **Reactor é€šä¿¡è°ƒåº¦å±‚**ï¼šç”±ä¸€ç³»åˆ—è¾…åŠ©ç±»ç»„æˆï¼ŒåŒ…æ‹¬ Reactor çº¿ç¨‹ NioEventLoop åŠå…¶çˆ¶ç±»ï¼ŒNioSocketChannel å’Œ NioServerSocketChannel ç­‰ç­‰ã€‚è¯¥å±‚çš„èŒè´£å°±æ˜¯ç›‘å¬ç½‘ç»œçš„è¯»å†™å’Œè¿æ¥æ“ä½œï¼Œè´Ÿè´£å°†ç½‘ç»œå±‚çš„æ•°æ®è¯»åˆ°å†…å­˜ç¼“å†²åŒºï¼Œç„¶åè§¦å‘å„è‡ªç½‘ç»œäº‹ä»¶ï¼Œä¾‹å¦‚è¿æ¥åˆ›å»ºã€è¿æ¥æ¿€æ´»ã€è¯»äº‹ä»¶ã€å†™äº‹ä»¶ç­‰ã€‚å°†è¿™äº›äº‹ä»¶è§¦å‘åˆ° pipeline ä¸­ï¼Œç”± pipeline ç®¡ç†çš„èŒè´£é“¾æ¥è¿›è¡Œåç»­çš„å¤„ç†ã€‚
2. **èŒè´£é“¾ ChannelPipeline**ï¼šè´Ÿè´£äº‹ä»¶åœ¨èŒè´£é“¾ä¸­çš„æœ‰åºä¼ æ’­ï¼Œä»¥åŠè´Ÿè´£åŠ¨æ€åœ°ç¼–æ’èŒè´£é“¾ã€‚èŒè´£é“¾å¯ä»¥é€‰æ‹©ç›‘å¬å’Œå¤„ç†è‡ªå·±å…³å¿ƒçš„äº‹ä»¶ï¼Œæ‹¦æˆªå¤„ç†å’Œå‘åä¼ æ’­äº‹ä»¶ã€‚
3. **ä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚**ï¼šä¸šåŠ¡é€»è¾‘ç¼–æ’å±‚é€šå¸¸æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯çº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’ï¼Œä¸€ç±»æ˜¯åº”ç”¨å±‚åè®®æ’ä»¶ï¼Œç”¨äºç‰¹å®šåè®®ç›¸å…³çš„ä¼šè¯å’Œé“¾è·¯ç®¡ç†ã€‚ç”±äºåº”ç”¨å±‚åè®®æ ˆå¾€å¾€æ˜¯å¼€å‘ä¸€æ¬¡åˆ°å¤„è¿è¡Œï¼Œå¹¶ä¸”å˜åŠ¨è¾ƒå°ï¼Œæ•…è€Œå°†åº”ç”¨åè®®åˆ° POJO çš„è½¬å˜å’Œä¸Šå±‚ä¸šåŠ¡æ”¾åˆ°ä¸åŒçš„ ChannelHandler ä¸­ï¼Œå°±å¯ä»¥å®ç°åè®®å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚çš„éš”ç¦»ï¼Œå®ç°æ¶æ„å±‚é¢çš„åˆ†å±‚éš”ç¦»ã€‚

## ä»€ä¹ˆæ˜¯ Reactor æ¨¡å‹ï¼Ÿ

ç›´æ¥é˜…è¯» [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸€ï¼‰ä¹‹ Reactor æ¨¡å‹ã€‹](http://svip.iocoder.cn/Netty/EventLoop-1-Reactor-Model/) ä¸€æ–‡ã€‚

è®¤çœŸä»”ç»†è¯»ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜é¢‘é¢è¯•é¢˜ã€‚

## è¯·ä»‹ç» Netty çš„çº¿ç¨‹æ¨¡å‹ï¼Ÿ

è¿˜æ˜¯é˜…è¯» [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸€ï¼‰ä¹‹ Reactor æ¨¡å‹ã€‹](http://svip.iocoder.cn/Netty/EventLoop-1-Reactor-Model/) ä¸€æ–‡ã€‚

è®¤çœŸä»”ç»†è¯»ï¼Œè¿™çœŸçš„çœŸçš„çœŸçš„æ˜¯ä¸€ä¸ªé«˜é¢‘é¢è¯•é¢˜ã€‚

## ä»€ä¹ˆæ˜¯ä¸šåŠ¡çº¿ç¨‹æ± ï¼Ÿ

ğŸ¦… **é—®é¢˜**

åœ¨ [ã€Œä»€ä¹ˆæ˜¯ Reactor æ¨¡å‹ï¼Ÿã€](http://svip.iocoder.cn/Netty/Interview/#) é—®é¢˜ä¸­ï¼Œæ— è®ºæ˜¯é‚£ç§ç±»å‹çš„ Reactor æ¨¡å‹ï¼Œéƒ½éœ€è¦åœ¨ Reactor æ‰€åœ¨çš„çº¿ç¨‹ä¸­ï¼Œè¿›è¡Œè¯»å†™æ“ä½œã€‚é‚£ä¹ˆæ­¤æ—¶å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬è¯»å–åˆ°æ•°æ®ï¼Œéœ€è¦è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¹¶ä¸”è¿™ä¸ªä¸šåŠ¡é€»è¾‘éœ€è¦å¯¹æ•°æ®åº“ã€ç¼“å­˜ç­‰ç­‰è¿›è¡Œæ“ä½œï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå‡è®¾è¿™ä¸ªæ•°æ®åº“æ“ä½œéœ€è¦ 5 ms ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ª Reactor çº¿ç¨‹åœ¨è¿™ 5 ms æ— æ³•è¿›è¡Œæ³¨å†Œåœ¨è¿™ä¸ª Reactor çš„ Channel è¿›è¡Œè¯»å†™æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šä¸ª Channel çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½å˜æˆäº†ä¸²è¡Œã€‚åŠ¿å¿…ï¼Œè¿™æ ·çš„æ•ˆç‡ä¼šéå¸¸éå¸¸éå¸¸çš„ä½ã€‚

ğŸ¦… **è§£å†³**

é‚£ä¹ˆæ€ä¹ˆè§£å†³å‘¢ï¼Ÿåˆ›å»ºä¸šåŠ¡çº¿ç¨‹æ± ï¼Œå°†è¯»å–åˆ°çš„æ•°æ®ï¼Œæäº¤åˆ°ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è¿›è¡Œå¤„ç†ã€‚è¿™æ ·ï¼ŒReactor çš„ Channel å°±ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œ Channel çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½å˜æˆäº†å¹¶è¡Œäº†ã€‚

ğŸ¦… **æ¡ˆä¾‹**

å¦‚æœèƒ–å‹ç†Ÿæ‚‰ Dubbo æ¡†æ¶ï¼Œå°±ä¼šå‘ç° [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html) ã€‚ğŸ˜ˆ è®¤çœŸè¯»ä¸‹ï¼Œå¯ä»¥è·Ÿé¢è¯•å®˜å¹ä¸€å¹å•¦ã€‚

## TCP ç²˜åŒ… / æ‹†åŒ…çš„åŸå› ï¼Ÿåº”è¯¥è¿™ä¹ˆè§£å†³ï¼Ÿ

ğŸ¦… **æ¦‚å¿µ**

TCP æ˜¯ä»¥æµçš„æ–¹å¼æ¥å¤„ç†æ•°æ®ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ç²˜åŒ… / æ‹†åŒ…ã€‚

- æ‹†åŒ…ï¼šä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢« TCP æ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ã€‚
- ç²˜åŒ…ï¼šä¹Ÿå¯èƒ½æŠŠå°çš„å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ã€‚

ğŸ¦… **åŸå› **

- åº”ç”¨ç¨‹åºå†™å…¥çš„å­—èŠ‚å¤§å°å¤§äºå¥—æ¥å­—å‘é€ç¼“å†²åŒºçš„å¤§å°ï¼Œä¼šå‘ç”Ÿ**æ‹†åŒ…**ç°è±¡ã€‚è€Œåº”ç”¨ç¨‹åºå†™å…¥æ•°æ®å°äºå¥—æ¥å­—ç¼“å†²åŒºå¤§å°ï¼Œç½‘å¡å°†åº”ç”¨å¤šæ¬¡å†™å…¥çš„æ•°æ®å‘é€åˆ°ç½‘ç»œä¸Šï¼Œè¿™å°†ä¼šå‘ç”Ÿ**ç²˜åŒ…**ç°è±¡ã€‚
- å¾…å‘é€æ•°æ®å¤§äº MSSï¼ˆæœ€å¤§æŠ¥æ–‡é•¿åº¦ï¼‰ï¼ŒTCP åœ¨ä¼ è¾“å‰å°†è¿›è¡Œ**æ‹†åŒ…**ã€‚
- ä»¥å¤ªç½‘å¸§çš„ payloadï¼ˆå‡€è·ï¼‰å¤§äº MTUï¼ˆé»˜è®¤ä¸º 1500 å­—èŠ‚ï¼‰è¿›è¡Œ IP åˆ†ç‰‡**æ‹†åŒ…**ã€‚
- æ¥æ”¶æ•°æ®ç«¯çš„åº”ç”¨å±‚æ²¡æœ‰åŠæ—¶è¯»å–æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå°†å‘ç”Ÿ**ç²˜åŒ…**ã€‚

ğŸ¦… **è§£å†³**

åœ¨ Netty ä¸­ï¼Œæä¾›äº†å¤šä¸ª Decoder è§£æç±»ï¼Œå¦‚ä¸‹ï¼š

- â‘  FixedLengthFrameDecoder ï¼ŒåŸºäº**å›ºå®šé•¿åº¦**æ¶ˆæ¯è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚
- â‘¡ LengthFieldBasedFrameDecoder ï¼ŒåŸºäº**æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦**è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚
- â‘¢ LineBasedFrameDecoder ï¼ŒåŸºäº**æ¢è¡Œ**æ¥è¿›è¡Œæ¶ˆæ¯ç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚
- â‘£ DelimiterBasedFrameDecoder ï¼ŒåŸºäº**æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼**è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚

å®é™…ä¸Šï¼Œä¸Šè¿°å››ä¸ª FrameDecoder å®ç°å¯ä»¥è¿›è¡Œè§„æ•´ï¼š

- â‘  æ˜¯ â‘¡ çš„ç‰¹ä¾‹ï¼Œ**å›ºå®šé•¿åº¦**æ˜¯**æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦**çš„ä¸€ç§å½¢å¼ã€‚
- â‘¢ æ˜¯ â‘£ çš„ç‰¹ä¾‹ï¼Œ**æ¢è¡Œ**æ˜¯äº**æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼**çš„ä¸€ç§å½¢å¼ã€‚

æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ ByteToMessageDecoderï¼ˆä¸€ï¼‰Cumulatorã€‹](http://svip.iocoder.cn/Netty/Codec-1-1-ByteToMessageDecoder-core-impl/)
- [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ ByteToMessageDecoderï¼ˆäºŒï¼‰FrameDecoderã€‹](http://svip.iocoder.cn/Netty/Codec-1-2-ByteToMessageDecoder-FrameDecoder/)

## äº†è§£å“ªå‡ ç§åºåˆ—åŒ–åè®®ï¼Ÿ

ğŸ¦… **æ¦‚å¿µ**

- åºåˆ—åŒ–ï¼ˆç¼–ç ï¼‰ï¼Œæ˜¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶å½¢å¼ï¼ˆå­—èŠ‚æ•°ç»„ï¼‰ï¼Œä¸»è¦ç”¨äºç½‘ç»œä¼ è¾“ã€æ•°æ®æŒä¹…åŒ–ç­‰ã€‚
- ååºåˆ—åŒ–ï¼ˆè§£ç ï¼‰ï¼Œåˆ™æ˜¯å°†ä»ç½‘ç»œã€ç£ç›˜ç­‰è¯»å–çš„å­—èŠ‚æ•°ç»„è¿˜åŸæˆåŸå§‹å¯¹è±¡ï¼Œä¸»è¦ç”¨äºç½‘ç»œä¼ è¾“å¯¹è±¡çš„è§£ç ï¼Œä»¥ä¾¿å®Œæˆè¿œç¨‹è°ƒç”¨ã€‚

ğŸ¦… **é€‰å‹**

åœ¨é€‰æ‹©åºåˆ—åŒ–åè®®çš„é€‰æ‹©ï¼Œä¸»è¦è€ƒè™‘ä»¥ä¸‹ä¸‰ä¸ªå› ç´ ï¼š

- åºåˆ—åŒ–åçš„**å­—èŠ‚å¤§å°**ã€‚æ›´å°‘çš„å­—èŠ‚æ•°ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œå¸¦å®½ã€ç£ç›˜çš„å ç”¨ã€‚
- åºåˆ—åŒ–çš„**æ€§èƒ½**ã€‚å¯¹ CPUã€å†…å­˜èµ„æºå ç”¨æƒ…å†µã€‚
- æ˜¯å¦æ”¯æŒ**è·¨è¯­è¨€**ã€‚ä¾‹å¦‚ï¼Œå¼‚æ„ç³»ç»Ÿçš„å¯¹æ¥å’Œå¼€å‘è¯­è¨€åˆ‡æ¢ã€‚

ğŸ¦… **æ–¹æ¡ˆ**

> å¦‚æœå¯¹åºåˆ—åŒ–å·¥å…·äº†è§£ä¸å¤šçš„èƒ–å‹ï¼Œå¯èƒ½ä¸€çœ‹æœ‰è¿™ä¹ˆå¤šä¼˜ç¼ºç‚¹ä¼šæ¯”è¾ƒæ‡µé€¼ï¼Œå¯ä»¥å…ˆè®°å¾—æœ‰å“ªäº›åºåˆ—åŒ–å·¥å…·ï¼Œç„¶ååœ¨æ…¢æ…¢ç†Ÿæ‚‰å®ƒä»¬çš„ä¼˜ç¼ºç‚¹ã€‚
>
> é‡ç‚¹ï¼Œè¿˜æ˜¯çŸ¥é“ã€**é€‰å‹**ã€‘çš„è€ƒè™‘ç‚¹ã€‚

1. ã€é‡ç‚¹ã€‘Java é»˜è®¤æä¾›çš„åºåˆ—åŒ–

   - æ— æ³•è·¨è¯­è¨€ï¼›åºåˆ—åŒ–åçš„å­—èŠ‚å¤§å°å¤ªå¤§ï¼›åºåˆ—åŒ–çš„æ€§èƒ½å·®ã€‚
2. ã€é‡ç‚¹ã€‘XML ã€‚

   - ä¼˜ç‚¹ï¼šäººæœºå¯è¯»æ€§å¥½ï¼Œå¯æŒ‡å®šå…ƒç´ æˆ–ç‰¹æ€§çš„åç§°ã€‚
   - ç¼ºç‚¹ï¼šåºåˆ—åŒ–æ•°æ®åªåŒ…å«æ•°æ®æœ¬èº«ä»¥åŠç±»çš„ç»“æ„ï¼Œä¸åŒ…æ‹¬ç±»å‹æ ‡è¯†å’Œç¨‹åºé›†ä¿¡æ¯ï¼›åªèƒ½åºåˆ—åŒ–å…¬å…±å±æ€§å’Œå­—æ®µï¼›ä¸èƒ½åºåˆ—åŒ–æ–¹æ³•ï¼›æ–‡ä»¶åºå¤§ï¼Œæ–‡ä»¶æ ¼å¼å¤æ‚ï¼Œä¼ è¾“å å¸¦å®½ã€‚
   - é€‚ç”¨åœºæ™¯ï¼šå½“åšé…ç½®æ–‡ä»¶å­˜å‚¨æ•°æ®ï¼Œå®æ—¶æ•°æ®è½¬æ¢ã€‚
3. ã€é‡ç‚¹ã€‘JSON ï¼Œæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚

   - ä¼˜ç‚¹ï¼šå…¼å®¹æ€§é«˜ã€æ•°æ®æ ¼å¼æ¯”è¾ƒç®€å•ï¼Œæ˜“äºè¯»å†™ã€åºåˆ—åŒ–åæ•°æ®è¾ƒå°ï¼Œå¯æ‰©å±•æ€§å¥½ï¼Œå…¼å®¹æ€§å¥½ã€‚ä¸ XML ç›¸æ¯”ï¼Œå…¶åè®®æ¯”è¾ƒç®€å•ï¼Œè§£æé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚
   - ç¼ºç‚¹ï¼šæ•°æ®çš„æè¿°æ€§æ¯” XML å·®ã€ä¸é€‚åˆæ€§èƒ½è¦æ±‚ä¸º ms çº§åˆ«çš„æƒ…å†µã€é¢å¤–ç©ºé—´å¼€é”€æ¯”è¾ƒå¤§ã€‚
   - é€‚ç”¨åœºæ™¯ï¼ˆå¯æ›¿ä»£ XML ï¼‰ï¼šè·¨é˜²ç«å¢™è®¿é—®ã€å¯è°ƒå¼æ€§è¦æ±‚é«˜ã€åŸºäºRestful API è¯·æ±‚ã€ä¼ è¾“æ•°æ®é‡ç›¸å¯¹å°ï¼Œå®æ—¶æ€§è¦æ±‚ç›¸å¯¹ä½ï¼ˆä¾‹å¦‚ç§’çº§åˆ«ï¼‰çš„æœåŠ¡ã€‚
4. ã€äº†è§£ã€‘Thrift ï¼Œä¸ä»…æ˜¯åºåˆ—åŒ–åè®®ï¼Œè¿˜æ˜¯ä¸€ä¸ª RPC æ¡†æ¶ã€‚

   - ä¼˜ç‚¹ï¼šåºåˆ—åŒ–åçš„ä½“ç§¯å°, é€Ÿåº¦å¿«ã€æ”¯æŒå¤šç§è¯­è¨€å’Œä¸°å¯Œçš„æ•°æ®ç±»å‹ã€å¯¹äºæ•°æ®å­—æ®µçš„å¢åˆ å…·æœ‰è¾ƒå¼ºçš„å…¼å®¹æ€§ã€æ”¯æŒäºŒè¿›åˆ¶å‹ç¼©ç¼–ç ã€‚
   - ç¼ºç‚¹ï¼šä½¿ç”¨è€…è¾ƒå°‘ã€è·¨é˜²ç«å¢™è®¿é—®æ—¶ï¼Œä¸å®‰å…¨ã€ä¸å…·æœ‰å¯è¯»æ€§ï¼Œè°ƒè¯•ä»£ç æ—¶ç›¸å¯¹å›°éš¾ã€ä¸èƒ½ä¸å…¶ä»–ä¼ è¾“å±‚åè®®å…±åŒä½¿ç”¨ï¼ˆä¾‹å¦‚ HTTPï¼‰ã€æ— æ³•æ”¯æŒå‘æŒä¹…å±‚ç›´æ¥è¯»å†™æ•°æ®ï¼Œå³ä¸é€‚åˆåšæ•°æ®æŒä¹…åŒ–åºåˆ—åŒ–åè®®ã€‚
   - é€‚ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„ RPC è§£å†³æ–¹æ¡ˆã€‚
5. ã€äº†è§£ã€‘Avro ï¼ŒHadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œè§£å†³äº†JSONçš„å†—é•¿å’Œæ²¡æœ‰IDLçš„é—®é¢˜ã€‚

   - ä¼˜ç‚¹ï¼šæ”¯æŒä¸°å¯Œçš„æ•°æ®ç±»å‹ã€ç®€å•çš„åŠ¨æ€è¯­è¨€ç»“åˆåŠŸèƒ½ã€å…·æœ‰è‡ªæˆ‘æè¿°å±æ€§ã€æé«˜äº†æ•°æ®è§£æé€Ÿåº¦ã€å¿«é€Ÿå¯å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®å½¢å¼ã€å¯ä»¥å®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ RPCã€æ”¯æŒè·¨ç¼–ç¨‹è¯­è¨€å®ç°ã€‚
   - ç¼ºç‚¹ï¼šå¯¹äºä¹ æƒ¯äºé™æ€ç±»å‹è¯­è¨€çš„ç”¨æˆ·ä¸ç›´è§‚ã€‚
   - é€‚ç”¨åœºæ™¯ï¼šåœ¨ Hadoop ä¸­åš Hiveã€Pig å’Œ MapReduce çš„æŒä¹…åŒ–æ•°æ®æ ¼å¼ã€‚
6. é‡ç‚¹ã€‘Protobuf ï¼Œå°†æ•°æ®ç»“æ„ä»¥ `.proto` æ–‡ä»¶è¿›è¡Œæè¿°ï¼Œé€šè¿‡ä»£ç ç”Ÿæˆå·¥å…·å¯ä»¥ç”Ÿæˆå¯¹åº”æ•°æ®ç»“æ„çš„ POJO å¯¹è±¡å’Œ Protobuf ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§ã€‚
   - ä¼˜ç‚¹ï¼šåºåˆ—åŒ–åç æµå°ï¼Œæ€§èƒ½é«˜ã€ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼ˆXML JSONç­‰ï¼‰ã€é€šè¿‡æ ‡è¯†å­—æ®µçš„é¡ºåºï¼Œå¯ä»¥å®ç°åè®®çš„å‰å‘å…¼å®¹ã€ç»“æ„åŒ–çš„æ–‡æ¡£æ›´å®¹æ˜“ç®¡ç†å’Œç»´æŠ¤ã€‚
   - ç¼ºç‚¹ï¼šéœ€è¦ä¾èµ–äºå·¥å…·ç”Ÿæˆä»£ç ã€æ”¯æŒçš„è¯­è¨€ç›¸å¯¹è¾ƒå°‘ï¼Œå®˜æ–¹åªæ”¯æŒJava ã€C++ã€pythonã€‚
   - é€‚ç”¨åœºæ™¯ï¼šå¯¹æ€§èƒ½è¦æ±‚é«˜çš„ RPC è°ƒç”¨ã€å…·æœ‰è‰¯å¥½çš„è·¨é˜²ç«å¢™çš„è®¿é—®å±æ€§ã€é€‚åˆåº”ç”¨å±‚å¯¹è±¡çš„æŒä¹…åŒ–ã€‚
7. å…¶å®ƒ
   - ã€é‡ç‚¹ã€‘Protostuff ï¼ŒåŸºäº Protobuf åè®®ï¼Œä½†ä¸éœ€è¦é…ç½®proto æ–‡ä»¶ï¼Œç›´æ¥å¯¼åŒ…å³å¯ã€‚
     - ç›®å‰ï¼Œå¾®åš RPC æ¡†æ¶ Motan åœ¨ä½¿ç”¨å®ƒã€‚
   - ã€äº†è§£ã€‘Jboss Marshaling ï¼Œå¯ä»¥ç›´æ¥åºåˆ—åŒ– Java ç±»ï¼Œ æ— é¡»å® `java.io.Serializable` æ¥å£ã€‚
   - ã€äº†è§£ã€‘Message Pack ï¼Œä¸€ä¸ªé«˜æ•ˆçš„äºŒè¿›åˆ¶åºåˆ—åŒ–æ ¼å¼ã€‚
   - ã€é‡ç‚¹ã€‘ã€‘[Hessian](https://www.oschina.net/p/hessian) ï¼Œé‡‡ç”¨äºŒè¿›åˆ¶åè®®çš„è½»é‡çº§ remoting on http æœåŠ¡ã€‚
     - ç›®å‰ï¼Œé˜¿é‡Œ RPC æ¡†æ¶ Dubbo çš„**é»˜è®¤**åºåˆ—åŒ–åè®®ã€‚
   - ã€é‡è¦ã€‘kryo ï¼Œæ˜¯ä¸€ä¸ªå¿«é€Ÿé«˜æ•ˆçš„Javaå¯¹è±¡å›¾å½¢åºåˆ—åŒ–æ¡†æ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ€§èƒ½ã€é«˜æ•ˆå’Œæ˜“ç”¨ã€‚è¯¥é¡¹ç›®ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…ç½‘ç»œã€‚
     - ç›®å‰ï¼Œé˜¿é‡Œ RPC æ¡†æ¶ Dubbo çš„å¯é€‰åºåˆ—åŒ–åè®®ã€‚
   - ã€é‡è¦ã€‘FST ï¼Œfast-serialization æ˜¯é‡æ–°å®ç°çš„ Java å¿«é€Ÿå¯¹è±¡åºåˆ—åŒ–çš„å¼€å‘åŒ…ã€‚åºåˆ—åŒ–é€Ÿåº¦æ›´å¿«ï¼ˆ2-10å€ï¼‰ã€ä½“ç§¯æ›´å°ï¼Œè€Œä¸”å…¼å®¹ JDK åŸç”Ÿçš„åºåˆ—åŒ–ã€‚è¦æ±‚ JDK 1.7 æ”¯æŒã€‚
     - ç›®å‰ï¼Œé˜¿é‡Œ RPC æ¡†æ¶ Dubbo çš„å¯é€‰åºåˆ—åŒ–åè®®ã€‚

## Netty çš„é›¶æ‹·è´å®ç°ï¼Ÿ

Netty çš„é›¶æ‹·è´å®ç°ï¼Œæ˜¯ä½“ç°åœ¨å¤šæ–¹é¢çš„ï¼Œä¸»è¦å¦‚ä¸‹ï¼š

Netty çš„é›¶æ‹·è´å®ç°ï¼Œæ˜¯ä½“ç°åœ¨å¤šæ–¹é¢çš„ï¼Œä¸»è¦å¦‚ä¸‹ï¼š

1. ã€é‡ç‚¹ã€‘Netty çš„æ¥æ”¶å’Œå‘é€ ByteBuffer é‡‡ç”¨å †å¤–ç›´æ¥å†…å­˜Direct Bufferã€‚
   - ä½¿ç”¨å †å¤–ç›´æ¥å†…å­˜è¿›è¡Œ Socket è¯»å†™ï¼Œä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´ï¼›ä½¿ç”¨å †å†…å†…å­˜ä¼šå¤šäº†ä¸€æ¬¡å†…å­˜æ‹·è´ï¼ŒJVM ä¼šå°†å †å†…å­˜ Buffer æ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜ä¸­ï¼Œç„¶åæ‰å†™å…¥ Socket ä¸­ã€‚
   - Netty åˆ›å»ºçš„ ByteBuffer ç±»å‹ï¼Œç”± ChannelConfig é…ç½®ã€‚è€Œ ChannelConfig é…ç½®çš„ ByteBufAllocator é»˜è®¤åˆ›å»º Direct Buffer ç±»å‹ã€‚
2. CompositeByteBufç±»ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBuf ï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å†…å­˜æ‹·è´çš„æ–¹å¼å°†å‡ ä¸ªå° Buffer åˆå¹¶æˆä¸€ä¸ªå¤§çš„ Buffer ã€‚
   - `#addComponents(...)` æ–¹æ³•ï¼Œå¯å°† header ä¸ body åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBuf ã€‚è¿™ä¸¤ä¸ª ByteBuf åœ¨CompositeByteBuf å†…éƒ¨éƒ½æ˜¯å•ç‹¬å­˜åœ¨çš„ï¼Œå³ CompositeByteBuf åªæ˜¯é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªæ•´ä½“ã€‚
3. é€šè¿‡FileRegionåŒ…è£…çš„ FileChannel ã€‚
   - `#tranferTo(...)` æ–¹æ³•ï¼Œå®ç°æ–‡ä»¶ä¼ è¾“, å¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ Channel ï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯ write æ–¹å¼ï¼Œå¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜ã€‚
4. é€šè¿‡ **wrap** æ–¹æ³•, æˆ‘ä»¬å¯ä»¥å°† `byte[]` æ•°ç»„ã€ByteBufã€ByteBuffer ç­‰åŒ…è£…æˆä¸€ä¸ª Netty ByteBuf å¯¹è±¡, è¿›è€Œé¿å…äº†æ‹·è´æ“ä½œã€‚

## åŸç”Ÿçš„ NIO å­˜åœ¨ Epoll Bug æ˜¯ä»€ä¹ˆï¼ŸNetty æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ

ğŸ¦… **Java NIO Epoll BUG**

Java NIO Epoll ä¼šå¯¼è‡´ Selector ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´ CPU 100% ã€‚

å®˜æ–¹å£°ç§°åœ¨ JDK 1.6 ç‰ˆæœ¬çš„ update18 ä¿®å¤äº†è¯¥é—®é¢˜ï¼Œä½†æ˜¯ç›´åˆ° JDK 1.7 ç‰ˆæœ¬è¯¥é—®é¢˜ä»æ—§å­˜åœ¨ï¼Œåªä¸è¿‡è¯¥ BUG å‘ç”Ÿæ¦‚ç‡é™ä½äº†ä¸€äº›è€Œå·²ï¼Œå®ƒå¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬æ€§è§£å†³ã€‚

ğŸ¦… **Netty è§£å†³æ–¹æ¡ˆ**

å¯¹ Selector çš„ select æ“ä½œå‘¨æœŸè¿›è¡Œ**ç»Ÿè®¡**ï¼Œæ¯å®Œæˆä¸€æ¬¡**ç©º**çš„ select æ“ä½œè¿›è¡Œä¸€æ¬¡è®¡æ•°ï¼Œè‹¥åœ¨æŸä¸ªå‘¨æœŸå†…è¿ç»­å‘ç”Ÿ N æ¬¡ç©ºè½®è¯¢ï¼Œåˆ™åˆ¤æ–­è§¦å‘äº† Epoll æ­»å¾ªç¯ Bug ã€‚

> è‰¿è‰¿ï¼šæ­¤å¤„**ç©º**çš„ select æ“ä½œçš„å®šä¹‰æ˜¯ï¼Œselect æ“ä½œæ‰§è¡Œäº† 0 æ¯«ç§’ã€‚

æ­¤æ—¶ï¼ŒNetty **é‡å»º** Selector æ¥è§£å†³ã€‚åˆ¤æ–­æ˜¯å¦æ˜¯å…¶ä»–çº¿ç¨‹å‘èµ·çš„é‡å»ºè¯·æ±‚ï¼Œè‹¥ä¸æ˜¯åˆ™å°†åŸ SocketChannel ä»æ—§çš„ Selector ä¸Šå–æ¶ˆæ³¨å†Œï¼Œç„¶åé‡æ–°æ³¨å†Œåˆ°æ–°çš„ Selector ä¸Šï¼Œæœ€åå°†åŸæ¥çš„ Selector å…³é—­ã€‚

## ä»€ä¹ˆæ˜¯ Netty ç©ºé—²æ£€æµ‹ï¼Ÿ

åœ¨ Netty ä¸­ï¼Œæä¾›äº† IdleStateHandler ç±»ï¼Œæ­£å¦‚å…¶åï¼Œç©ºé—²çŠ¶æ€å¤„ç†å™¨ï¼Œç”¨äºæ£€æµ‹è¿æ¥çš„è¯»å†™æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ã€‚å¦‚æœæ˜¯ï¼Œåˆ™ä¼šè§¦å‘ IdleStateEvent ã€‚

IdleStateHandler ç›®å‰æä¾›ä¸‰ç§ç±»å‹çš„å¿ƒè·³æ£€æµ‹ï¼Œé€šè¿‡æ„é€ æ–¹æ³•æ¥è®¾ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// IdleStateHandler.java

public IdleStateHandler(
        int readerIdleTimeSeconds,
        int writerIdleTimeSeconds,
        int allIdleTimeSeconds) {
    this(readerIdleTimeSeconds, writerIdleTimeSeconds, allIdleTimeSeconds,
         TimeUnit.SECONDS);
}
```

- `readerIdleTimeSeconds` å‚æ•°ï¼šä¸ºè¯»è¶…æ—¶æ—¶é—´ï¼Œå³æµ‹è¯•ç«¯ä¸€å®šæ—¶é—´å†…æœªæ¥å—åˆ°è¢«æµ‹è¯•ç«¯æ¶ˆæ¯ã€‚
- `writerIdleTimeSeconds` å‚æ•°ï¼šä¸ºå†™è¶…æ—¶æ—¶é—´ï¼Œå³æµ‹è¯•ç«¯ä¸€å®šæ—¶é—´å†…å‘è¢«æµ‹è¯•ç«¯å‘é€æ¶ˆæ¯ã€‚
- `allIdleTimeSeconds` å‚æ•°ï¼šä¸ºè¯»æˆ–å†™è¶…æ—¶æ—¶é—´ã€‚

------

å¦å¤–ï¼Œæˆ‘ä»¬ä¼šåœ¨ç½‘ç»œä¸Šçœ‹åˆ°ç±»ä¼¼ã€ŠIdleStateHandler å¿ƒè·³æœºåˆ¶ã€‹è¿™æ ·æ ‡é¢˜çš„æ–‡ç« ï¼Œå®é™…ä¸Šç©ºé—²æ£€æµ‹å’Œå¿ƒè·³æœºåˆ¶æ˜¯**ä¸¤ä»¶äº‹**ã€‚

- åªæ˜¯è¯´ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ IdleStateHandler çš„ç›®çš„ï¼Œå°±æ˜¯æ£€æµ‹åˆ°è¿æ¥å¤„äºç©ºé—²ï¼Œé€šè¿‡å¿ƒè·³åˆ¤æ–­å…¶æ˜¯å¦è¿˜æ˜¯**æœ‰æ•ˆçš„è¿æ¥**ã€‚
- è™½ç„¶è¯´ï¼ŒTCP åè®®å±‚æä¾›äº† Keeplive æœºåˆ¶ï¼Œä½†æ˜¯è¯¥æœºåˆ¶é»˜è®¤çš„å¿ƒè·³æ—¶é—´æ˜¯ 2 å°æ—¶ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿå®ç°ä¸å¤Ÿçµæ´»ã€‚å› è€Œï¼Œæˆ‘ä»¬æ‰åœ¨åº”ç”¨å±‚ä¸Šï¼Œè‡ªå·±å®ç°å¿ƒè·³æœºåˆ¶ã€‚

å…·ä½“çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„é—®é¢˜ [ã€ŒNetty å¦‚ä½•å®ç°é‡è¿ï¼Ÿã€](http://svip.iocoder.cn/Netty/Interview/#) ã€‚

## Netty å¦‚ä½•å®ç°é‡è¿ï¼Ÿ

- å®¢æˆ·ç«¯ï¼Œé€šè¿‡ IdleStateHandler å®ç°å®šæ—¶æ£€æµ‹æ˜¯å¦ç©ºé—²ï¼Œä¾‹å¦‚è¯´ 15 ç§’ã€‚
  - å¦‚æœç©ºé—²ï¼Œåˆ™å‘æœåŠ¡ç«¯å‘èµ·å¿ƒè·³ã€‚
  - å¦‚æœå¤šæ¬¡å¿ƒè·³å¤±è´¥ï¼Œåˆ™å…³é—­å’ŒæœåŠ¡ç«¯çš„è¿æ¥ï¼Œç„¶åé‡æ–°å‘èµ·è¿æ¥ã€‚
- æœåŠ¡ç«¯ï¼Œé€šè¿‡ IdleStateHandler å®ç°å®šæ—¶æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦ç©ºé—²ï¼Œä¾‹å¦‚è¯´ 90 ç§’ã€‚
  - å¦‚æœæ£€æµ‹åˆ°ç©ºé—²ï¼Œåˆ™å…³é—­å®¢æˆ·ç«¯ã€‚
  - æ³¨æ„ï¼Œå¦‚æœæ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³è¯·æ±‚ï¼Œè¦åé¦ˆä¸€ä¸ªå¿ƒè·³å“åº”ç»™å®¢æˆ·ç«¯ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä½¿å®¢æˆ·ç«¯çŸ¥é“è‡ªå·±å¿ƒè·³æˆåŠŸã€‚

å¦‚ä¸‹è‰¿è‰¿åœ¨è‡ªå·±çš„ [TaroRPC](https://github.com/YunaiV/TaroRPC) ä¸­æä¾›çš„ä¸€ä¸ªç¤ºä¾‹ï¼š

- [NettyClient.java](https://github.com/YunaiV/TaroRPC/blob/master/transport/transport-netty4/src/main/java/cn/iocoder/taro/transport/netty4/NettyClient.java) ä¸­ï¼Œè®¾ç½® IdleStateHandler å’Œ ClientHeartbeatHandlerã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

  ```java
  // NettyHandler.java
  
  .addLast("idleState", new IdleStateHandler(TaroConstants.TRANSPORT_CLIENT_IDLE,
                                             TaroConstants.TRANSPORT_CLIENT_IDLE, 0,
                                             TimeUnit.MILLISECONDS))
      .addLast("heartbeat", new ClientHeartbeatHandler())
  ```

- [NettyServer.java](https://github.com/YunaiV/TaroRPC/blob/master/transport/transport-netty4/src/main/java/cn/iocoder/taro/transport/netty4/NettyServer.java) ä¸­ï¼Œè®¾ç½® IdleStateHandler å’Œ ServerHeartbeatHandlerã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

  ```java
  // NettyServer.java
  
  .addLast("idleState", new IdleStateHandler(0, 0, TaroConstants.TRANSPORT_SERVER_IDLE,
                                             TimeUnit.MILLISECONDS))
      .addLast("heartbeat", new ServerHeartbeatHandler())
  ```

- [ClientHeartbeatHandler.java](https://github.com/YunaiV/TaroRPC/blob/master/transport/transport-netty4/src/main/java/cn/iocoder/taro/transport/netty4/heartbeat/ClientHeartbeatHandler.java) ä¸­ï¼Œç¢°åˆ°ç©ºé—²ï¼Œåˆ™å‘èµ·å¿ƒè·³ã€‚ä¸è¿‡ï¼Œå¦‚ä½•é‡è¿ï¼Œæš‚æ—¶æ²¡æœ‰å®ç°ã€‚éœ€è¦è€ƒè™‘ï¼Œé‡æ–°å‘èµ·è¿æ¥å¯èƒ½ä¼šå¤±è´¥çš„æƒ…å†µã€‚å…·ä½“çš„ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šä¸€èµ·å­¦Nettyï¼ˆåå››ï¼‰ä¹‹ Nettyç”Ÿäº§çº§çš„å¿ƒè·³å’Œé‡è¿æœºåˆ¶ã€‹](https://blog.csdn.net/linuu/article/details/51509847) æ–‡ç« ä¸­çš„ï¼ŒConnectionWatchdog çš„ä»£ç ã€‚

- [ServerHeartbeatHandler.java](https://github.com/YunaiV/TaroRPC/blob/6ce2af911ccec9ed5dc75c7f3ebda9c758272f3b/transport/transport-netty4/src/main/java/cn/iocoder/taro/transport/netty4/heartbeat/ServerHeartbeatHandler.java) ä¸­ï¼Œæ£€æµ‹åˆ°å®¢æˆ·ç«¯ç©ºé—²ï¼Œåˆ™ç›´æ¥å…³é—­è¿æ¥ã€‚

## Netty è‡ªå·±å®ç°çš„ ByteBuf æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ

å¦‚ä¸‹æ˜¯ [ã€ŠNetty å®æˆ˜ã€‹](http://svip.iocoder.cn/Netty/ByteBuf-1-1-ByteBuf-intro/#) å¯¹å®ƒçš„**ä¼˜ç‚¹æ€»**ç»“ï¼š

> - A01. å®ƒå¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„**ç¼“å†²åŒºç±»å‹**æ‰©å±•
> - A02. é€šè¿‡å†…ç½®çš„ç¬¦åˆç¼“å†²åŒºç±»å‹å®ç°äº†é€æ˜çš„**é›¶æ‹·è´**
> - A03. å®¹é‡å¯ä»¥**æŒ‰éœ€å¢é•¿**
> - A04. åœ¨è¯»å’Œå†™è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è°ƒç”¨ `#flip()` æ–¹æ³•
> - A05. è¯»å’Œå†™ä½¿ç”¨äº†**ä¸åŒçš„ç´¢å¼•**
> - A06. æ”¯æŒæ–¹æ³•çš„**é“¾å¼**è°ƒç”¨
> - A07. æ”¯æŒå¼•ç”¨è®¡æ•°
> - A08. æ”¯æŒ**æ± åŒ–**

- ç‰¹åˆ«æ˜¯ç¬¬ A04 è¿™ç‚¹ï¼Œç›¸ä¿¡å¾ˆå¤šèƒ–å‹éƒ½è¢« NIO ByteBuffer åäººç±»çš„è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ç»™å‘å“­äº†ã€‚åœ¨ [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆä¸‰ï¼‰ä¹‹ Bufferã€‹](http://svip.iocoder.cn/Netty/nio-3-buffer/) ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿåæ§½è¿‡äº†ã€‚ğŸ˜ˆ

æƒ³è¦è¿›ä¸€æ­¥æ·±å…¥çš„ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆä¸€ï¼‰ç®€ä»‹ã€‹](http://svip.iocoder.cn/Netty/ByteBuf-1-1-ByteBuf-intro/) ã€‚

## Netty ä¸ºä»€ä¹ˆè¦å®ç°å†…å­˜ç®¡ç†ï¼Ÿ

ğŸ¦… **è€è‰¿è‰¿çš„ç†è§£**

åœ¨ Netty ä¸­ï¼ŒIO è¯»å†™å¿…å®šæ˜¯éå¸¸é¢‘ç¹çš„æ“ä½œï¼Œè€Œè€ƒè™‘åˆ°æ›´é«˜æ•ˆçš„ç½‘ç»œä¼ è¾“æ€§èƒ½ï¼ŒDirect ByteBuffer å¿…ç„¶æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ã€‚ä½†æ˜¯ Direct ByteBuffer çš„ç”³è¯·å’Œé‡Šæ”¾æ˜¯é«˜æˆæœ¬çš„æ“ä½œï¼Œé‚£ä¹ˆè¿›è¡Œ**æ± åŒ–**ç®¡ç†ï¼Œå¤šæ¬¡é‡ç”¨æ˜¯æ¯”è¾ƒæœ‰æ•ˆçš„æ–¹å¼ã€‚ä½†æ˜¯ï¼Œä¸åŒäºä¸€èˆ¬äºæˆ‘ä»¬å¸¸è§çš„å¯¹è±¡æ± ã€è¿æ¥æ± ç­‰**æ± åŒ–**çš„æ¡ˆä¾‹ï¼ŒByteBuffer æ˜¯æœ‰**å¤§å°**ä¸€è¯´ã€‚åˆä½†æ˜¯ï¼Œç”³è¯·å¤šå¤§çš„ Direct ByteBuffer è¿›è¡Œæ± åŒ–åˆä¼šæ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œå¤ªå¤§ä¼šæµªè´¹å†…å­˜ï¼Œå¤ªå°åˆä¼šå‡ºç°é¢‘ç¹çš„æ‰©å®¹å’Œå†…å­˜å¤åˆ¶ï¼ï¼ï¼æ‰€ä»¥å‘¢ï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªåˆé€‚çš„å†…å­˜ç®¡ç†ç®—æ³•ï¼Œè§£å†³**é«˜æ•ˆåˆ†é…å†…å­˜**çš„åŒæ—¶åˆè§£å†³**å†…å­˜ç¢ç‰‡åŒ–**çš„é—®é¢˜ã€‚

ğŸ¦… **å®˜æ–¹çš„è¯´æ³•**

> FROM [ã€ŠNetty å­¦ä¹ ç¬”è®° â€”â€” Pooled bufferã€‹](https://skyao.gitbooks.io/learning-netty/content/buffer/pooled_buffer.html)
>
> Netty 4.x å¢åŠ äº† Pooled Bufferï¼Œå®ç°äº†é«˜æ€§èƒ½çš„ buffer æ± ï¼Œåˆ†é…ç­–ç•¥åˆ™æ˜¯ç»“åˆäº† buddy allocation å’Œ slab allocation çš„ **jemalloc** å˜ç§ï¼Œä»£ç åœ¨`io.netty.buffer.PoolArena` ä¸­ã€‚
>
> å®˜æ–¹è¯´æä¾›äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š
>
> - é¢‘ç¹åˆ†é…ã€é‡Šæ”¾ buffer æ—¶å‡å°‘äº† GC å‹åŠ›ã€‚
> - åœ¨åˆå§‹åŒ–æ–° buffer æ—¶å‡å°‘å†…å­˜å¸¦å®½æ¶ˆè€—( åˆå§‹åŒ–æ—¶ä¸å¯é¿å…çš„è¦ç»™bufferæ•°ç»„èµ‹åˆå§‹å€¼ )ã€‚
> - åŠæ—¶çš„é‡Šæ”¾ direct buffer ã€‚

ğŸ¦… **hushi55 å¤§ä½¬çš„ç†è§£**

> > C/C++ å’Œ java ä¸­æœ‰ä¸ªå›´åŸï¼ŒåŸé‡Œçš„æƒ³å‡ºæ¥ï¼ŒåŸå¤–çš„æƒ³è¿›å»ï¼**
>
> è¿™ä¸ªå›´åŸå°±æ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼
>
> **Netty 4 buffer ä»‹ç»**
>
> Netty4 å¸¦æ¥ä¸€ä¸ªä¸ä¼—ä¸åŒçš„ç‰¹ç‚¹æ˜¯å…¶ ByteBuf çš„å®ç°ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œé€šè¿‡ç»´æŠ¤ä¸¤ä¸ªç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆï¼Œ è¦æ¯” `io.netty.buffer.ByteBuf` ç®€å•ä¸å°‘ï¼Œä¹Ÿä¼šæ›´é«˜æ•ˆä¸€äº›ã€‚ä¸è¿‡ï¼ŒNetty çš„ ByteBuf å¸¦ç»™æˆ‘ä»¬çš„æœ€å¤§ä¸åŒï¼Œå°±æ˜¯ä»–ä¸å†åŸºäºä¼ ç»Ÿ JVM çš„ GC æ¨¡å¼ï¼Œç›¸åï¼Œå®ƒé‡‡ç”¨äº†ç±»ä¼¼äº C++ ä¸­çš„ malloc/free çš„æœºåˆ¶ï¼Œéœ€è¦å¼€å‘äººå‘˜æ¥æ‰‹åŠ¨ç®¡ç†å›æ”¶ä¸é‡Šæ”¾ã€‚ä»æ‰‹åŠ¨å†…å­˜ç®¡ç†ä¸Šå‡åˆ°GCï¼Œæ˜¯ä¸€ä¸ªå†å²çš„å·¨å¤§è¿›æ­¥ï¼Œ ä¸è¿‡ï¼Œåœ¨20å¹´åï¼Œå±…ç„¶æœ‰æ›²çº¿çš„å›å½’åˆ°äº†æ‰‹åŠ¨å†…å­˜ç®¡ç†æ¨¡å¼ï¼Œæ­£å°è¯äº†é©¬å…‹æ€å“²å­¦è§‚ï¼š **ç¤¾ä¼šæ€»æ˜¯åœ¨èºæ—‹å¼å‰è¿›çš„ï¼Œæ²¡æœ‰æ°¸è¿œçš„æœ€å¥½ã€‚**
>
> **â‘  GC å†…å­˜ç®¡ç†åˆ†æ**
>
> çš„ç¡®ï¼Œå°±å†…å­˜ç®¡ç†è€Œè¨€ï¼ŒGCå¸¦ç»™æˆ‘ä»¬çš„ä»·å€¼æ˜¯ä¸è¨€è€Œå–»çš„ï¼Œä¸ä»…å¤§å¤§çš„é™ä½äº†ç¨‹åºå‘˜çš„å¿ƒæ™ºåŒ…è¢±ï¼Œ è€Œä¸”ï¼Œä¹Ÿæå¤§çš„å‡å°‘äº†å†…å­˜ç®¡ç†å¸¦æ¥çš„ Crash å›°æ‰°ï¼Œä¸ºå‡½æ•°å¼ç¼–ç¨‹ï¼ˆå¤§é‡çš„ä¸´æ—¶å¯¹è±¡ï¼‰ã€è„šæœ¬è¯­è¨€ç¼–ç¨‹å¸¦æ¥äº†æ˜¥å¤©ã€‚ å¹¶ä¸”ï¼Œé«˜æ•ˆçš„GCç®—æ³•ä¹Ÿè®©å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç¨‹åºå¯ä»¥æœ‰æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚ ä¸è¿‡ï¼Œä¹Ÿæœ‰å¾ˆå¤šçš„æƒ…å†µï¼Œå¯èƒ½æ˜¯æ‰‹å·¥å†…å­˜ç®¡ç†æ›´ä¸ºåˆé€‚çš„ã€‚è­¬å¦‚ï¼š
>
> - å¯¹äºç±»ä¼¼äºä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œè­¬å¦‚ç½‘ç»œè·¯ç”±è½¬å‘å‹åº”ç”¨ï¼ˆå¾ˆå¤šerlangåº”ç”¨å…¶å®æ˜¯è¿™ç§ç±»å‹ï¼‰ï¼Œ ä½†æ˜¯ QPS éå¸¸é«˜ï¼Œæ¯”å¦‚1Mçº§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨æ¯æ¬¡å¤„ç†ä¸­å³ä¾¿äº§ç”Ÿ1Kçš„åƒåœ¾ï¼Œéƒ½ä¼šå¯¼è‡´é¢‘ç¹çš„GCäº§ç”Ÿã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œerlang çš„æŒ‰è¿›ç¨‹å›æ”¶æ¨¡å¼ï¼Œæˆ–è€…æ˜¯ C/C++ çš„æ‰‹å·¥å›æ”¶æœºåˆ¶ï¼Œæ•ˆç‡æ›´é«˜ã€‚
> - Cache å‹åº”ç”¨ï¼Œç”±äºå¯¹è±¡çš„å­˜åœ¨å‘¨æœŸå¤ªé•¿ï¼ŒGC åŸºæœ¬ä¸Šå°±å˜å¾—æ²¡æœ‰ä»·å€¼ã€‚
>
> æ‰€ä»¥ï¼Œç†è®ºä¸Šï¼Œå°´å°¬çš„GCå®é™…ä¸Šæ¯”è¾ƒé€‚åˆäºå¤„ç†ä»‹äºè¿™ 2 è€…ä¹‹é—´çš„æƒ…å†µï¼š å¯¹è±¡åˆ†é…çš„é¢‘ç¹ç¨‹åº¦ç›¸æ¯”æ•°æ®å¤„ç†çš„æ—¶é—´è¦å°‘å¾—å¤šçš„ï¼Œä½†åˆæ˜¯ç›¸å¯¹çŸ­æš‚çš„ï¼Œ å…¸å‹çš„ï¼Œå¯¹äºOLTPå‹çš„æœåŠ¡ï¼Œå¤„ç†èƒ½åŠ›åœ¨ 1K QPS é‡çº§ï¼Œæ¯ä¸ªè¯·æ±‚çš„å¯¹è±¡åˆ†é…åœ¨ 10K-50K é‡çº§ï¼Œ èƒ½å¤Ÿåœ¨ 5-10s çš„æ—¶é—´å†…è¿›è¡Œä¸€ æ¬¡younger GC ï¼Œæ¯æ¬¡GCçš„æ—¶é—´å¯ä»¥æ§åˆ¶åœ¨ 10ms æ°´å¹³ä¸Šï¼Œ è¿™ç±»çš„åº”ç”¨ï¼Œå®åœ¨æ˜¯å¤ªé€‚åˆ GC è¡Œçš„æ¨¡å¼äº†ï¼Œè€Œä¸”ç»“åˆ Java é«˜æ•ˆçš„åˆ†ä»£ GC ï¼Œç®€ç›´å°±æ˜¯ä¸€ä¸ªç†æƒ³æ­é…ã€‚
>
> **â‘¡ å½±å“**
>
> Netty 4 å¼•å…¥äº†æ‰‹å·¥å†…å­˜çš„æ¨¡å¼ï¼Œæˆ‘è§‰å¾—è¿™æ˜¯ä¸€å¤§åˆ›æ–°ï¼Œè¿™ç§æ¨¡å¼ç”šè‡³äºä¼šå»¶å±•ï¼Œ åº”ç”¨åˆ° Cache åº”ç”¨ä¸­ã€‚å®é™…ä¸Šï¼Œç»“åˆ JVM çš„è¯¸å¤šä¼˜ç§€ç‰¹æ€§ï¼Œå¦‚æœç”¨ Java æ¥å®ç°ä¸€ä¸ª Redis å‹ Cacheã€ æˆ–è€… In-memory SQL Engineï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª Mongo DBï¼Œæˆ‘è§‰å¾—ç›¸æ¯” C/C++ è€Œè¨€ï¼Œéƒ½è¦æ›´ç®€å•å¾ˆå¤šã€‚ å®é™…ä¸Šï¼ŒJVM ä¹Ÿå·²ç»æä¾›äº†æ‰“é€šè¿™ç§æŠ€æœ¯çš„æœºåˆ¶ï¼Œå°±æ˜¯ Direct Memory å’Œ Unsafe å¯¹è±¡ã€‚ åŸºäºè¿™ä¸ªåŸºç¡€ï¼Œæˆ‘ä»¬å¯ä»¥åƒ C è¯­è¨€ä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ã€‚å®é™…ä¸Šï¼ŒNetty4 çš„ ByteBuf ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªåŸºç¡€çš„ã€‚

æ›´å¤šè¯¦ç»†çš„å†…å®¹ï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹ [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸€ï¼‰ç®€ä»‹ã€‹](http://svip.iocoder.cn/Netty/ByteBuf-3-1-Jemalloc-intro/) ã€‚

## Netty å¦‚ä½•å®å¿ƒå†…å­˜ç®¡ç†ï¼Ÿ

> è¿™ä¸ªé¢˜ç›®ï¼Œç®€å•äº†è§£å³å¯ï¼Œå¦‚æœæ·±å…¥ï¼Œå°±è¦å»çœ‹ [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Bufferã€‹](http://svip.iocoder.cn/categories/Netty/) ç›¸å…³çš„æºç ã€‚è€Œä¸”ï¼Œçœ‹å®Œå°±å¿˜è®°ï¼Œæ¯”è¾ƒéš¾å’Œå¤æ‚ã€‚
>
> å½“ç„¶ï¼Œçœ‹æ‡‚é‚£ä¸€åˆ»ï¼Œä¹è¶£æ— ç©·ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚

Netty å†…å­˜ç®¡ç†æœºåˆ¶ï¼ŒåŸºäº [Jemalloc](http://www.cnhalo.net/2016/06/13/memory-optimize/) ç®—æ³•ã€‚

- é¦–å…ˆä¼šé¢„ç”³è¯·ä¸€å¤§å—å†…å­˜ **Arena** ï¼ŒArena ç”±è®¸å¤š Chunk ç»„æˆï¼Œè€Œæ¯ä¸ª Chunk é»˜è®¤ç”±2048ä¸ªpageç»„æˆã€‚
- **Chunk** é€šè¿‡ **AVL** æ ‘çš„å½¢å¼ç»„ç»‡ **Page** ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ª Page ï¼Œè€Œä¸­é—´èŠ‚ç‚¹è¡¨ç¤ºå†…å­˜åŒºåŸŸï¼ŒèŠ‚ç‚¹è‡ªå·±è®°å½•å®ƒåœ¨æ•´ä¸ª Arena ä¸­çš„åç§»åœ°å€ã€‚å½“åŒºåŸŸè¢«åˆ†é…å‡ºå»åï¼Œä¸­é—´èŠ‚ç‚¹ä¸Šçš„æ ‡è®°ä½ä¼šè¢«æ ‡è®°ï¼Œè¿™æ ·å°±è¡¨ç¤ºè¿™ä¸ªä¸­é—´èŠ‚ç‚¹ä»¥ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å·²è¢«åˆ†é…äº†ã€‚å¤§äº 8k çš„å†…å­˜åˆ†é…åœ¨ **PoolChunkList** ä¸­ï¼Œè€Œ **PoolSubpage** ç”¨äºåˆ†é…å°äº 8k çš„å†…å­˜ï¼Œå®ƒä¼šæŠŠä¸€ä¸ª page åˆ†å‰²æˆå¤šæ®µï¼Œè¿›è¡Œå†…å­˜åˆ†é…ã€‚

## ä»€ä¹ˆæ˜¯ Netty çš„å†…å­˜æ³„éœ²æ£€æµ‹ï¼Ÿæ˜¯å¦‚ä½•è¿›è¡Œå®ç°çš„ï¼Ÿ

> è‰¿è‰¿ï¼šè¿™æ˜¯ä¸€é“æ¯”è¾ƒå¤æ‚çš„é¢è¯•é¢˜ï¼Œå¯ä»¥æŒ‘æˆ˜ä¸€ä¸‹ã€‚

æ¨èé˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€ŠNetty ä¹‹æœ‰æ•ˆè§„é¿å†…å­˜æ³„æ¼ã€‹](http://calvin1978.blogcn.com/articles/netty-leak.html) ä»åŸç†å±‚é¢è§£é‡Šã€‚
- [ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆä¸‰ï¼‰å†…å­˜æ³„éœ²æ£€æµ‹ã€‹](http://svip.iocoder.cn/Netty/ByteBuf-1-3-ByteBuf-resource-leak-detector/) ä»æºç å±‚é¢è§£è¯»ã€‚

å¦å¤–ï¼ŒNetty çš„å†…å­˜æ³„éœ²æ£€æµ‹çš„å®ç°ï¼Œæ˜¯å¯¹ WeakReference å’Œ ReferenceQueue å¾ˆå¥½çš„å­¦ä¹ ã€‚ä¹‹å‰å¾ˆå¤šèƒ–å‹åœ¨çœ‹äº† [ã€ŠJava ä¸­çš„å››ç§å¼•ç”¨ç±»å‹ã€‹](http://www.iocoder.cn/Fight/Four-reference-types-in-Java) ä¹‹åï¼Œæ˜¯ä¸å¤ªç†è§£ Java çš„å››ç§å¼•ç”¨çš„å…·ä½“ä½¿ç”¨åœºæ™¯ï¼Œè¿™ä¸å°±æ¥äº†ä¹ˆã€‚

# 666. å½©è›‹

ğŸ˜ˆ æ’¸å®Œ Netty æºç ä¹‹åï¼Œä¸€æ®µæ—¶é—´æ²¡å»ç”¨ï¼Œä¸œè¥¿éƒ½å¿˜äº†è›®å¤šã€‚ä¸è¿‡å› ä¸ºè¯»è¿‡æºç ï¼Œåœ¨çœ‹è¿™äº›é¢è¯•é¢˜ï¼Œä¼šå‘ç°è½»æ¾å¤ªå¤šäº†ã€‚æœ‰ä¸€ç§ï¼Œâ€œè€æœ‹å‹â€çš„æ„Ÿè§‰ã€‚å¦¥å¦¥çš„ã€‚

å‚è€ƒä¸æ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- itdragon [ã€ŠNetty åºç« ä¹‹ BIO NIO AIO æ¼”å˜ã€‹](https://segmentfault.com/a/1190000012976683)
- ç™½å¤œè¡Œ515 [ã€Šã€é¢è¯•é¢˜ã€‘Nettyç›¸å…³ã€‹](https://blog.csdn.net/baiye_xing/article/details/76735113)
- albon [ã€ŠNetty æƒå¨æŒ‡å—ç¬”è®°ï¼ˆäºŒï¼‰ï¼šJava NIO å’Œ Netty å¯¹æ¯”ã€‹](https://www.jianshu.com/p/93876f1bf6d1)
- albon [ã€ŠNetty æƒå¨æŒ‡å—ç¬”è®°ï¼ˆå››ï¼‰ï¼šæ¶æ„å‰–æã€‹](https://www.jianshu.com/p/ececec069cc1)
- ç‹—çª [ã€Šé¢è¯•é¢˜ä¹‹ Nettyã€‹](https://nizouba.com/articles/2018/11/04/1541322296629.html) é¢˜ç›®å¾ˆä¸é”™ï¼Œå°±æ˜¯å›¾ç‰‡éƒ½æŒ‚äº†ã€‚