å¦å¤–ï¼Œè¿™ä¸ªé¢è¯•é¢˜æ˜¯å»ºç«‹åœ¨èƒ–å‹çœ‹è¿‡ [ã€Šç²¾å°½ã€æ¶ˆæ¯é˜Ÿåˆ— ã€‘é¢è¯•é¢˜ã€‹](http://svip.iocoder.cn/MQ/Interview) ã€‚

å¦‚æœå¯èƒ½çš„è¯ï¼Œæ¨èèƒ–å‹å…ˆé˜…è¯»äº† [ã€ŠKafka æƒå¨æŒ‡å—ã€‹](https://u.jd.com/jJpbF8) ï¼Œæ›´åŠ ç³»ç»Ÿå¯é ã€‚

## Apache Kafka æ˜¯ä»€ä¹ˆ?

Kafka æ˜¯åŸºäº**å‘å¸ƒä¸è®¢é˜…**çš„**æ¶ˆæ¯ç³»ç»Ÿ**ã€‚å®ƒæœ€åˆç”± LinkedIn å…¬å¸å¼€å‘ï¼Œä¹‹åæˆä¸º Apache é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¯åˆ†åŒºçš„ï¼Œå†—ä½™å¤‡ä»½çš„æŒä¹…æ€§çš„æ—¥å¿—æœåŠ¡ã€‚å®ƒä¸»è¦ç”¨äºå¤„ç†æ´»è·ƒçš„æµå¼æ•°æ®ã€‚

åœ¨å¤§æ•°æ®ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸ä¼šç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæ•´ä¸ªå¤§æ•°æ®æ˜¯ç”±å„ä¸ªå­ç³»ç»Ÿç»„æˆï¼Œæ•°æ®éœ€è¦åœ¨å„ä¸ªå­ç³»ç»Ÿä¸­é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„ä¸åœæµè½¬ã€‚ä¼ ç»Ÿçš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿå¹¶ä¸æ˜¯éå¸¸é€‚åˆå¤§è§„æ¨¡çš„æ•°æ®å¤„ç†ã€‚ä¸ºäº†åŒæ—¶æå®šåœ¨çº¿åº”ç”¨ï¼ˆæ¶ˆæ¯ï¼‰å’Œç¦»çº¿åº”ç”¨ï¼ˆæ•°æ®æ–‡ä»¶ã€æ—¥å¿—ï¼‰ï¼ŒKafka å°±å‡ºç°äº†ã€‚Kafka å¯ä»¥èµ·åˆ°ä¸¤ä¸ªä½œç”¨ï¼š

- é™ä½ç³»ç»Ÿç»„ç½‘å¤æ‚åº¦ã€‚
- é™ä½ç¼–ç¨‹å¤æ‚åº¦ï¼Œå„ä¸ªå­ç³»ç»Ÿä¸åœ¨æ˜¯ç›¸äº’åå•†æ¥å£ï¼Œå„ä¸ªå­ç³»ç»Ÿç±»ä¼¼æ’å£æ’åœ¨æ’åº§ä¸Šï¼ŒKafka æ‰¿æ‹…é«˜é€Ÿ**æ•°æ®æ€»çº¿**çš„ä½œç”¨ã€‚

ğŸ¦… **Kafka çš„ä¸»è¦ç‰¹ç‚¹ï¼Ÿ**

- 1ã€åŒæ—¶ä¸ºå‘å¸ƒå’Œè®¢é˜…æä¾›é«˜ååé‡ã€‚æ®äº†è§£ï¼ŒKafka æ¯ç§’å¯ä»¥ç”Ÿäº§çº¦ 25 ä¸‡æ¶ˆæ¯ï¼ˆ50MBï¼‰ï¼Œæ¯ç§’å¤„ç† 55 ä¸‡æ¶ˆæ¯ï¼ˆ110MBï¼‰ã€‚

- 2ã€å¯è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚å°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå› æ­¤å¯ç”¨äºæ‰¹é‡æ¶ˆè´¹ï¼Œä¾‹å¦‚ ETL ï¼Œä»¥åŠå®æ—¶åº”ç”¨ç¨‹åºã€‚é€šè¿‡å°†æ•°æ®æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Œä»¥åŠreplication ï¼Œå¯ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚

- 3ã€åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ˜“äºå‘å¤–æ‰©å±•ã€‚æ‰€æœ‰çš„ Producerã€Broker å’ŒConsumer éƒ½ä¼šæœ‰å¤šä¸ªï¼Œå‡ä¸ºåˆ†å¸ƒå¼çš„ã€‚å¹¶ä¸”ï¼Œæ— éœ€åœæœºå³å¯æ‰©å±•æœºå™¨ã€‚

- 4ã€æ¶ˆæ¯è¢«å¤„ç†çš„çŠ¶æ€æ˜¯åœ¨ Consumer ç«¯ç»´æŠ¤ï¼Œè€Œä¸æ˜¯ç”± Broker ç«¯ç»´æŠ¤ã€‚å½“å¤±è´¥æ—¶ï¼Œèƒ½è‡ªåŠ¨å¹³è¡¡ã€‚

  > è¿™æ®µæ˜¯ä»ç½‘ç»œä¸Šæ‰¾æ¥çš„ã€‚æ„Ÿè§‰æƒ³è¦è¡¨è¾¾çš„æ„æ€æ˜¯
  >
  > - æ¶ˆæ¯æ˜¯å¦è¢«å¤„ç†å®Œæˆï¼Œæ˜¯é€šè¿‡ Consumer æäº¤æ¶ˆè´¹è¿›åº¦ç»™ Broker ï¼Œè€Œä¸æ˜¯ Broker æ¶ˆæ¯è¢« Consumer æ‹‰å–åï¼Œå°±æ ‡è®°ä¸ºå·²æ¶ˆè´¹ã€‚
  > - å½“ Consumer å¼‚å¸¸å´©æºƒæ—¶ï¼Œå¯ä»¥é‡æ–°åˆ†é…æ¶ˆæ¯åˆ†åŒºåˆ°å…¶å®ƒçš„ Consumer ä»¬ï¼Œç„¶åç»§ç»­æ¶ˆè´¹ã€‚

- 5ã€æ”¯æŒ online å’Œ offline çš„åœºæ™¯ã€‚

ğŸ¦… **èŠèŠ Kafka çš„è®¾è®¡è¦ç‚¹ï¼Ÿ**

1ï¼‰ååé‡

é«˜ååæ˜¯ Kafka éœ€è¦å®ç°çš„æ ¸å¿ƒç›®æ ‡ä¹‹ä¸€ï¼Œä¸ºæ­¤ kafka åšäº†ä»¥ä¸‹ä¸€äº›è®¾è®¡ï¼š

- 1ã€æ•°æ®ç£ç›˜æŒä¹…åŒ–ï¼šæ¶ˆæ¯ä¸åœ¨å†…å­˜ä¸­ Cache ï¼Œç›´æ¥å†™å…¥åˆ°ç£ç›˜ï¼Œå……åˆ†åˆ©ç”¨ç£ç›˜çš„é¡ºåºè¯»å†™æ€§èƒ½ã€‚

  > ç›´æ¥ä½¿ç”¨ Linux æ–‡ä»¶ç³»ç»Ÿçš„ Cache ï¼Œæ¥é«˜æ•ˆç¼“å­˜æ•°æ®ã€‚

- 2ã€zero-copyï¼šå‡å°‘ IO æ“ä½œæ­¥éª¤

  > é‡‡ç”¨ Linux Zero-Copy æé«˜å‘é€æ€§èƒ½ã€‚
  >
  > - ä¼ ç»Ÿçš„æ•°æ®å‘é€éœ€è¦å‘é€ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚
  > - é‡‡ç”¨ sendfile ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæ•°æ®ç›´æ¥åœ¨å†…æ ¸æ€äº¤æ¢ï¼Œç³»ç»Ÿä¸Šä¸‹æ–‡åˆ‡æ¢å‡å°‘ä¸º 2 æ¬¡ã€‚æ ¹æ®æµ‹è¯•ç»“æœï¼Œå¯ä»¥æé«˜ 60% çš„æ•°æ®å‘é€æ€§èƒ½ã€‚Zero-Copy è¯¦ç»†çš„æŠ€æœ¯ç»†èŠ‚å¯ä»¥å‚è€ƒ [ã€ŠEfficient data transfer through zero copyã€‹](https://developer.ibm.com/articles/j-zerocopy/) æ–‡ç« ã€‚

- 3ã€æ•°æ®æ‰¹é‡å‘é€

- 4ã€æ•°æ®å‹ç¼©

- 5ã€Topic åˆ’åˆ†ä¸ºå¤šä¸ª Partition ï¼Œæé«˜å¹¶è¡Œåº¦ã€‚

  > æ•°æ®åœ¨ç£ç›˜ä¸Šå­˜å–ä»£ä»·ä¸º `O(1)`ã€‚
  >
  > - Kafka ä»¥ Topic æ¥è¿›è¡Œæ¶ˆæ¯ç®¡ç†ï¼Œæ¯ä¸ª Topic åŒ…å«å¤šä¸ª Partition ï¼Œæ¯ä¸ª Partition å¯¹åº”ä¸€ä¸ªé€»è¾‘ log ï¼Œæœ‰å¤šä¸ª segment æ–‡ä»¶ç»„æˆã€‚
  > - æ¯ä¸ª segment ä¸­å­˜å‚¨å¤šæ¡æ¶ˆæ¯ï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œæ¶ˆæ¯ id ç”±å…¶é€»è¾‘ä½ç½®å†³å®šï¼Œå³ä»æ¶ˆæ¯ id å¯ç›´æ¥å®šä½åˆ°æ¶ˆæ¯çš„å­˜å‚¨ä½ç½®ï¼Œé¿å… id åˆ°ä½ç½®çš„é¢å¤–æ˜ å°„ã€‚
  > - æ¯ä¸ª Partition åœ¨å†…å­˜ä¸­å¯¹åº”ä¸€ä¸ª index ï¼Œè®°å½•æ¯ä¸ª segment ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯åç§»ã€‚
  >
  > å‘å¸ƒè€…å‘åˆ°æŸä¸ª Topic çš„æ¶ˆæ¯ä¼šè¢«å‡åŒ€çš„åˆ†å¸ƒåˆ°å¤šä¸ª Partition ä¸Šï¼ˆéšæœºæˆ–æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„å›è°ƒå‡½æ•°è¿›è¡Œåˆ†å¸ƒï¼‰ï¼ŒBroker æ”¶åˆ°å‘å¸ƒæ¶ˆæ¯å¾€å¯¹åº” Partition çš„æœ€åä¸€ä¸ª segment ä¸Šæ·»åŠ è¯¥æ¶ˆæ¯ã€‚
  > å½“æŸä¸ª segmentä¸Š çš„æ¶ˆæ¯æ¡æ•°è¾¾åˆ°é…ç½®å€¼æˆ–æ¶ˆæ¯å‘å¸ƒæ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œsegmentä¸Š çš„æ¶ˆæ¯ä¼šè¢« flush åˆ°ç£ç›˜ï¼Œåªæœ‰ flush åˆ°ç£ç›˜ä¸Šçš„æ¶ˆæ¯è®¢é˜…è€…æ‰èƒ½è®¢é˜…åˆ°ï¼Œsegment è¾¾åˆ°ä¸€å®šçš„å¤§å°åå°†ä¸ä¼šå†å¾€è¯¥ segment å†™æ•°æ®ï¼ŒBroker ä¼šåˆ›å»ºæ–°çš„ segment æ–‡ä»¶ã€‚

2ï¼‰è´Ÿè½½å‡è¡¡

- 1ã€Producer æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç®—æ³•ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„ Partition ä¸­ã€‚
- 2ã€Topic å­˜åœ¨å¤šä¸ª Partition ï¼Œæ¯ä¸ª Partition æœ‰è‡ªå·±çš„replica ï¼Œæ¯ä¸ª replica åˆ†å¸ƒåœ¨ä¸åŒçš„ Broker èŠ‚ç‚¹ä¸Šã€‚å¤šä¸ªPartition éœ€è¦é€‰å–å‡º Leader partition ï¼ŒLeader Partition è´Ÿè´£è¯»å†™ï¼Œå¹¶ç”± Zookeeper è´Ÿè´£ fail over ã€‚
- 3ã€ç›¸åŒ Topic çš„å¤šä¸ª Partition ä¼šåˆ†é…ç»™ä¸åŒçš„ Consumer è¿›è¡Œæ‹‰å–æ¶ˆæ¯ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚

3ï¼‰æ‹‰å–ç³»ç»Ÿ

ç”±äº Kafka Broker ä¼šæŒä¹…åŒ–æ•°æ®ï¼ŒBroker æ²¡æœ‰å†…å­˜å‹åŠ›ï¼Œå› æ­¤ï¼Œ Consumer éå¸¸é€‚åˆé‡‡å– pull çš„æ–¹å¼æ¶ˆè´¹æ•°æ®ï¼Œå…·æœ‰ä»¥ä¸‹å‡ ç‚¹å¥½å¤„ï¼š

- 1ã€ç®€åŒ– Kafka è®¾è®¡ã€‚
- 2ã€Consumer æ ¹æ®æ¶ˆè´¹èƒ½åŠ›è‡ªä¸»æ§åˆ¶æ¶ˆæ¯æ‹‰å–é€Ÿåº¦ã€‚
- 3ã€Consumer æ ¹æ®è‡ªèº«æƒ…å†µè‡ªä¸»é€‰æ‹©æ¶ˆè´¹æ¨¡å¼ï¼Œä¾‹å¦‚æ‰¹é‡ï¼Œé‡å¤æ¶ˆè´¹ï¼Œä»å°¾ç«¯å¼€å§‹æ¶ˆè´¹ç­‰ã€‚

4ï¼‰å¯æ‰©å±•æ€§

> é€šè¿‡ Zookeeper ç®¡ç† Broker ä¸ Consumer çš„åŠ¨æ€åŠ å…¥ä¸ç¦»å¼€ã€‚

- å½“éœ€è¦å¢åŠ  Broker èŠ‚ç‚¹æ—¶ï¼Œæ–°å¢çš„ Broker ä¼šå‘ Zookeeper æ³¨å†Œï¼Œè€Œ Producer åŠ Consumer ä¼šæ ¹æ®æ³¨å†Œåœ¨ Zookeeper ä¸Šçš„ watcher æ„ŸçŸ¥è¿™äº›å˜åŒ–ï¼Œå¹¶åŠæ—¶ä½œå‡ºè°ƒæ•´ã€‚
- å½“æ–°å¢å’Œåˆ é™¤ Consumer èŠ‚ç‚¹æ—¶ï¼Œç›¸åŒ Topic çš„å¤šä¸ª Partition ä¼šåˆ†é…ç»™å‰©ä½™çš„ Consumer ä»¬ã€‚

å¦å¤–ï¼Œæ¨èé˜…è¯» [ã€Šä¸ºä»€ä¹ˆ Kafka è¿™ä¹ˆå¿«ï¼Ÿã€‹](https://mp.weixin.qq.com/s/pzVS7r3QaQPFwob-fY8b4A) æ–‡ç« ï¼Œå†™çš„æ›´åŠ ç»†è‡´ã€‚

## Kafka çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

![Kafka æ¶æ„å›¾](http://static.iocoder.cn/ac883ce247c1ff31c7cd4244392dcaed)

Kafka çš„æ•´ä½“æ¶æ„éå¸¸ç®€å•ï¼Œæ˜¯åˆ†å¸ƒå¼æ¶æ„ï¼ŒProducerã€Broker å’ŒConsumer éƒ½å¯ä»¥æœ‰å¤šä¸ªã€‚

- Producerï¼ŒConsumer å®ç° Kafka æ³¨å†Œçš„æ¥å£ã€‚
- æ•°æ®ä» Producer å‘é€åˆ° Broker ä¸­ï¼ŒBroker æ‰¿æ‹…ä¸€ä¸ªä¸­é—´ç¼“å­˜å’Œåˆ†å‘çš„ä½œç”¨ã€‚
- Broker åˆ†å‘æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„ Consumerã€‚Broker çš„ä½œç”¨ç±»ä¼¼äºç¼“å­˜ï¼Œå³æ´»è·ƒçš„æ•°æ®å’Œç¦»çº¿å¤„ç†ç³»ç»Ÿä¹‹é—´çš„ç¼“å­˜ã€‚
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„é€šä¿¡ï¼Œæ˜¯åŸºäºç®€å•ï¼Œé«˜æ€§èƒ½ï¼Œä¸”ä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„ TCP åè®®ã€‚

å‡ ä¸ªé‡è¦çš„åŸºæœ¬æ¦‚å¿µï¼š

- Topicï¼šç‰¹æŒ‡ Kafka å¤„ç†çš„æ¶ˆæ¯æºï¼ˆfeeds of messagesï¼‰çš„ä¸åŒåˆ†ç±»ã€‚

- Partitionï¼šTopic ç‰©ç†ä¸Šçš„åˆ†ç»„ï¼ˆåˆ†åŒºï¼‰ï¼Œä¸€ä¸ª Topic å¯ä»¥åˆ†ä¸ºå¤šä¸ª Partition ã€‚æ¯ä¸ª Partition éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ã€‚Partition ä¸­çš„æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæœ‰åºçš„ idï¼ˆoffsetï¼‰ã€‚

  > - replicasï¼šPartition çš„å‰¯æœ¬é›†ï¼Œä¿éšœ Partition çš„é«˜å¯ç”¨ã€‚
  > - leaderï¼šreplicas ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼ŒProducer å’Œ Consumer åªè·Ÿ Leader äº¤äº’ã€‚
  > - followerï¼šreplicas ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œä» leader ä¸­å¤åˆ¶æ•°æ®ï¼Œä½œä¸ºå‰¯æœ¬ï¼Œä¸€æ—¦ leader æŒ‚æ‰ï¼Œä¼šä»å®ƒçš„ followers ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ leader ç»§ç»­æä¾›æœåŠ¡ã€‚

- Messageï¼šæ¶ˆæ¯ï¼Œæ˜¯é€šä¿¡çš„åŸºæœ¬å•ä½ï¼Œæ¯ä¸ª Producer å¯ä»¥å‘ä¸€ä¸ªTopicï¼ˆä¸»é¢˜ï¼‰å‘å¸ƒä¸€äº›æ¶ˆæ¯ã€‚

- Producersï¼šæ¶ˆæ¯å’Œæ•°æ®ç”Ÿäº§è€…ï¼Œå‘ Kafka çš„ä¸€ä¸ª Topic å‘å¸ƒæ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå«åš producers ã€‚

- Consumersï¼šæ¶ˆæ¯å’Œæ•°æ®æ¶ˆè´¹è€…ï¼Œè®¢é˜… Topic ï¼Œå¹¶å¤„ç†å…¶å‘å¸ƒçš„æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå«åš consumers ã€‚

  > Consumer groupï¼šæ¯ä¸ª Consumer éƒ½å±äºä¸€ä¸ª Consumer groupï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½è¢« Consumer group ä¸­çš„ä¸€ä¸ª Consumer æ¶ˆè´¹ï¼Œä½†å¯ä»¥è¢«å¤šä¸ª Consumer group æ¶ˆè´¹ã€‚

- Brokerï¼šç¼“å­˜ä»£ç†ï¼ŒKafka é›†ç¾¤ä¸­çš„ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨ç»Ÿç§°ä¸º broker ã€‚

  > Controllerï¼šKafka é›†ç¾¤ä¸­ï¼Œé€šè¿‡ Zookeeper é€‰ä¸¾æŸä¸ª Broker ä½œä¸º Controller ï¼Œç”¨æ¥è¿›è¡Œ leader election ä»¥åŠ å„ç§ failover ã€‚

- ZooKeeperï¼šKafka é€šè¿‡ ZooKeeper æ¥å­˜å‚¨é›†ç¾¤çš„ Topicã€Partition ç­‰å…ƒä¿¡æ¯ç­‰ã€‚

ğŸ˜ˆ å•çº¯è§’è‰²æ¥è¯´ï¼ŒKafka å’Œ RocketMQ æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚æ¯”è¾ƒæ˜æ˜¾çš„å·®å¼‚æ˜¯ï¼š

> RocketMQ ä» Kafka æ¼”åŒ–è€Œæ¥ã€‚

- 1ã€Kafka ä½¿ç”¨ Zookeeper ä½œä¸ºå‘½åæœåŠ¡ï¼›RocketMQ è‡ªå·±å®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„ Namesrv ã€‚

- 2ã€Kafka Broker çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰ä¸€ä¸ªé¦–é¢†åˆ†åŒºï¼›RocketMQ æ¯ä¸ªåˆ†åŒºçš„â€œé¦–é¢†â€åˆ†åŒºï¼Œéƒ½åœ¨ Broker Master èŠ‚ç‚¹ä¸Šã€‚

  > RocketMQ æ²¡æœ‰é¦–é¢†åˆ†åŒºä¸€è¯´ï¼Œæ‰€ä»¥æ‰“ä¸Šäº†å¼•å·ã€‚

- 3ã€Kafka Consumer ä½¿ç”¨ poll çš„æ–¹å¼æ‹‰å–æ¶ˆæ¯ï¼›RocketMQ Consumer æä¾› poll çš„æ–¹å¼çš„åŒæ—¶ï¼Œå°è£…äº†ä¸€ä¸ª push çš„æ–¹å¼ã€‚

  > RocketMQ çš„ push çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯åŸºäº poll çš„æ–¹å¼çš„å°è£…ã€‚

- â€¦ å½“ç„¶è¿˜æœ‰å…¶å®ƒ â€¦

ğŸ¦… **Kafka ä¸ºä»€ä¹ˆè¦å°† Topic è¿›è¡Œåˆ†åŒºï¼Ÿ**

æ­£å¦‚æˆ‘ä»¬åœ¨ [ã€ŒèŠèŠ Kafka çš„è®¾è®¡è¦ç‚¹ï¼Ÿã€](http://svip.iocoder.cn/Kafka/Interview/#) é—®é¢˜ä¸­æ‰€çœ‹åˆ°çš„ï¼Œæ˜¯ä¸ºäº†è´Ÿè½½å‡è¡¡ï¼Œä»è€Œèƒ½å¤Ÿæ°´å¹³æ‹“å±•ã€‚

- Topic åªæ˜¯é€»è¾‘æ¦‚å¿µï¼Œé¢å‘çš„æ˜¯ Producer å’Œ Consumer ï¼Œè€Œ Partition åˆ™æ˜¯ç‰©ç†æ¦‚å¿µã€‚å¦‚æœ Topic ä¸è¿›è¡Œåˆ†åŒºï¼Œè€Œå°† Topic å†…çš„æ¶ˆæ¯å­˜å‚¨äºä¸€ä¸ª Brokerï¼Œé‚£ä¹ˆå…³äºè¯¥ Topic çš„æ‰€æœ‰è¯»å†™è¯·æ±‚éƒ½å°†ç”±è¿™ä¸€ä¸ª Broker å¤„ç†ï¼Œååé‡å¾ˆå®¹æ˜“é™·å…¥ç“¶é¢ˆï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸ç¬¦åˆé«˜ååé‡åº”ç”¨åœºæ™¯çš„ã€‚
- æœ‰äº† Partition æ¦‚å¿µä»¥åï¼Œå‡è®¾ä¸€ä¸ª Topic è¢«åˆ†ä¸º 10 ä¸ª Partitions ï¼ŒKafka ä¼šæ ¹æ®ä¸€å®šçš„ç®—æ³•å°† 10 ä¸ª Partition å°½å¯èƒ½å‡åŒ€çš„åˆ†å¸ƒåˆ°ä¸åŒçš„ Brokerï¼ˆæœåŠ¡å™¨ï¼‰ä¸Šã€‚
- å½“ Producer å‘å¸ƒæ¶ˆæ¯æ—¶ï¼ŒProducer å®¢æˆ·ç«¯å¯ä»¥é‡‡ç”¨ randomã€key-hash åŠè½®è¯¢ç­‰ç®—æ³•é€‰å®šç›®æ ‡ Partition ï¼Œè‹¥ä¸æŒ‡å®šï¼ŒKafka ä¹Ÿå°†æ ¹æ®ä¸€å®šç®—æ³•å°†å…¶ç½®äºæŸä¸€åˆ†åŒºä¸Šã€‚
- å½“ Consumer æ‹‰å–æ¶ˆæ¯æ—¶ï¼ŒConsumer å®¢æˆ·ç«¯å¯ä»¥é‡‡ç”¨ Rangeã€è½®è¯¢ ç­‰ç®—æ³•åˆ†é… Partition ï¼Œä»è€Œä»ä¸åŒçš„ Broker æ‹‰å–å¯¹åº”çš„ Partition çš„ leader åˆ†åŒºã€‚

æ‰€ä»¥ï¼ŒPartiton æœºåˆ¶å¯ä»¥æå¤§çš„æé«˜ååé‡ï¼Œå¹¶ä¸”ä½¿å¾—ç³»ç»Ÿå…·å¤‡è‰¯å¥½çš„æ°´å¹³æ‰©å±•èƒ½åŠ›ã€‚

## Kafka çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

![Kafka çš„åº”ç”¨åœºæ™¯](http://static.iocoder.cn/3636ff4bd554ee1dfcfb92448073b5b8)

1ï¼‰æ¶ˆæ¯é˜Ÿåˆ—

æ¯”èµ·å¤§å¤šæ•°çš„æ¶ˆæ¯ç³»ç»Ÿæ¥è¯´ï¼ŒKafka æœ‰æ›´å¥½çš„ååé‡ï¼Œå†…ç½®çš„åˆ†åŒºï¼Œå†—ä½™åŠå®¹é”™æ€§ï¼Œè¿™è®© Kafka æˆä¸ºäº†ä¸€ä¸ªå¾ˆå¥½çš„å¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†åº”ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚æ¶ˆæ¯ç³»ç»Ÿä¸€èˆ¬ååé‡ç›¸å¯¹è¾ƒä½ï¼Œä½†æ˜¯éœ€è¦æ›´å°çš„ç«¯åˆ°ç«¯å»¶æ—¶ï¼Œå¹¶å¸¸å¸¸ä¾èµ–äº Kafka æä¾›çš„å¼ºå¤§çš„æŒä¹…æ€§ä¿éšœã€‚åœ¨è¿™ä¸ªé¢†åŸŸï¼ŒKafka è¶³ä»¥åª²ç¾ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿï¼Œå¦‚ ActiveMQ æˆ– RabbitMQ ã€‚

2ï¼‰è¡Œä¸ºè·Ÿè¸ª

Kafka çš„å¦ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œæ˜¯è·Ÿè¸ªç”¨æˆ·æµè§ˆé¡µé¢ã€æœç´¢åŠå…¶ä»–è¡Œä¸ºï¼Œä»¥å‘å¸ƒè®¢é˜…çš„æ¨¡å¼å®æ—¶è®°å½•åˆ°å¯¹åº”çš„ Topic é‡Œã€‚é‚£ä¹ˆè¿™äº›ç»“æœè¢«è®¢é˜…è€…æ‹¿åˆ°åï¼Œå°±å¯ä»¥åšè¿›ä¸€æ­¥çš„å®æ—¶å¤„ç†ï¼Œæˆ–å®æ—¶ç›‘æ§ï¼Œæˆ–æ”¾åˆ° Hadoop / ç¦»çº¿æ•°æ®ä»“åº“é‡Œå¤„ç†ã€‚

3ï¼‰å…ƒä¿¡æ¯ç›‘æ§

ä½œä¸ºæ“ä½œè®°å½•çš„ç›‘æ§æ¨¡å—æ¥ä½¿ç”¨ï¼Œå³æ±‡é›†è®°å½•ä¸€äº›æ“ä½œä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸ºè¿ç»´æ€§è´¨çš„æ•°æ®ç›‘æ§å§ã€‚

4ï¼‰æ—¥å¿—æ”¶é›†

æ—¥å¿—æ”¶é›†æ–¹é¢ï¼Œå…¶å®å¼€æºäº§å“æœ‰å¾ˆå¤šï¼ŒåŒ…æ‹¬ Scribeã€Apache Flume ã€‚å¾ˆå¤šäººä½¿ç”¨ Kafka ä»£æ›¿æ—¥å¿—èšåˆï¼ˆlog aggregationï¼‰ã€‚æ—¥å¿—èšåˆä¸€èˆ¬æ¥è¯´æ˜¯ä»æœåŠ¡å™¨ä¸Šæ”¶é›†æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ªé›†ä¸­çš„ä½ç½®ï¼ˆæ–‡ä»¶æœåŠ¡å™¨æˆ– HDFSï¼‰è¿›è¡Œå¤„ç†ã€‚

ç„¶è€Œï¼Œ Kafka å¿½ç•¥æ‰æ–‡ä»¶çš„ç»†èŠ‚ï¼Œå°†å…¶æ›´æ¸…æ™°åœ°æŠ½è±¡æˆä¸€ä¸ªä¸ªæ—¥å¿—æˆ–äº‹ä»¶çš„æ¶ˆæ¯æµã€‚è¿™å°±è®© Kafka å¤„ç†è¿‡ç¨‹å»¶è¿Ÿæ›´ä½ï¼Œæ›´å®¹æ˜“æ”¯æŒå¤šæ•°æ®æºå’Œåˆ†å¸ƒå¼æ•°æ®å¤„ç†ã€‚æ¯”èµ·ä»¥æ—¥å¿—ä¸ºä¸­å¿ƒçš„ç³»ç»Ÿæ¯”å¦‚ Scribe æˆ–è€… Flume æ¥è¯´ï¼ŒKafka æä¾›åŒæ ·é«˜æ•ˆçš„æ€§èƒ½å’Œå› ä¸ºå¤åˆ¶å¯¼è‡´çš„æ›´é«˜çš„è€ç”¨æ€§ä¿è¯ï¼Œä»¥åŠæ›´ä½çš„ç«¯åˆ°ç«¯å»¶è¿Ÿã€‚

5ï¼‰æµå¤„ç†

è¿™ä¸ªåœºæ™¯å¯èƒ½æ¯”è¾ƒå¤šï¼Œä¹Ÿå¾ˆå¥½ç†è§£ã€‚ä¿å­˜æ”¶é›†æµæ•°æ®ï¼Œä»¥æä¾›ä¹‹åå¯¹æ¥çš„ Storm æˆ–å…¶ä»–æµå¼è®¡ç®—æ¡†æ¶è¿›è¡Œå¤„ç†ã€‚å¾ˆå¤šç”¨æˆ·ä¼šå°†é‚£äº›ä»åŸå§‹ Topic æ¥çš„æ•°æ®è¿›è¡Œé˜¶æ®µæ€§å¤„ç†ï¼Œæ±‡æ€»ï¼Œæ‰©å……æˆ–è€…ä»¥å…¶ä»–çš„æ–¹å¼è½¬æ¢åˆ°æ–°çš„ Topic ä¸‹å†ç»§ç»­åé¢çš„å¤„ç†ã€‚

ä¾‹å¦‚ä¸€ä¸ªæ–‡ç« æ¨èçš„å¤„ç†æµç¨‹ï¼Œå¯èƒ½æ˜¯å…ˆä» RSS æ•°æ®æºä¸­æŠ“å–æ–‡ç« çš„å†…å®¹ï¼Œç„¶åå°†å…¶ä¸¢å…¥ä¸€ä¸ªå«åšâ€œæ–‡ç« â€çš„ Topic ä¸­ã€‚åç»­æ“ä½œå¯èƒ½æ˜¯éœ€è¦å¯¹è¿™ä¸ªå†…å®¹è¿›è¡Œæ¸…ç†ï¼Œæ¯”å¦‚å›å¤æ­£å¸¸æ•°æ®æˆ–è€…åˆ é™¤é‡å¤æ•°æ®ï¼Œæœ€åå†å°†å†…å®¹åŒ¹é…çš„ç»“æœè¿”è¿˜ç»™ç”¨æˆ·ã€‚è¿™å°±åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ Topic ä¹‹å¤–ï¼Œäº§ç”Ÿäº†ä¸€ç³»åˆ—çš„å®æ—¶æ•°æ®å¤„ç†çš„æµç¨‹ã€‚Strom å’Œ Samza æ˜¯éå¸¸è‘—åçš„å®ç°è¿™ç§ç±»å‹æ•°æ®è½¬æ¢çš„æ¡†æ¶ã€‚

6ï¼‰äº‹ä»¶æº

äº‹ä»¶æºï¼Œæ˜¯ä¸€ç§åº”ç”¨ç¨‹åºè®¾è®¡çš„æ–¹å¼ã€‚è¯¥æ–¹å¼çš„çŠ¶æ€è½¬ç§»è¢«è®°å½•ä¸ºæŒ‰æ—¶é—´é¡ºåºæ’åºçš„è®°å½•åºåˆ—ã€‚Kafka å¯ä»¥å­˜å‚¨å¤§é‡çš„æ—¥å¿—æ•°æ®ï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºä¸€ä¸ªå¯¹è¿™ç§æ–¹å¼çš„åº”ç”¨æ¥è¯´ç»ä½³çš„åå°ã€‚æ¯”å¦‚åŠ¨æ€æ±‡æ€»ï¼ˆNews feedï¼‰ã€‚

7ï¼‰æŒä¹…æ€§æ—¥å¿—ï¼ˆCommit Logï¼‰

Kafka å¯ä»¥ä¸ºä¸€ç§å¤–éƒ¨çš„æŒä¹…æ€§æ—¥å¿—çš„åˆ†å¸ƒå¼ç³»ç»Ÿæä¾›æœåŠ¡ã€‚è¿™ç§æ—¥å¿—å¯ä»¥åœ¨èŠ‚ç‚¹é—´å¤‡ä»½æ•°æ®ï¼Œå¹¶ä¸ºæ•…éšœèŠ‚ç‚¹æ•°æ®å›å¤æä¾›ä¸€ç§é‡æ–°åŒæ­¥çš„æœºåˆ¶ã€‚Kafka ä¸­æ—¥å¿—å‹ç¼©åŠŸèƒ½ä¸ºè¿™ç§ç”¨æ³•æä¾›äº†æ¡ä»¶ã€‚åœ¨è¿™ç§ç”¨æ³•ä¸­ï¼ŒKafka ç±»ä¼¼äº Apache BookKeeper é¡¹ç›®ã€‚

## Kafka æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹çš„ç®€åŒ–æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

![Kafka æ¶ˆæ¯å‘é€å’Œæ¶ˆè´¹](http://static.iocoder.cn/456f3adab70714c0a1b1fdbd8a686732)

- 1ã€Producer ï¼Œæ ¹æ®æŒ‡å®šçš„ partition æ–¹æ³•ï¼ˆround-robinã€hashç­‰ï¼‰ï¼Œå°†æ¶ˆæ¯å‘å¸ƒåˆ°æŒ‡å®š Topic çš„ Partition é‡Œé¢ã€‚
- 2ã€Kafka é›†ç¾¤ï¼Œæ¥æ”¶åˆ° Producer å‘è¿‡æ¥çš„æ¶ˆæ¯åï¼Œå°†å…¶æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Œå¹¶ä¿ç•™æ¶ˆæ¯æŒ‡å®šæ—¶é•¿ï¼ˆå¯é…ç½®ï¼‰ï¼Œè€Œä¸å…³æ³¨æ¶ˆæ¯æ˜¯å¦è¢«æ¶ˆè´¹ã€‚
- 3ã€Consumer ï¼Œä» Kafka é›†ç¾¤ pull æ•°æ®ï¼Œå¹¶æ§åˆ¶è·å–æ¶ˆæ¯çš„ offset ã€‚è‡³äºæ¶ˆè´¹çš„è¿›åº¦ï¼Œå¯æ‰‹åŠ¨æˆ–è€…è‡ªåŠ¨æäº¤ç»™ Kafka é›†ç¾¤ã€‚

ğŸ¦… **1ï¼‰Producer å‘é€æ¶ˆæ¯**

Producer é‡‡ç”¨ push æ¨¡å¼å°†æ¶ˆæ¯å‘å¸ƒåˆ° Brokerï¼Œæ¯æ¡æ¶ˆæ¯éƒ½è¢« append åˆ° Patition ä¸­ï¼Œå±äºé¡ºåºå†™ç£ç›˜ï¼ˆé¡ºåºå†™ç£ç›˜æ•ˆç‡æ¯”éšæœºå†™å†…å­˜è¦é«˜ï¼Œä¿éšœ Kafka ååç‡ï¼‰ã€‚Producer å‘é€æ¶ˆæ¯åˆ° Broker æ—¶ï¼Œä¼šæ ¹æ®åˆ†åŒºç®—æ³•é€‰æ‹©å°†å…¶å­˜å‚¨åˆ°å“ªä¸€ä¸ª Partition ã€‚

å…¶è·¯ç”±æœºåˆ¶ä¸ºï¼š

- 1ã€æŒ‡å®šäº† Partition ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ã€‚
- 2ã€æœªæŒ‡å®š Partition ä½†æŒ‡å®š key ï¼Œé€šè¿‡å¯¹ key è¿›è¡Œ hash é€‰å‡ºä¸€ä¸ª Partition ã€‚
- 3ã€Partition å’Œ key éƒ½æœªæŒ‡å®šï¼Œä½¿ç”¨è½®è¯¢é€‰å‡ºä¸€ä¸ª Partition ã€‚

å†™å…¥æµç¨‹ï¼š

- 1ã€Producer å…ˆä» ZooKeeper çš„ `"/brokers/.../state"` èŠ‚ç‚¹æ‰¾åˆ°è¯¥ Partition çš„ leader ã€‚

  > æ³¨æ„å™¢ï¼ŒProducer åªå’Œ Partition çš„ leader è¿›è¡Œäº¤äº’ã€‚

- 2ã€Producer å°†æ¶ˆæ¯å‘é€ç»™è¯¥ leader ã€‚

- 3ã€leader å°†æ¶ˆæ¯å†™å…¥æœ¬åœ° log ã€‚

- 4ã€followers ä» leader pull æ¶ˆæ¯ï¼Œå†™å…¥æœ¬åœ° log å leader å‘é€ ACK ã€‚

- 5ã€leader æ”¶åˆ°æ‰€æœ‰ ISR ä¸­çš„ replica çš„ ACK åï¼Œå¢åŠ  HWï¼ˆhigh watermark ï¼Œæœ€å commit çš„ offsetï¼‰ å¹¶å‘ Producer å‘é€ ACK ã€‚

ğŸ¦… **2ï¼‰Broker å­˜å‚¨æ¶ˆæ¯**

ç‰©ç†ä¸ŠæŠŠ Topic åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ª Patitionï¼Œæ¯ä¸ª Patition ç‰©ç†ä¸Šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆè¯¥æ–‡ä»¶å¤¹å­˜å‚¨è¯¥ Patition çš„æ‰€æœ‰æ¶ˆæ¯å’Œç´¢å¼•æ–‡ä»¶ï¼‰ã€‚

ğŸ¦… **3ï¼‰Consumer æ¶ˆè´¹æ¶ˆæ¯**

high-level Consumer API æä¾›äº† consumer group çš„è¯­ä¹‰ï¼Œä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢« group å†…çš„ä¸€ä¸ª Consumer æ‰€æ¶ˆè´¹ï¼Œä¸” Consumer æ¶ˆè´¹æ¶ˆæ¯æ—¶ä¸å…³æ³¨ offset ï¼Œæœ€åä¸€ä¸ª offset ç”± ZooKeeper ä¿å­˜ï¼ˆä¸‹æ¬¡æ¶ˆè´¹æ—¶ï¼Œè¯¥ group ä¸­çš„ Consumer å°†ä» offset è®°å½•çš„ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼‰ã€‚

æ³¨æ„ï¼š

- 1ã€å¦‚æœæ¶ˆè´¹çº¿ç¨‹å¤§äº Patition æ•°é‡ï¼Œåˆ™æœ‰äº›çº¿ç¨‹å°†æ”¶ä¸åˆ°æ¶ˆæ¯ã€‚
- 2ã€å¦‚æœ Patition æ•°é‡å¤§äºæ¶ˆè´¹çº¿ç¨‹æ•°ï¼Œåˆ™æœ‰äº›çº¿ç¨‹å¤šæ”¶åˆ°å¤šä¸ª Patition çš„æ¶ˆæ¯ã€‚
- 3ã€å¦‚æœä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹å¤šä¸ª Patitionï¼Œåˆ™æ— æ³•ä¿è¯ä½ æ”¶åˆ°çš„æ¶ˆæ¯çš„é¡ºåºï¼Œè€Œä¸€ä¸ª Patition å†…çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ã€‚

Consumer é‡‡ç”¨ pull æ¨¡å¼ä» Broker ä¸­è¯»å–æ•°æ®ã€‚

- push æ¨¡å¼ï¼Œå¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ¶ˆæ¯å‘é€é€Ÿç‡æ˜¯ç”± Broker å†³å®šçš„ã€‚å®ƒçš„ç›®æ ‡æ˜¯å°½å¯èƒ½ä»¥æœ€å¿«é€Ÿåº¦ä¼ é€’æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ ·å¾ˆå®¹æ˜“é€ æˆ Consumer æ¥ä¸åŠå¤„ç†æ¶ˆæ¯ï¼Œå…¸å‹çš„è¡¨ç°å°±æ˜¯æ‹’ç»æœåŠ¡ä»¥åŠç½‘ç»œæ‹¥å¡ã€‚è€Œ pull æ¨¡å¼ï¼Œåˆ™å¯ä»¥æ ¹æ® Consumer çš„æ¶ˆè´¹èƒ½åŠ›ä»¥é€‚å½“çš„é€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ã€‚
- å¯¹äº Kafka è€Œè¨€ï¼Œpull æ¨¡å¼æ›´åˆé€‚ï¼Œå®ƒå¯ç®€åŒ– Broker çš„è®¾è®¡ï¼ŒConsumer å¯è‡ªä¸»æ§åˆ¶æ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿç‡ï¼ŒåŒæ—¶ Consumer å¯ä»¥è‡ªå·±æ§åˆ¶æ¶ˆè´¹æ–¹å¼â€”â€”å³å¯æ‰¹é‡æ¶ˆè´¹ä¹Ÿå¯é€æ¡æ¶ˆè´¹ï¼ŒåŒæ—¶è¿˜èƒ½é€‰æ‹©ä¸åŒçš„æäº¤æ–¹å¼ä»è€Œå®ç°ä¸åŒçš„ä¼ è¾“è¯­ä¹‰ã€‚

ğŸ¦… **Kafka Producer æœ‰å“ªäº›å‘é€æ¨¡å¼ï¼Ÿ**

Kafka çš„å‘é€æ¨¡å¼ç”± Producer ç«¯çš„é…ç½®å‚æ•° `producer.type`æ¥è®¾ç½®ã€‚

- è¿™ä¸ªå‚æ•°æŒ‡å®šäº†åœ¨åå°çº¿ç¨‹ä¸­æ¶ˆæ¯çš„å‘é€æ–¹å¼æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Œé»˜è®¤æ˜¯åŒæ­¥çš„æ–¹å¼ï¼Œå³ `producer.type=sync` ã€‚
- å¦‚æœè®¾ç½®æˆå¼‚æ­¥çš„æ¨¡å¼ï¼Œå³ `producer.type=async` ï¼Œå¯ä»¥æ˜¯ Producer ä»¥ batch çš„å½¢å¼ push æ•°æ®ï¼Œè¿™æ ·ä¼šæå¤§çš„æé«˜ Brokerçš„æ€§èƒ½ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¢åŠ ä¸¢å¤±æ•°æ®çš„é£é™©ã€‚
- å¦‚æœéœ€è¦ç¡®ä¿æ¶ˆæ¯çš„å¯é æ€§ï¼Œå¿…é¡»è¦å°† `producer.type`è®¾ç½®ä¸º sync ã€‚

å¯¹äºå¼‚æ­¥æ¨¡å¼ï¼Œè¿˜æœ‰ 4 ä¸ªé…å¥—çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š

![å‚æ•°](http://static.iocoder.cn/792a59a9b2b4f271c179e81cf4278322)

- ä»¥ batch çš„æ–¹å¼æ¨é€æ•°æ®å¯ä»¥æå¤§çš„æé«˜å¤„ç†æ•ˆç‡ï¼ŒKafka Producer å¯ä»¥å°†æ¶ˆæ¯åœ¨å†…å­˜ä¸­ç´¯è®¡åˆ°ä¸€å®šæ•°é‡åä½œä¸ºä¸€ä¸ª batch å‘é€è¯·æ±‚ã€‚batch çš„æ•°é‡å¤§å°å¯ä»¥é€šè¿‡ Producer çš„å‚æ•°ï¼ˆ`batch.num.messages`ï¼‰æ§åˆ¶ã€‚é€šè¿‡å¢åŠ  batch çš„å¤§å°ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚å’Œç£ç›˜ IO çš„æ¬¡æ•°ï¼Œå½“ç„¶å…·ä½“å‚æ•°è®¾ç½®éœ€è¦åœ¨æ•ˆç‡å’Œæ—¶æ•ˆæ€§æ–¹é¢åšä¸€ä¸ªæƒè¡¡ã€‚

- åœ¨æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰`batch.size`è¿™ä¸ªå‚æ•°ã€‚Producer ä¼šå°è¯•æ‰¹é‡å‘é€å±äºåŒä¸€ä¸ª Partition çš„æ¶ˆæ¯ä»¥å‡å°‘è¯·æ±‚çš„æ•°é‡. è¿™æ ·å¯ä»¥æå‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ€§èƒ½ã€‚é»˜è®¤å¤§å°æ˜¯ 16348 byte (16k).

  - å‘é€åˆ° Broker çš„è¯·æ±‚å¯ä»¥åŒ…å«å¤šä¸ª batch ï¼Œæ¯ä¸ª batch çš„æ•°æ®å±äºåŒä¸€ä¸ª Partition ã€‚
- å¤ªå°çš„ batch ä¼šé™ä½åå. å¤ªå¤§ä¼šæµªè´¹å†…å­˜ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ3. å¿«é€Ÿå…¥é—¨ã€](http://svip.iocoder.cn/Kafka/Interview/#)å’Œ[ã€Œ4. æ‰¹é‡å‘é€æ¶ˆæ¯ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

ğŸ¦… **Kafka Consumer æ˜¯å¦å¯ä»¥æ¶ˆè´¹æŒ‡å®šçš„åˆ†åŒºæ¶ˆæ¯ï¼Ÿ**

Consumer æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå‘ Broker å‘å‡ºâ€œfetchâ€è¯·æ±‚å»æ¶ˆè´¹ç‰¹å®šåˆ†åŒºçš„æ¶ˆæ¯ï¼ŒConsumer æŒ‡å®šæ¶ˆæ¯åœ¨æ—¥å¿—ä¸­çš„åç§»é‡(offset)ï¼Œå°±å¯ä»¥æ¶ˆè´¹ä»è¿™ä¸ªä½ç½®å¼€å§‹çš„æ¶ˆæ¯ï¼ŒConsumer æ‹¥æœ‰äº† offset çš„æ§åˆ¶æƒï¼Œå¯ä»¥å‘åå›æ»šå»é‡æ–°æ¶ˆè´¹ä¹‹å‰çš„æ¶ˆæ¯ï¼Œè¿™æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚

ğŸ¦… **Kafka çš„ high-level API å’Œ low-level API çš„åŒºåˆ«ï¼Ÿ**

High Level API

- å±è”½äº†æ¯ä¸ª Topic çš„æ¯ä¸ª Partition çš„ offset ç®¡ç†ï¼ˆè‡ªåŠ¨è¯»å–Zookeeper ä¸­è¯¥ Consumer group çš„ last offsetï¼‰ã€Broker å¤±è´¥è½¬ç§»ã€ä»¥åŠå¢å‡ Partition æ—¶ Consumer æ—¶çš„è´Ÿè½½å‡è¡¡ï¼ˆKafka è‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼‰ã€‚
- å¦‚æœ Consumer æ¯” Partition å¤šï¼Œæ˜¯ä¸€ç§æµªè´¹ã€‚ä¸€ä¸ª Partition ä¸Šæ˜¯ä¸å…è®¸å¹¶å‘çš„ï¼Œæ‰€ä»¥ Consumer æ•°ä¸è¦å¤§äº Partition æ•°ã€‚

Low Level API

> Low-level API ä¹Ÿå°±æ˜¯ Simple Consumer API ï¼Œå®é™…ä¸Šéå¸¸å¤æ‚ã€‚

- API æ§åˆ¶æ›´çµæ´»ï¼Œä¾‹å¦‚æ¶ˆæ¯é‡å¤è¯»å–ï¼Œæ¶ˆæ¯ offset è·³è¯»ï¼ŒExactly Once åŸè¯­ã€‚
- API æ›´å¤æ‚ï¼Œoffset ä¸å†é€æ˜ï¼Œéœ€è¦è‡ªå·±ç®¡ç†ï¼ŒBroker è‡ªåŠ¨å¤±è´¥è½¬ç§»éœ€è¦å¤„ç†ï¼Œå¢åŠ  Consumerã€Partitionã€Broker éœ€è¦è‡ªå·±åšè´Ÿè½½å‡è¡¡ã€‚

## Kafka çš„ç½‘ç»œæ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

Kafka åŸºäºé«˜ååç‡å’Œæ•ˆç‡è€ƒè™‘ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹ç½‘ç»œæ¡†æ¶ï¼Œè€Œä¸”è‡ªå·±åŸºäº Java NIO å°è£…çš„ã€‚

ğŸ¦… **1ï¼‰KafkaClient ï¼Œå•çº¿ç¨‹ Selector æ¨¡å‹ã€‚**

![KafkaClient](http://static.iocoder.cn/00e8ec59cf40c62db53b4d66dc45e17c)

> å®é™…ä¸Šï¼Œå°±æ˜¯ NettyClient çš„ NIO æ–¹å¼ã€‚

- å•çº¿ç¨‹æ¨¡å¼é€‚ç”¨äºå¹¶å‘é“¾æ¥æ•°å°ï¼Œé€»è¾‘ç®€å•ï¼Œæ•°æ®é‡å°ã€‚
- åœ¨ Kafka ä¸­ï¼ŒConsumer å’Œ Producer éƒ½æ˜¯ä½¿ç”¨çš„ä¸Šé¢çš„å•çº¿ç¨‹æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ä¸é€‚åˆ Kafka çš„æœåŠ¡ç«¯ï¼Œåœ¨æœåŠ¡ç«¯ä¸­è¯·æ±‚å¤„ç†è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œä¸€æ—¦å‡ºç°åç»­è¯·æ±‚å°±ä¼šæ— æ³•å¤„ç†ï¼Œä¼šé€ æˆå¤§é‡è¯·æ±‚è¶…æ—¶ï¼Œå¼•èµ·é›ªå´©ã€‚è€Œåœ¨æœåŠ¡å™¨ä¸­åº”è¯¥å……åˆ†åˆ©ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†æ‰§è¡Œé€»è¾‘ã€‚

ğŸ¦… **2ï¼‰KafkaServer ï¼Œå¤šçº¿ç¨‹ Selector æ¨¡å‹ã€‚**

> KafkaServer ï¼ŒæŒ‡çš„æ˜¯ Kafka Broker ã€‚

![KafkaServer](http://static.iocoder.cn/8493bc98876609462fba617d520d1b9a)

Broker çš„å†…éƒ¨å¤„ç†æµæ°´çº¿åŒ–ï¼Œåˆ†ä¸ºå¤šä¸ªé˜¶æ®µæ¥è¿›è¡Œ(SEDA)ï¼Œä»¥æé«˜ååé‡å’Œæ€§èƒ½ï¼Œå°½é‡é¿å… Thead ç›²ç­‰å¾…ï¼Œä»¥ä¸‹ä¸ºè¿‡ç¨‹è¯´æ˜ã€‚

> å®é™…ä¸Šï¼Œå°±æ˜¯ NettyServer çš„ NIO æ–¹å¼ã€‚

- Accept Thread è´Ÿè´£ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥é“¾è·¯ï¼Œç„¶åæŠŠ Socket è½®è½¬äº¤ç»™Process Thread ã€‚

  > ç›¸å½“äº Netty çš„ Boss EventLoop ã€‚

- Process Thread è´Ÿè´£æ¥æ”¶è¯·æ±‚å’Œå“åº”æ•°æ®ï¼ŒProcess Thread æ¯æ¬¡åŸºäº Selector äº‹ä»¶å¾ªç¯ï¼Œé¦–å…ˆä» Response Queue è¯»å–å“åº”æ•°æ®ï¼Œå‘å®¢æˆ·ç«¯å›å¤å“åº”ï¼Œç„¶åæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œè¯»å–æ•°æ®æ”¾å…¥ Request Queue ã€‚

  > ç›¸å½“äº Netty çš„ Worker EventLoop ã€‚

- Work Thread è´Ÿè´£ä¸šåŠ¡é€»è¾‘ã€IO ç£ç›˜å¤„ç†ç­‰ï¼Œè´Ÿè´£ä» Request Queue è¯»å–è¯·æ±‚ï¼Œå¹¶æŠŠå¤„ç†ç»“æœæ”¾å…¥ Response Queue ä¸­ï¼Œå¾… Process Thread å‘é€å‡ºå»ã€‚

  > ç›¸å½“äºä¸šåŠ¡çº¿ç¨‹æ± ã€‚

ğŸ˜ˆ å®é™…ä¸Šï¼Œè‰¿è‰¿çš„æƒ³æ³•ï¼Œå¦‚æœè‡ªå·±å®ç° MQ ï¼Œå®Œå…¨å¯ä»¥ç›´æ¥ä½¿ç”¨ Netty ä½œä¸ºç½‘ç»œé€šä¿¡æ¡†æ¶ã€‚åŒ…æ‹¬ï¼ŒRocketMQ å°±æ˜¯å¦‚æ­¤å®ç°çš„ã€‚

ğŸ¦… **è§£é‡Šå¦‚ä½•æé«˜è¿œç¨‹ç”¨æˆ·çš„ååé‡?**

å¦‚æœ Producerã€Consumer ä½äºä¸ Broker ä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œåˆ™å¯èƒ½éœ€è¦è°ƒä¼˜å¥—æ¥å£ç¼“å†²åŒºå¤§å°ï¼Œä»¥å¯¹é•¿ç½‘ç»œå»¶è¿Ÿè¿›è¡Œæ‘Šé”€ã€‚

## Kafka çš„æ•°æ®å­˜å‚¨æ¨¡å‹æ˜¯æ€ä¹ˆæ ·çš„?

Kafka æ¯ä¸ª Topic ä¸‹é¢çš„æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ä»¥ Partition çš„æ–¹å¼åˆ†å¸ƒå¼çš„å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚åŒæ—¶åœ¨ Kafka çš„æœºå™¨ä¸Šï¼Œæ¯ä¸ª Partition å…¶å®éƒ½ä¼šå¯¹åº”ä¸€ä¸ªæ—¥å¿—ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹é¢ä¼šå¯¹åº”å¤šä¸ªæ—¥å¿—åˆ†æ®µï¼ˆLogSegmentï¼‰ã€‚

```
MacBook-Pro-5:test-0 yunai$ ls
00000000000000000000.index	00000000000000000000.timeindex	leader-epoch-checkpoint
00000000000000000000.log	00000000000000000004.snapshot
```

- Topic ä¸º `test` ï¼ŒPartition ä¸º 0 ï¼Œæ‰€ä»¥æ–‡ä»¶ç›®å½•æ˜¯ `test-0` ã€‚

LogSegment æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸º `.index` æ–‡ä»¶å’Œ `.log` æ–‡ä»¶ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸º segment **ç´¢å¼•**æ–‡ä»¶å’Œ**æ•°æ®**æ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶çš„å‘½ä»¤è§„åˆ™ä¸ºï¼šPartition å…¨å±€çš„ç¬¬ä¸€ä¸ª segment ä» 0 å¼€å§‹ï¼Œåç»­æ¯ä¸ª segment æ–‡ä»¶åä¸ºä¸Šä¸€ä¸ª segment æ–‡ä»¶æœ€åä¸€æ¡æ¶ˆæ¯çš„ offset å€¼ï¼Œæ•°å€¼å¤§å°ä¸º 64 ä½ï¼Œ20 ä½æ•°å­—å­—ç¬¦é•¿åº¦ï¼Œæ²¡æœ‰æ•°å­—ç”¨ 0 å¡«å……ï¼Œå¦‚ä¸‹ï¼Œå‡è®¾æœ‰ 1000 æ¡æ¶ˆæ¯ï¼Œæ¯ä¸ª LogSegment å¤§å°ä¸º 100 ï¼Œä¸‹é¢å±•ç°äº† 900-1000 çš„ `.index` å’Œ `.log` æ–‡ä»¶ï¼š

[`.index` å’Œ `.log` æ–‡ä»¶](https://user-gold-cdn.xitu.io/2018/7/24/164ca4f7e778be7c?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

- ç”±äº Kafka æ¶ˆæ¯æ•°æ®å¤ªå¤§ï¼Œå¦‚æœå…¨éƒ¨å»ºç«‹ç´¢å¼•ï¼Œå³å äº†ç©ºé—´åˆå¢åŠ äº†è€—æ—¶ï¼Œæ‰€ä»¥ Kafka é€‰æ‹©äº†ç¨€ç–ç´¢å¼•çš„æ–¹å¼ï¼ˆé€šè¿‡ `.index` ç´¢å¼• `.log` æ–‡ä»¶ï¼‰ï¼Œè¿™æ ·çš„è¯ç´¢å¼•å¯ä»¥ç›´æ¥è¿›å…¥å†…å­˜ï¼ŒåŠ å¿«åæŸ¥è¯¢é€Ÿåº¦ã€‚

ğŸ¦… **ç®€å•ä»‹ç»ä¸€ä¸‹å¦‚ä½•è¯»å–æ•°æ®ï¼Ÿ**

å¦‚æœæˆ‘ä»¬è¦è¯»å–ç¬¬ 911 æ¡æ•°æ®ã€‚

- é¦–å…ˆç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°å®ƒæ˜¯å±äºå“ªä¸€æ®µçš„ï¼Œæ ¹æ®äºŒåˆ†æ³•æŸ¥æ‰¾åˆ°ä»–å±äºçš„æ–‡ä»¶ï¼Œæ‰¾åˆ° `0000900.index` å’Œ `00000900.log` ä¹‹åã€‚

- ç„¶åï¼Œå» `.index` ä¸­å»æŸ¥æ‰¾ `(911-900) =11` è¿™ä¸ªç´¢å¼•æˆ–è€…å°äº 11 æœ€è¿‘çš„ç´¢å¼•ï¼Œåœ¨è¿™é‡Œé€šè¿‡äºŒåˆ†æ³•æˆ‘ä»¬æ‰¾åˆ°äº†ç´¢å¼•æ˜¯ `[10,1367]` ã€‚

  > - 10 è¡¨ç¤ºï¼Œç¬¬ 10 æ¡æ¶ˆæ¯å¼€å§‹ã€‚
  > - 1367 è¡¨ç¤ºï¼Œåœ¨ `.log` çš„ç¬¬ 1367 å­—èŠ‚å¼€å§‹ã€‚
  >
  > ğŸ˜ˆ æ‰€ä»¥ï¼Œæœ¬å›¾çš„ç¬¬ 911 æ¡çš„â€œ1360â€æ˜¯é”™çš„ï¼Œç›¸æ¯”â€œ1367â€ åå€’å°äº†ã€‚

- ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡è¿™æ¡ç´¢å¼•çš„ç‰©ç†ä½ç½® 1367 ï¼Œå¼€å§‹å¾€åæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ° 911 æ¡æ•°æ®ã€‚

ä¸Šé¢è®²çš„æ˜¯å¦‚æœè¦æ‰¾æŸä¸ª offset çš„æµç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¤§å¤šæ•°æ—¶å€™å¹¶ä¸éœ€è¦æŸ¥æ‰¾æŸä¸ª offset ï¼Œåªéœ€è¦æŒ‰ç…§é¡ºåºè¯»å³å¯ã€‚è€Œåœ¨é¡ºåºè¯»ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¼šå¯¹å†…å­˜å’Œç£ç›˜ä¹‹é—´æ·»åŠ  page cahe ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸è§åˆ°çš„é¢„è¯»æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é¡ºåºè¯»æ“ä½œæ—¶é€Ÿåº¦å¾ˆå¿«ã€‚ä½†æ˜¯ Kafka æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœåˆ†åŒºè¿‡å¤šï¼Œé‚£ä¹ˆæ—¥å¿—åˆ†æ®µä¹Ÿä¼šå¾ˆå¤šï¼Œå†™çš„æ—¶å€™ç”±äºæ˜¯æ‰¹é‡å†™ï¼Œå…¶å®å°±ä¼šå˜æˆéšæœºå†™äº†ï¼Œéšæœº I/O è¿™ä¸ªæ—¶å€™å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ Kafka ä¸èƒ½æœ‰å¤ªå¤šçš„Partition ã€‚é’ˆå¯¹è¿™ä¸€ç‚¹ï¼ŒRocketMQ æŠŠæ‰€æœ‰çš„æ—¥å¿—éƒ½å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œå°±èƒ½å˜æˆé¡ºåºå†™ï¼Œé€šè¿‡ä¸€å®šä¼˜åŒ–ï¼Œè¯»ä¹Ÿèƒ½æ¥è¿‘äºé¡ºåºè¯»ã€‚

> å¹¶ä¸”ï¼Œæˆªæ­¢åˆ° RocketMQ4 ç‰ˆæœ¬ï¼Œç´¢å¼•æ–‡ä»¶ï¼Œå¯¹æ¯ä¸ªæ•°æ®æ–‡ä»¶ä¸­çš„æ¶ˆæ¯ï¼Œéƒ½æœ‰å¯¹åº”çš„ç´¢å¼•ã€‚è¿™ä¸ªæ˜¯å’Œ Kafka çš„ç¨€ç–ç´¢å¼•ä¸å¤ªä¸€æ ·çš„åœ°æ–¹ã€‚

æ›´è¯¦å°½çš„ï¼Œæ¨èé˜…è¯» [ã€ŠKafka ä¹‹æ•°æ®å­˜å‚¨ã€‹](http://matt33.com/2016/03/08/kafka-store/) æ–‡ç« ã€‚

ğŸ¦… **ä¸ºä»€ä¹ˆä¸èƒ½ä»¥ Partition ä½œä¸ºå­˜å‚¨å•ä½ï¼Ÿ**

å¦‚æœå°±ä»¥ Partition ä¸ºæœ€å°å­˜å‚¨å•ä½ï¼Œå¯ä»¥æƒ³è±¡ï¼Œå½“ Kafka Producer ä¸æ–­å‘é€æ¶ˆæ¯ï¼Œå¿…ç„¶ä¼šå¼•èµ· Partition æ–‡ä»¶çš„æ— é™æ‰©å¼ ï¼Œå°†å¯¹æ¶ˆæ¯æ–‡ä»¶çš„ç»´æŠ¤ä»¥åŠå·²æ¶ˆè´¹çš„æ¶ˆæ¯çš„æ¸…ç†å¸¦æ¥ä¸¥é‡çš„å½±å“ï¼Œå› æ­¤ï¼Œéœ€ä»¥ segment ä¸ºå•ä½å°† Partition è¿›ä¸€æ­¥ç»†åˆ†ã€‚

æ¯ä¸ª Partitionï¼ˆç›®å½•ï¼‰ç›¸å½“äºä¸€ä¸ªå·¨å‹æ–‡ä»¶ï¼Œè¢«å¹³å‡åˆ†é…åˆ°å¤šä¸ªå¤§å°ç›¸ç­‰çš„ segmentï¼ˆæ®µï¼‰æ•°æ®æ–‡ä»¶ä¸­ï¼ˆæ¯ä¸ª segment æ–‡ä»¶ä¸­æ¶ˆæ¯æ•°é‡ä¸ä¸€å®šç›¸ç­‰ï¼‰ï¼Œè¿™ç§ç‰¹æ€§ä¹Ÿæ–¹ä¾¿ old segment çš„åˆ é™¤ï¼Œå³æ–¹ä¾¿å·²è¢«æ¶ˆè´¹çš„æ¶ˆæ¯çš„æ¸…ç†ï¼Œæé«˜ç£ç›˜çš„åˆ©ç”¨ç‡ã€‚æ¯ä¸ª Partition åªéœ€è¦æ”¯æŒé¡ºåºè¯»å†™å°±è¡Œï¼Œsegment çš„æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç”±æœåŠ¡ç«¯é…ç½®å‚æ•°ï¼ˆ`log.segment.bytes`ï¼Œ`log.roll.{ms,hours}` ç­‰è‹¥å¹²å‚æ•°ï¼‰å†³å®šã€‚

## Kafka çš„æ¶ˆæ¯æ ¼å¼æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

message ä¸­çš„ç‰©ç†ç»“æ„ä¸ºï¼š

![message ç‰©ç†ç»“æ„](http://static.iocoder.cn/a034ab2df1d5b67520432355e0bbf95b)

å‚æ•°è¯´æ˜ï¼š

| å…³é”®å­—              | è§£é‡Šè¯´æ˜                                                     |
| :------------------ | :----------------------------------------------------------- |
| 8 byte offset       | åœ¨parition(åˆ†åŒº)å†…çš„æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªæœ‰åºçš„idå·ï¼Œè¿™ä¸ªidå·è¢«ç§°ä¸ºåç§»(offset),å®ƒå¯ä»¥å”¯ä¸€ç¡®å®šæ¯æ¡æ¶ˆæ¯åœ¨parition(åˆ†åŒº)å†…çš„ä½ç½®ã€‚å³offsetè¡¨ç¤ºpartiionçš„ç¬¬å¤šå°‘message |
| 4 byte message size | messageå¤§å°                                                  |
| 4 byte CRC32        | ç”¨crc32æ ¡éªŒmessage                                           |
| 1 byte â€œmagicâ€      | è¡¨ç¤ºæœ¬æ¬¡å‘å¸ƒKafkaæœåŠ¡ç¨‹åºåè®®ç‰ˆæœ¬å·                          |
| 1 byte â€œattributesâ€ | è¡¨ç¤ºä¸ºç‹¬ç«‹ç‰ˆæœ¬ã€æˆ–æ ‡è¯†å‹ç¼©ç±»å‹ã€æˆ–ç¼–ç ç±»å‹                   |
| 4 byte key length   | è¡¨ç¤ºkeyçš„é•¿åº¦,å½“keyä¸º-1æ—¶ï¼ŒK byte keyå­—æ®µä¸å¡«                |
| K byte key          | å¯é€‰                                                         |
| value bytes payload | è¡¨ç¤ºå®é™…æ¶ˆæ¯æ•°æ®                                             |

ä¸è¿‡ï¼Œè¿™æ˜¯æ—©æœŸ Kafka çš„ç‰ˆæœ¬ï¼Œæœ€æ–°ç‰ˆæœ¬çš„æ ¼å¼ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€Šä¸€æ–‡çœ‹æ‡‚ Kafka æ¶ˆæ¯æ ¼å¼çš„æ¼”å˜ã€‹](http://www.iocoder.cn/Kafka/message-format/?vip)
- [ã€ŠKafka æ¶ˆæ¯æ ¼å¼ä¸­çš„å˜é•¿å­—æ®µï¼ˆVarintsï¼‰ã€‹](http://www.iocoder.cn/Kafka/varints/)

å½“ç„¶ï¼Œçœ‹æ‡‚è¿™ä¸ªæ•°æ®æ ¼å¼ï¼ŒåŸºæœ¬ä¹Ÿèƒ½çŸ¥é“æ¶ˆæ¯çš„å¤§ä½“æ ¼å¼ã€‚

## Kafka çš„å‰¯æœ¬æœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

Kafka çš„å‰¯æœ¬æœºåˆ¶ï¼Œæ˜¯å¤šä¸ª Broker èŠ‚ç‚¹å¯¹å…¶ä»–èŠ‚ç‚¹çš„ Topic åˆ†åŒºçš„æ—¥å¿—è¿›è¡Œå¤åˆ¶ã€‚å½“é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œè®¿é—®æ•…éšœèŠ‚ç‚¹çš„è¯·æ±‚ä¼šè¢«è½¬ç§»åˆ°å…¶ä»–æ­£å¸¸èŠ‚ç‚¹(è¿™ä¸€è¿‡ç¨‹é€šå¸¸å« Reblance)ï¼ŒKafka æ¯ä¸ªä¸»é¢˜çš„æ¯ä¸ªåˆ†åŒºéƒ½æœ‰ä¸€ä¸ªä¸»å‰¯æœ¬ä»¥åŠ 0 ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬ï¼Œå‰¯æœ¬ä¿æŒå’Œä¸»å‰¯æœ¬çš„æ•°æ®åŒæ­¥ï¼Œå½“ä¸»å‰¯æœ¬å‡ºæ•…éšœæ—¶å°±ä¼šè¢«æ›¿ä»£ã€‚

![å‰¯æœ¬æœºåˆ¶](http://static.iocoder.cn/1f42986437f76c108007e86a51ae1287)

> æ³¨æ„å“ˆï¼Œä¸‹é¢è¯´çš„ Leader æŒ‡çš„æ˜¯æ¯ä¸ª Topic çš„æŸä¸ªåˆ†åŒºçš„ Leader ï¼Œè€Œä¸æ˜¯ Broker é›†ç¾¤ä¸­çš„ã€é›†ç¾¤æ§åˆ¶å™¨ã€‘ã€‚

åœ¨ Kafka ä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‰¯æœ¬éƒ½èƒ½è¢«æ‹¿æ¥æ›¿ä»£ä¸»å‰¯æœ¬ï¼Œæ‰€ä»¥åœ¨ Kafka çš„Leader èŠ‚ç‚¹ä¸­ç»´æŠ¤ç€ä¸€ä¸ª ISRï¼ˆIn sync Replicasï¼‰é›†åˆï¼Œç¿»è¯‘è¿‡æ¥ä¹Ÿå«æ­£åœ¨åŒæ­¥ä¸­é›†åˆï¼Œåœ¨è¿™ä¸ªé›†åˆä¸­çš„éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶:

- 1ã€èŠ‚ç‚¹å¿…é¡»å’Œ Zookeeper ä¿æŒè¿æ¥ã€‚
- 2ã€åœ¨åŒæ­¥çš„è¿‡ç¨‹ä¸­è¿™ä¸ªå‰¯æœ¬ä¸èƒ½è½åä¸»å‰¯æœ¬å¤ªå¤šã€‚

å¦å¤–è¿˜æœ‰ä¸ª ARï¼ˆAssigned Replicasï¼‰ç”¨æ¥æ ‡è¯†å‰¯æœ¬çš„å…¨é›†ï¼ŒOSR ç”¨æ¥è¡¨ç¤ºç”±äºè½åè¢«å‰”é™¤çš„å‰¯æœ¬é›†åˆï¼Œæ‰€ä»¥å…¬å¼å¦‚ä¸‹ï¼š

- ISR = Leader + æ²¡æœ‰è½åå¤ªå¤šçš„å‰¯æœ¬ã€‚
- AR = OSR + ISR ã€‚

è¿™é‡Œå…ˆè¦è¯´ä¸‹ä¸¤ä¸ªåè¯ï¼šHW å’Œ LEO ã€‚

- HWï¼ˆé«˜æ°´ä½ HighWatermarkï¼‰ï¼Œæ˜¯ Consumer èƒ½å¤Ÿçœ‹åˆ°çš„æ­¤ Partition çš„ä½ç½®ã€‚
- LEOï¼ˆlogEndOffsetï¼‰ï¼Œæ˜¯æ¯ä¸ª Partition çš„ log æœ€åä¸€æ¡ Message çš„ä½ç½®ã€‚
- HW èƒ½ä¿è¯ Leader æ‰€åœ¨çš„ Broker å¤±æ•ˆï¼Œè¯¥æ¶ˆæ¯ä»ç„¶å¯ä»¥ä»æ–°é€‰ä¸¾çš„Leader ä¸­è·å–ï¼Œä¸ä¼šé€ æˆæ¶ˆæ¯ä¸¢å¤±ã€‚

å½“ Producer å‘ Leader å‘é€æ•°æ®æ—¶ï¼Œå¯ä»¥é€šè¿‡`request.required.acks` å‚æ•°æ¥è®¾ç½®æ•°æ®å¯é æ€§çš„çº§åˆ«ï¼š

- 1ï¼ˆé»˜è®¤ï¼‰ï¼šè¿™æ„å‘³ç€ Producer åœ¨ ISR ä¸­çš„ Leader å·²æˆåŠŸæ”¶åˆ°çš„æ•°æ®å¹¶å¾—åˆ°ç¡®è®¤åå‘é€ä¸‹ä¸€æ¡ message ã€‚å¦‚æœ Leader å®•æœºäº†ï¼Œåˆ™ä¼šä¸¢å¤±æ•°æ®ã€‚
- 0ï¼šè¿™æ„å‘³ç€ Producer æ— éœ€ç­‰å¾…æ¥è‡ª Broker çš„ç¡®è®¤è€Œç»§ç»­å‘é€ä¸‹ä¸€æ‰¹æ¶ˆæ¯ã€‚è¿™ç§æƒ…å†µä¸‹æ•°æ®ä¼ è¾“æ•ˆç‡æœ€é«˜ï¼Œä½†æ˜¯æ•°æ®å¯é æ€§ç¡®æ˜¯æœ€ä½çš„ã€‚
- -1ï¼šProducer éœ€è¦ç­‰å¾… ISR ä¸­çš„æ‰€æœ‰ Follower éƒ½ç¡®è®¤æ¥æ”¶åˆ°æ•°æ®åæ‰ç®—ä¸€æ¬¡å‘é€å®Œæˆï¼Œå¯é æ€§æœ€é«˜ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œæ¯”å¦‚å½“ ISR ä¸­åªæœ‰ Leader æ—¶(å…¶ä»–èŠ‚ç‚¹éƒ½å’Œ Zookeeper æ–­å¼€è¿æ¥ï¼Œæˆ–è€…éƒ½æ²¡è¿½ä¸Š)ï¼Œè¿™æ ·å°±å˜æˆäº† `acks=1` çš„æƒ…å†µã€‚

å…³äºè¿™å—è¯¦è¯¦ç»†çš„å†…å®¹ï¼Œæ¨èé˜…è¯»

- [ã€ŠKafka æ•°æ®å¯é æ€§æ·±åº¦è§£è¯»ã€‹](https://blog.csdn.net/u013256816/article/details/71091774) çš„ [ã€Œ3 é«˜å¯é æ€§å­˜å‚¨åˆ†æã€](http://svip.iocoder.cn/Kafka/Interview/#) å°èŠ‚
- [ã€ŠKafka é›†ç¾¤å†…å¤åˆ¶åŠŸèƒ½æ·±å…¥å‰–æã€‹](https://www.jianshu.com/p/03d6a335237f)

## ZooKeeper åœ¨ Kafka ä¸­èµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼Ÿ

å…³äº ZooKeeper æ˜¯ä»€ä¹ˆï¼Œä¸äº†è§£çš„èƒ–å‹ï¼Œç›´æ¥å»çœ‹ [ã€Šç²¾å°½ Zookeeper é¢è¯•é¢˜ã€‹](http://svip.iocoder.cn/Zookeeper/Interview/) ã€‚

åœ¨åŸºäº Kafka çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼ŒZooKeeper çš„ä½œç”¨æœ‰ï¼š

- 1ã€Broker åœ¨ ZooKeeper ä¸­çš„æ³¨å†Œã€‚

- 2ã€Topic åœ¨ ZooKeeper ä¸­çš„æ³¨å†Œã€‚

- 3ã€Consumer åœ¨ ZooKeeper ä¸­çš„æ³¨å†Œã€‚

- 4ã€Producer è´Ÿè½½å‡è¡¡ã€‚

  > ä¸»è¦æŒ‡çš„æ˜¯ï¼ŒProducer ä» Zookeeper æ‹‰å– Topic å…ƒæ•°æ®ï¼Œä»è€Œèƒ½å¤Ÿå°†æ¶ˆæ¯å‘é€è´Ÿè½½å‡è¡¡åˆ°å¯¹åº” Topic çš„åˆ†åŒºä¸­ã€‚

- 5ã€Consumer è´Ÿè½½å‡è¡¡ã€‚

- 6ã€è®°å½•æ¶ˆè´¹è¿›åº¦ Offset ã€‚

  > Kafka å·²æ¨èå°† consumer çš„ Offset ä¿¡æ¯ä¿å­˜åœ¨ Kafka å†…éƒ¨çš„ Topic ä¸­ã€‚

- 7ã€è®°å½• Partition ä¸ Consumer çš„å…³ç³»ã€‚

å…¶å®ï¼Œæ€»ç»“èµ·æ¥ï¼Œå°±æ˜¯ä¸¤ç±»åŠŸèƒ½ï¼š

- Brokerã€Producerã€Consumer å’Œ Zookeeper çš„äº¤äº’ã€‚

  > å¯¹åº” 1ã€2ã€3ã€5 ã€‚

- ç›¸åº”çš„çŠ¶æ€å­˜å‚¨åˆ° Zookeeper ä¸­ã€‚

  > å¯¹åº” 4ã€6ã€7 ã€‚

è¯¦ç»†çš„æ¯ä¸€ç‚¹ï¼Œçœ‹ [ã€Šå†è°ˆåŸºäº Kafka å’Œ ZooKeeper çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åŸç†ã€‹](https://gitbook.cn/books/5bc446269a9adf54c7ccb8bc/index.html) çš„ [ã€ŒKafka æ¶æ„ä¸­ ZooKeeper ä»¥æ€æ ·çš„å½¢å¼å­˜åœ¨ï¼Ÿã€](http://svip.iocoder.cn/Kafka/Interview/#) å°èŠ‚ã€‚

## Kafka å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ

åœ¨ [ã€ŒKafka çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿã€](http://svip.iocoder.cn/Kafka/Interview/#) é—®é¢˜ä¸­ï¼Œå·²ç»åŸºæœ¬å›ç­”äº†è¿™ä¸ªé—®é¢˜ã€‚

[Kafka é›†ç¾¤](https://segmentfault.com/img/bVbcmpm?w=776&h=436)

- Zookeeper éƒ¨ç½² 2N+1 èŠ‚ç‚¹ï¼Œå½¢æˆ Zookeeper é›†ç¾¤ï¼Œä¿è¯é«˜å¯ç”¨ã€‚

- Kafka Broker éƒ¨ç½²é›†ç¾¤ã€‚æ¯ä¸ª Topic çš„ Partition ï¼ŒåŸºäºã€å‰¯æœ¬æœºåˆ¶ã€‘ï¼Œåœ¨ Broker é›†ç¾¤ä¸­å¤åˆ¶ï¼Œå½¢æˆ replica å‰¯æœ¬ï¼Œä¿è¯æ¶ˆæ¯å­˜å‚¨çš„å¯é æ€§ã€‚æ¯ä¸ª replica å‰¯æœ¬ï¼Œéƒ½ä¼šé€‰æ‹©å‡ºä¸€ä¸ª leader åˆ†åŒºï¼ˆPartitionï¼‰ï¼Œæä¾›ç»™å®¢æˆ·ç«¯ï¼ˆProducer å’Œ Consumerï¼‰è¿›è¡Œè¯»å†™ã€‚

- Kafka Producer æ— éœ€è€ƒè™‘é›†ç¾¤ï¼Œå› ä¸ºå’Œä¸šåŠ¡æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ã€‚Producer ä» Zookeeper æ‹‰å–åˆ° Topic çš„å…ƒæ•°æ®åï¼Œé€‰æ‹©å¯¹åº”çš„ Topic çš„ leader åˆ†åŒºï¼Œè¿›è¡Œæ¶ˆæ¯å‘é€å†™å…¥ã€‚è€Œ Broker æ ¹æ® Producer çš„ `request.required.acks` é…ç½®ï¼Œæ˜¯å†™å…¥è‡ªå·±å®Œæˆå°±å“åº”ç»™ Producer æˆåŠŸï¼Œè¿˜æ˜¯å†™å…¥æ‰€æœ‰ Broker å®Œæˆå†å“åº”ã€‚è¿™ä¸ªï¼Œå°±æ˜¯èƒ–å‹è‡ªå·±å¯¹æ¶ˆæ¯çš„å¯é æ€§çš„é€‰æ‹©ã€‚

- Kafka Consumer éƒ¨ç½²é›†ç¾¤ã€‚æ¯ä¸ª Consumer åˆ†é…å…¶å¯¹åº”çš„ Topic Partition ï¼Œæ ¹æ®å¯¹åº”çš„åˆ†é…ç­–ç•¥ã€‚å¹¶ä¸”ï¼ŒConsumer åªä» leader åˆ†åŒºï¼ˆPartitionï¼‰æ‹‰å–æ¶ˆæ¯ã€‚å¦å¤–ï¼Œå½“æœ‰æ–°çš„ Consumer åŠ å…¥æˆ–è€…è€çš„ Consumer ç¦»å¼€ï¼Œéƒ½ä¼šå°† Topic Partition å†å‡è¡¡ï¼Œé‡æ–°åˆ†é…ç»™ Consumer ã€‚

  > æ³¨æ„å™¢ï¼Œæ­¤å¤„è¯´çš„éƒ½æ˜¯åŒä¸€ä¸ª Kafka Consumer group ã€‚

æ€»çš„æ¥è¯´ï¼ŒKafka å’Œ RocketMQ çš„é«˜å¯ç”¨æ–¹å¼æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ï¼Œä¸»è¦çš„å·®å¼‚åœ¨ Kafka Broker çš„å‰¯æœ¬æœºåˆ¶ï¼Œå’Œ RocketMQ Broker çš„ä¸»ä»å¤åˆ¶ï¼Œä¸¤è€…çš„å·®å¼‚ï¼Œä»¥åŠå·®å¼‚å¸¦æ¥çš„ç”Ÿäº§å’Œæ¶ˆè´¹ä¸åŒã€‚ğŸ˜ˆ å½“ç„¶ï¼Œå®é™…ä¸Šï¼Œéƒ½æ˜¯å’Œâ€œä¸»â€ Broker åšæ¶ˆæ¯çš„å‘é€å’Œè¯»å–ä¸æ˜¯ï¼Ÿï¼

## ä»€ä¹ˆæ˜¯ Kafka äº‹åŠ¡ï¼Ÿ

æ¨èé˜…è¯» [ã€ŠKafka äº‹åŠ¡ç®€ä»‹ã€‹](https://blog.csdn.net/ransom0512/article/details/78840042) æ–‡ç« ã€‚

ğŸ˜ˆ å’Œæƒ³è±¡ä¸­çš„ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å·®åˆ«ï¼Ÿï¼

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ11. äº‹åŠ¡æ¶ˆæ¯ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

## Kafka æ˜¯å¦ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ

> è‰¿è‰¿ï¼šæ³¨æ„ï¼ŒKafka æ˜¯å¦ä¼šä¸¢æ•°æ®ï¼Œä¸»è¦å–å†³äºæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ã€‚è¿™ç‚¹ï¼Œéå¸¸é‡è¦å™¢ã€‚

ğŸ¦… **æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

å”¯ä¸€å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…å¼„ä¸¢æ•°æ®çš„æƒ…å†µï¼Œå°±æ˜¯è¯´ï¼Œä½ æ¶ˆè´¹åˆ°äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œç„¶åæ¶ˆè´¹è€…é‚£è¾¹è‡ªåŠ¨æäº¤äº† offset ï¼Œè®© Broker ä»¥ä¸ºä½ å·²ç»æ¶ˆè´¹å¥½äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œä½†å…¶å®ä½ æ‰åˆšå‡†å¤‡å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä½ è¿˜æ²¡å¤„ç†ï¼Œä½ è‡ªå·±å°±æŒ‚äº†ï¼Œæ­¤æ—¶è¿™æ¡æ¶ˆæ¯å°±ä¸¢å’¯ã€‚

è¿™ä¸æ˜¯è·Ÿ RabbitMQ å·®ä¸å¤šå—ï¼Œå¤§å®¶éƒ½çŸ¥é“ Kafka ä¼šè‡ªåŠ¨æäº¤ offset ï¼Œé‚£ä¹ˆåªè¦å…³é—­è‡ªåŠ¨æäº¤ offset ï¼Œåœ¨å¤„ç†å®Œä¹‹åè‡ªå·±æ‰‹åŠ¨æäº¤ offset ï¼Œå°±å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢ã€‚ä½†æ˜¯æ­¤æ—¶ç¡®å®è¿˜æ˜¯å¯èƒ½ä¼šæœ‰é‡å¤æ¶ˆè´¹ï¼Œæ¯”å¦‚ä½ åˆšå¤„ç†å®Œï¼Œè¿˜æ²¡æäº¤ offset ï¼Œç»“æœè‡ªå·±æŒ‚äº†ï¼Œæ­¤æ—¶è‚¯å®šä¼šé‡å¤æ¶ˆè´¹ä¸€æ¬¡ï¼Œè‡ªå·±ä¿è¯å¹‚ç­‰æ€§å°±å¥½äº†ã€‚

> RocketMQ push æ¨¡å¼ä¸‹ï¼Œåœ¨ç¡®è®¤æ¶ˆæ¯è¢«æ¶ˆè´¹å®Œæˆï¼Œæ‰ä¼šæäº¤ Offset ç»™ Broker ã€‚

ç”Ÿäº§ç¯å¢ƒç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬çš„ Kafka æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°äº†æ•°æ®ä¹‹åæ˜¯å†™åˆ°ä¸€ä¸ªå†…å­˜çš„ queue é‡Œå…ˆç¼“å†²ä¸€ä¸‹ï¼Œç»“æœæœ‰çš„æ—¶å€™ï¼Œä½ åˆšæŠŠæ¶ˆæ¯å†™å…¥å†…å­˜ queue ï¼Œç„¶åæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æäº¤ offset ã€‚ç„¶åæ­¤æ—¶æˆ‘ä»¬é‡å¯äº†ç³»ç»Ÿï¼Œå°±ä¼šå¯¼è‡´å†…å­˜ queue é‡Œè¿˜æ²¡æ¥å¾—åŠå¤„ç†çš„æ•°æ®å°±ä¸¢å¤±äº†ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ12. æ¶ˆè´¹è¿›åº¦çš„æäº¤æœºåˆ¶ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

ğŸ¦… **Broker å¼„ä¸¢äº†æ•°æ®ï¼Ÿ**

è¿™å—æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåœºæ™¯ï¼Œå°±æ˜¯ Kafka æŸä¸ª Broker å®•æœºï¼Œç„¶åé‡æ–°é€‰ä¸¾ Partition çš„ leaderã€‚å¤§å®¶æƒ³æƒ³ï¼Œè¦æ˜¯æ­¤æ—¶å…¶ä»–çš„ follower åˆšå¥½è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥ï¼Œç»“æœæ­¤æ—¶ leader æŒ‚äº†ï¼Œç„¶åé€‰ä¸¾æŸä¸ª follower æˆ leader ä¹‹åï¼Œä¸å°±å°‘äº†ä¸€äº›æ•°æ®ï¼Ÿè¿™å°±ä¸¢äº†ä¸€äº›æ•°æ®å•Šã€‚

ç”Ÿäº§ç¯å¢ƒä¹Ÿé‡åˆ°è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ï¼Œä¹‹å‰ Partition çš„ leader æœºå™¨å®•æœºäº†ï¼Œå°† follower åˆ‡æ¢ä¸º leader ä¹‹åï¼Œå°±ä¼šå‘ç°è¯´è¿™ä¸ªæ•°æ®å°±ä¸¢äº†ã€‚

æ‰€ä»¥æ­¤æ—¶ä¸€èˆ¬æ˜¯è¦æ±‚èµ·ç è®¾ç½®å¦‚ä¸‹ 4 ä¸ªå‚æ•°ï¼š

- ç»™ Topic è®¾ç½® `replication.factor` å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬ã€‚

- åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® `min.insync.replicas` å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1 ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower å§ã€‚

- åœ¨ Producer ç«¯è®¾ç½® `acks=all`ï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯**å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†**ã€‚

  > ä¸è¿‡è¿™ä¸ªä¹Ÿä¸ä¸€å®šèƒ½å¤Ÿç»å¯¹ä¿è¯ï¼Œä¾‹å¦‚è¯´ï¼ŒBroker é›†ç¾¤é‡Œï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‚äº†ï¼Œåªå‰©ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ­¤æ—¶ï¼Œ`acks=all` å’Œ `acks=1` å°±ç­‰ä»·äº†ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® `min.insync.replics` å‚æ•°ï¼Œæ¯æ¬¡å†™å…¥è¦æ±‚æœ€å°çš„åŒæ­¥å‰¯æœ¬æ•°ã€‚
  >
  > è¿™å—ä¹Ÿå’Œæœ‹å‹äº¤æµäº†ä¸‹ï¼Œä»–ä»¬é‡‘èåœºæ™¯ä¸‹ï¼Œ`acks=all` ä¹Ÿæ˜¯è¿™ä¹ˆé…ç½®çš„ã€‚åŸå› å˜›ï¼Œå› ä¸ºä»–ä»¬æ˜¯é‡‘èåœºæ™¯å‘€ã€‚

- åœ¨ Producer ç«¯è®¾ç½® `retries=MAX`ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯**è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•**ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚

æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒå°±æ˜¯æŒ‰ç…§ä¸Šè¿°è¦æ±‚é…ç½®çš„ï¼Œè¿™æ ·é…ç½®ä¹‹åï¼Œè‡³å°‘åœ¨ Kafka broker ç«¯å°±å¯ä»¥ä¿è¯åœ¨ leader æ‰€åœ¨ Broker å‘ç”Ÿæ•…éšœï¼Œè¿›è¡Œ leader åˆ‡æ¢æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

ğŸ¦… **ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ**

å¦‚æœæŒ‰ç…§ä¸Šè¿°çš„æ€è·¯è®¾ç½®äº† `acks=all` ï¼Œä¸€å®šä¸ä¼šä¸¢ï¼Œè¦æ±‚æ˜¯ï¼Œä½ çš„ leader æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„ follower éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬æ¬¡å†™æˆåŠŸäº†ã€‚å¦‚æœæ²¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ï¼Œé‡è¯•æ— é™æ¬¡ã€‚

- å…³äº Kafka Producer é‡è¯•å‘é€æ¶ˆæ¯çš„é€»è¾‘çš„æºç è§£æï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠKafka é‡è¯•æœºåˆ¶è§£è¯»ã€‹](https://www.jianshu.com/p/5bf9c7c02ada) ã€‚

------

ğŸ˜ˆ å¦å¤–ï¼Œåœ¨æ¨èä¸€ç¯‡æ–‡ç«  [ã€Š360 åº¦æµ‹è¯•ï¼šKAFKA ä¼šä¸¢æ•°æ®ä¹ˆï¼Ÿå…¶é«˜å¯ç”¨æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿã€‹](https://juejin.im/post/5bf8f2bee51d4507c12bc722) ï¼Œæä¾›äº†ä¸€äº›æµ‹è¯•ç¤ºä¾‹ã€‚

å…³äºè¿™ä¸€å—ï¼Œå¯ä»¥é‡ç‚¹çœ‹çœ‹ [ã€ŠKafka æƒå¨æŒ‡å—ã€‹](https://u.jd.com/jJpbF8) çš„ [ã€Œ6.4 åœ¨å¯é çš„ç³»ç»Ÿé‡Œä½¿ç”¨ç”Ÿäº§è€…ã€](http://svip.iocoder.cn/Kafka/Interview/#) å’Œ [ã€Œ6.5 åœ¨å¯é çš„ç³»ç»Ÿé‡Œä½¿ç”¨æ¶ˆè´¹è€…ã€](http://svip.iocoder.cn/Kafka/Interview/#) å°èŠ‚ã€‚

## Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

Kafka æœ¬èº«ï¼Œå¹¶ä¸åƒ RocketMQ ä¸€æ ·ï¼Œæä¾›é¡ºåºæ€§çš„æ¶ˆæ¯ã€‚æ‰€ä»¥ï¼Œæä¾›çš„æ–¹æ¡ˆï¼Œéƒ½æ˜¯ç›¸å¯¹æœ‰æŸçš„ã€‚å¦‚ä¸‹ï¼š

> è¿™é‡Œçš„é¡ºåºæ¶ˆæ¯ï¼Œæˆ‘ä»¬æ›´å¤šæŒ‡çš„æ˜¯ï¼Œå•ä¸ª Partition çš„æ¶ˆæ¯ï¼Œè¢«é¡ºåºæ¶ˆè´¹ã€‚

- æ–¹å¼ä¸€ï¼ŒConsumer ï¼Œå¯¹æ¯ä¸ª Partition å†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªã€‚

- æ–¹å¼äºŒï¼ŒConsumer ï¼Œæ‹‰å–åˆ°æ¶ˆæ¯åï¼Œå†™åˆ° N ä¸ªå†…å­˜ queueï¼Œå…·æœ‰ç›¸åŒ key çš„æ•°æ®éƒ½åˆ°åŒä¸€ä¸ªå†…å­˜ queue ã€‚ç„¶åï¼Œå¯¹äº N ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜ queue å³å¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§ã€‚

  > è¿™ç§æ–¹å¼ï¼Œç›¸å½“äºå¯¹ã€æ–¹å¼ä¸€ã€‘çš„æ”¹è¿›ï¼Œå°†ç›¸åŒ Partition çš„æ¶ˆæ¯è¿›ä¸€æ­¥æ‹†åˆ†ï¼Œä¿è¯ç›¸åŒ key çš„æ•°æ®æ¶ˆè´¹æ˜¯é¡ºåºçš„ã€‚
  >
  > ä¸è¿‡è¿™ç§æ–¹å¼ï¼Œæ¶ˆè´¹è¿›åº¦çš„æ›´æ–°ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚

å½“ç„¶ï¼Œå®é™…æƒ…å†µä¹Ÿä¸å¤ªéœ€è¦è€ƒè™‘æ¶ˆæ¯çš„é¡ºåºæ€§ï¼ŒåŸºæœ¬æ²¡æœ‰ä¸šåŠ¡éœ€è¦ã€‚

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠèŠ‹é“ Spring Boot æ¶ˆæ¯é˜Ÿåˆ— Kafka å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/RabbitMQ/?vip)çš„[ã€Œ10. é¡ºåºæ¶ˆæ¯ã€](http://svip.iocoder.cn/Kafka/Interview/#)å°èŠ‚ã€‚

## 666. å½©è›‹

ğŸ˜ˆ ç•¥æ˜¾ä»“ä¿ƒçš„ä¸€ç¯‡æ–‡ç« ï¼Œåç»­ä¼šé‡æ–°åœ¨æ¢³ç†ä¸€ä¸‹ã€‚å¦‚æœèƒ–å‹å¯¹ Kafka æœ‰ä»€ä¹ˆç–‘æƒ‘ï¼Œä¸€å®šè¦åœ¨æ˜Ÿçƒé‡Œæå‡ºï¼Œæˆ‘ä»¬ä¸€èµ·åœ¨è®¨è®ºå’Œè§£ç­”ä¸€æ³¢ï¼Œç„¶åæ•´ç†åˆ°è¿™ç¯‡æ–‡ç« ä¸­ã€‚

åŒæ—¶ï¼ŒæœŸå¾…ä¸‹å®å¤§çš„ Kafka æ–°ä¹¦ã€‚

å‚è€ƒä¸æ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- [ã€Šé«˜å¹¶å‘é¢è¯•å¿…é—®ï¼šåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿ Kafka ç®€ä»‹ã€‹](https://blog.csdn.net/caisini_vc/article/details/48007297)

- [ã€Š14 ä¸ªæœ€å¸¸è§çš„ Kafka é¢è¯•é¢˜åŠç­”æ¡ˆã€‹](https://blog.csdn.net/yjh314/article/details/77568580)

  > è¿™ç¯‡åšå®¢ï¼Œæœ‰ç‚¹å‚»é€¼ã€‚ã€‚ã€‚ã€‚

- [ã€Šä½ éœ€è¦çŸ¥é“çš„ Kafkaã€‹](https://juejin.im/post/5b573eafe51d45198f5c80a4)

- [ã€ŠKafka å†…éƒ¨ç½‘ç»œæ¡†æ¶æ¨¡å‹åˆ†æã€‹](https://blog.csdn.net/lizhitao/article/details/52332749)

- [ã€Šå†è°ˆåŸºäº Kafka å’Œ ZooKeeper çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åŸç†ã€‹](https://gitbook.cn/books/5bc446269a9adf54c7ccb8bc/index.html)

- [ã€Šå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰ã€‹](https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages.md)