## Reactorçº¿ç¨‹æ¨¡å‹

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚ä½ å…ˆèŠèŠ Reactorçº¿ç¨‹æ¨¡å‹å§ï¼

ğŸ™‹ **æˆ‘** ï¼šå¥½çš„å‘€ï¼

**Reactoræ˜¯ä¸€ç§ç»å…¸çš„çº¿ç¨‹æ¨¡å‹ï¼ŒReactoræ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†æµ·é‡çš„I/Oäº‹ä»¶ã€‚**

Reactorçº¿ç¨‹æ¨¡å‹åˆ†ä¸ºå•çº¿ç¨‹æ¨¡å‹ã€å¤šçº¿ç¨‹æ¨¡å‹ä»¥åŠä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ã€‚

> ä»¥ä¸‹å›¾ç‰‡æ¥æºäºç½‘ç»œï¼ŒåŸå‡ºå¤„ä¸æ˜ï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»æˆ‘ã€‚

### å•çº¿ç¨‹Reactor

æ‰€æœ‰çš„IOæ“ä½œéƒ½ç”±åŒä¸€ä¸ªNIOçº¿ç¨‹å¤„ç†ã€‚

![å•çº¿ç¨‹Reactor](https://images.xiaozhuanlan.com/photo/2020/6d32fa6864dca981b603c68bada2074e.png)

å•çº¿ç¨‹Reactor



**å•çº¿ç¨‹ Reactor çš„ä¼˜ç‚¹æ˜¯å¯¹ç³»ç»Ÿèµ„æºæ¶ˆè€—ç‰¹åˆ«å°ï¼Œä½†æ˜¯ï¼Œæ²¡åŠæ³•æ”¯æ’‘å¤§é‡è¯·æ±‚çš„åº”ç”¨åœºæ™¯å¹¶ä¸”å¤„ç†è¯·æ±‚çš„æ—¶é—´å¯èƒ½éå¸¸æ…¢ï¼Œæ¯•ç«Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œå˜›ï¼æ‰€ä»¥ï¼Œä¸€èˆ¬å®é™…é¡¹ç›®ä¸­ä¸ä¼šä½¿ç”¨å•çº¿ç¨‹Reactor ã€‚**

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¼”è¿›å‡ºäº†Reactorå¤šçº¿ç¨‹æ¨¡å‹ã€‚

### å¤šçº¿ç¨‹Reactor

ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ¥å—è¯·æ±‚,ä¸€ç»„NIOçº¿ç¨‹å¤„ç†IOæ“ä½œã€‚

![å¤šçº¿ç¨‹Reactor](https://images.xiaozhuanlan.com/photo/2020/45c3e2cd0d14c7d59a5d40be22edeb59.png)

å¤šçº¿ç¨‹Reactor



**å¤§éƒ¨åˆ†åœºæ™¯ä¸‹å¤šçº¿ç¨‹Reactoræ¨¡å‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨ä¸€äº›å¹¶å‘è¿æ¥æ•°æ¯”è¾ƒå¤šï¼ˆå¦‚ç™¾ä¸‡å¹¶å‘ï¼‰çš„åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ¥å—å®¢æˆ·ç«¯è¯·æ±‚å°±å­˜åœ¨æ€§èƒ½é—®é¢˜äº†ã€‚**

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¼”è¿›å‡ºäº†ä¸»ä»å¤šçº¿ç¨‹Reactoræ¨¡å‹ã€‚

### ä¸»ä»å¤šçº¿ç¨‹Reactor

ä¸€ç»„NIOçº¿ç¨‹è´Ÿè´£æ¥å—è¯·æ±‚ï¼Œä¸€ç»„NIOçº¿ç¨‹å¤„ç†IOæ“ä½œã€‚

![ä¸»ä»å¤šçº¿ç¨‹](https://images.xiaozhuanlan.com/photo/2020/c437e9d3e8f6e1bf884eb25e04b5d112.png)

ä¸»ä»å¤šçº¿ç¨‹



## Netty çº¿ç¨‹æ¨¡å‹äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šè¯´ä¸€ä¸‹ Netty çº¿ç¨‹æ¨¡å‹å§ï¼

ğŸ™‹ **æˆ‘** ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚

> Reactor æ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œé‡‡ç”¨å¤šè·¯å¤ç”¨å°†äº‹ä»¶åˆ†å‘ç»™ç›¸åº”çš„ Handler å¤„ç†ï¼Œéå¸¸é€‚åˆå¤„ç†æµ·é‡ IO çš„åœºæ™¯ã€‚

åœ¨ Netty ä¸»è¦é  `NioEventLoopGroup` çº¿ç¨‹æ± æ¥å®ç°å…·ä½“çš„çº¿ç¨‹æ¨¡å‹çš„ ã€‚

æˆ‘ä»¬å®ç°æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šåˆå§‹åŒ–ä¸¤ä¸ªçº¿ç¨‹ç»„ï¼š

1. **`bossGroup`** :æ¥æ”¶è¿æ¥ã€‚
2. **`workerGroup`** ï¼šè´Ÿè´£å…·ä½“çš„å¤„ç†ï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ Netty ä¸­çš„çº¿ç¨‹æ¨¡å‹å§ï¼

### å•çº¿ç¨‹æ¨¡å‹

ä¸€ä¸ªçº¿ç¨‹éœ€è¦æ‰§è¡Œå¤„ç†æ‰€æœ‰çš„ `accept`ã€`read`ã€`decode`ã€`process`ã€`encode`ã€`send` äº‹ä»¶ã€‚å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘ï¼Œå¹¶ä¸”å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚

å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„

> ä½¿ç”¨ `NioEventLoopGroup` ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° \*2** ã€‚

```java
  //1.eventGroupæ—¢ç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆè´Ÿè´£å…·ä½“çš„å¤„ç†ã€‚
  EventLoopGroup eventGroup = new NioEventLoopGroup(1);
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
            boobtstrap.group(eventGroup, eventGroup)
            //......
```

### å¤šçº¿ç¨‹æ¨¡å‹

ä¸€ä¸ª Acceptor çº¿ç¨‹åªè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œä¸€ä¸ª NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç†ï¼š `accept`ã€`read`ã€`decode`ã€`process`ã€`encode`ã€`send` äº‹ä»¶ã€‚æ»¡è¶³ç»å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯ï¼Œå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯é‡åˆ°å¹¶å‘è¿æ¥å¤§çš„æ—¶å€™å°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```

![img](https://images.xiaozhuanlan.com/photo/2020/c1331bc2a17c2e0bc6b832833ffda9bb.png)

### ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹

ä»ä¸€ä¸ª ä¸»çº¿ç¨‹ NIO çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ä½œä¸º Acceptor çº¿ç¨‹ï¼Œç»‘å®šç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„è¿æ¥ï¼Œå…¶ä»–çº¿ç¨‹è´Ÿè´£åç»­çš„æ¥å…¥è®¤è¯ç­‰å·¥ä½œã€‚è¿æ¥å»ºç«‹å®Œæˆåï¼ŒSub NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç† I/O è¯»å†™ã€‚å¦‚æœå¤šçº¿ç¨‹æ¨¡å‹æ— æ³•æ»¡è¶³ä½ çš„éœ€æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ ã€‚

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup();
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```

![img](https://images.xiaozhuanlan.com/photo/2020/fcf90a64c3f7ce49b47c1d07ba3b9edb.png)

## Netty æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨è¿‡ç¨‹äº†è§£ä¹ˆï¼Ÿ

### æœåŠ¡ç«¯

```java
        // 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
            ServerBootstrap b = new ServerBootstrap();
            //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
            b.group(bossGroup, workerGroup)
                    // (éå¿…å¤‡)æ‰“å°æ—¥å¿—
                    .handler(new LoggingHandler(LogLevel.INFO))
                    // 4.æŒ‡å®š IO æ¨¡å‹
                    .channel(NioServerSocketChannel.class)
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) {
                            ChannelPipeline p = ch.pipeline();
                            //5.å¯ä»¥è‡ªå®šä¹‰å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                            p.addLast(new HelloServerHandler());
                        }
                    });
            // 6.ç»‘å®šç«¯å£,è°ƒç”¨ sync æ–¹æ³•é˜»å¡çŸ¥é“ç»‘å®šå®Œæˆ
            ChannelFuture f = b.bind(port).sync();
            // 7.é˜»å¡ç­‰å¾…ç›´åˆ°æœåŠ¡å™¨Channelå…³é—­(closeFuture()æ–¹æ³•è·å–Channel çš„CloseFutureå¯¹è±¡,ç„¶åè°ƒç”¨sync()æ–¹æ³•)
            f.channel().closeFuture().sync();
        } finally {
            //8.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
```

ç®€å•è§£æä¸€ä¸‹æœåŠ¡ç«¯çš„åˆ›å»ºè¿‡ç¨‹å…·ä½“æ˜¯æ€æ ·çš„ï¼š

1.é¦–å…ˆä½ åˆ›å»ºäº†ä¸¤ä¸ª `NioEventLoopGroup` å¯¹è±¡å®ä¾‹ï¼š`bossGroup` å’Œ `workerGroup`ã€‚

- `bossGroup` : ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„ TCP è¿æ¥è¯·æ±‚ã€‚
- `workerGroup` ï¼š è´Ÿè´£æ¯ä¸€æ¡è¿æ¥çš„å…·ä½“è¯»å†™æ•°æ®çš„å¤„ç†é€»è¾‘ï¼ŒçœŸæ­£è´Ÿè´£ I/O è¯»å†™æ“ä½œï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬æŠŠå…¬å¸çš„è€æ¿å½“åš bossGroupï¼Œå‘˜å·¥å½“åš workerGroupï¼ŒbossGroup åœ¨å¤–é¢æ¥å®Œæ´»ä¹‹åï¼Œæ‰”ç»™ workerGroup å»å¤„ç†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæŒ‡å®š bossGroup çš„ çº¿ç¨‹æ•°ä¸º 1ï¼ˆå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™ï¼‰ ï¼ŒworkGroup çš„çº¿ç¨‹æ•°é‡ä¸º **CPU æ ¸å¿ƒæ•° \*2\*** *ã€‚å¦å¤–ï¼Œæ ¹æ®æºç æ¥çœ‹ï¼Œä½¿ç”¨ `NioEventLoopGroup` ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° \*****2** ã€‚

2.æ¥ä¸‹æ¥ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼š `ServerBootstrap`ï¼Œè¿™ä¸ªç±»å°†å¼•å¯¼æˆ‘ä»¬è¿›è¡ŒæœåŠ¡ç«¯çš„å¯åŠ¨å·¥ä½œã€‚

3.é€šè¿‡ `.group()` æ–¹æ³•ç»™å¼•å¯¼ç±» `ServerBootstrap` é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„ï¼Œç¡®å®šäº†çº¿ç¨‹æ¨¡å‹ã€‚

é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å®é™…é…ç½®çš„æ˜¯å¤šçº¿ç¨‹æ¨¡å‹ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢æåˆ°è¿‡ã€‚

```java
    EventLoopGroup bossGroup = new NioEventLoopGroup(1);
    EventLoopGroup workerGroup = new NioEventLoopGroup();
```

4.é€šè¿‡`channel()`æ–¹æ³•ç»™å¼•å¯¼ç±» `ServerBootstrap`æŒ‡å®šäº† IO æ¨¡å‹ä¸º`NIO`

- `NioServerSocketChannel` ï¼šæŒ‡å®šæœåŠ¡ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`ServerSocket`å¯¹åº”

- `NioSocketChannel` : æŒ‡å®šå®¢æˆ·ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œ ä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`Socket`å¯¹åº”

   

  5.é€šè¿‡ `.childHandler()`ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ª`ChannelInitializer` ï¼Œç„¶åæŒ‡å®šäº†æœåŠ¡ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ `HelloServerHandler` å¯¹è±¡

   

  6.è°ƒç”¨ `ServerBootstrap` ç±»çš„ `bind()`æ–¹æ³•ç»‘å®šç«¯å£

### å®¢æˆ·ç«¯

```java
        //1.åˆ›å»ºä¸€ä¸ª NioEventLoopGroup å¯¹è±¡å®ä¾‹
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
            Bootstrap b = new Bootstrap();
            //3.æŒ‡å®šçº¿ç¨‹ç»„
            b.group(group)
                    //4.æŒ‡å®š IO æ¨¡å‹
                    .channel(NioSocketChannel.class)
                    .handler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) throws Exception {
                            ChannelPipeline p = ch.pipeline();
                            // 5.è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                            p.addLast(new HelloClientHandler(message));
                        }
                    });
            // 6.å°è¯•å»ºç«‹è¿æ¥
            ChannelFuture f = b.connect(host, port).sync();
            // 7.ç­‰å¾…è¿æ¥å…³é—­ï¼ˆé˜»å¡ï¼Œç›´åˆ°Channelå…³é—­ï¼‰
            f.channel().closeFuture().sync();
        } finally {
            group.shutdownGracefully();
        }
```

ç»§ç»­åˆ†æä¸€ä¸‹å®¢æˆ·ç«¯çš„åˆ›å»ºæµç¨‹ï¼š

1.åˆ›å»ºä¸€ä¸ª `NioEventLoopGroup` å¯¹è±¡å®ä¾‹

2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨çš„å¼•å¯¼ç±»æ˜¯ `Bootstrap`

3.é€šè¿‡ `.group()` æ–¹æ³•ç»™å¼•å¯¼ç±» `Bootstrap` é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„

4.é€šè¿‡`channel()`æ–¹æ³•ç»™å¼•å¯¼ç±» `Bootstrap`æŒ‡å®šäº† IO æ¨¡å‹ä¸º`NIO`

5.é€šè¿‡ `.childHandler()`ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ª`ChannelInitializer` ï¼Œç„¶åæŒ‡å®šäº†å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ `HelloClientHandler` å¯¹è±¡

6.è°ƒç”¨ `Bootstrap` ç±»çš„ `connect()`æ–¹æ³•è¿›è¡Œè¿æ¥ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°ï¼š

- `inetHost` : ip åœ°å€
- `inetPort` : ç«¯å£å·

```java
    public ChannelFuture connect(String inetHost, int inetPort) {
        return this.connect(InetSocketAddress.createUnresolved(inetHost, inetPort));
    }
    public ChannelFuture connect(SocketAddress remoteAddress) {
        ObjectUtil.checkNotNull(remoteAddress, "remoteAddress");
        this.validate();
        return this.doResolveAndConnect(remoteAddress, this.config.localAddress());
    }
```

`connect` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡

```java
public interface ChannelFuture extends Future<Void> {
  ......
}
```

ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬é€šè¿‡ `addListener` æ–¹æ³•å¯ä»¥ç›‘å¬åˆ°è¿æ¥æ˜¯å¦æˆåŠŸï¼Œè¿›è€Œæ‰“å°å‡ºè¿æ¥ä¿¡æ¯ã€‚å…·ä½“åšæ³•å¾ˆç®€å•ï¼Œåªéœ€è¦å¯¹ä»£ç è¿›è¡Œä»¥ä¸‹æ”¹åŠ¨ï¼š

```java
ChannelFuture f = b.connect(host, port).addListener(future -> {
  if (future.isSuccess()) {
    System.out.println("è¿æ¥æˆåŠŸ!");
  } else {
    System.err.println("è¿æ¥å¤±è´¥!");
  }
}).sync();
```

## ä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?

ğŸ™‹ **æˆ‘** ï¼šTCP ç²˜åŒ…/æ‹†åŒ… å°±æ˜¯ä½ åŸºäº TCP å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå‡ºç°äº†å¤šä¸ªå­—ç¬¦ä¸²â€œç²˜â€åœ¨äº†ä¸€èµ·æˆ–è€…ä¸€ä¸ªå­—ç¬¦ä¸²è¢«â€œæ‹†â€å¼€çš„é—®é¢˜ã€‚æ¯”å¦‚ä½ å¤šæ¬¡å‘é€ï¼šâ€œä½ å¥½,ä½ çœŸå¸…å•Šï¼å“¥å“¥ï¼â€ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

![img](https://images.xiaozhuanlan.com/photo/2020/dc9333dd36170d22dbf701451f9b49c3.png)

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šé‚£æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢?

ğŸ™‹ **æˆ‘** ï¼š

**1.ä½¿ç”¨ Netty è‡ªå¸¦çš„è§£ç å™¨**

- **`LineBasedFrameDecoder`** : å‘é€ç«¯å‘é€æ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ¯ä¸ªæ•°æ®åŒ…ä¹‹é—´ä»¥æ¢è¡Œç¬¦ä½œä¸ºåˆ†éš”ï¼Œ`LineBasedFrameDecoder` çš„å·¥ä½œåŸç†æ˜¯å®ƒä¾æ¬¡éå† `ByteBuf` ä¸­çš„å¯è¯»å­—èŠ‚ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ¢è¡Œç¬¦ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æˆªå–ã€‚
- **`DelimiterBasedFrameDecoder`** : å¯ä»¥è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨ï¼Œ**`LineBasedFrameDecoder`** å®é™…ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„ `DelimiterBasedFrameDecoder` è§£ç å™¨ã€‚
- **`FixedLengthFrameDecoder`**: å›ºå®šé•¿åº¦è§£ç å™¨ï¼Œå®ƒèƒ½å¤ŸæŒ‰ç…§æŒ‡å®šçš„é•¿åº¦å¯¹æ¶ˆæ¯è¿›è¡Œç›¸åº”çš„æ‹†åŒ…ã€‚
- **`LengthFieldBasedFrameDecoder`**ï¼š

**2.è‡ªå®šä¹‰åºåˆ—åŒ–ç¼–è§£ç å™¨**

åœ¨ Java ä¸­è‡ªå¸¦çš„æœ‰å®ç° `Serializable` æ¥å£æ¥å®ç°åºåˆ—åŒ–ï¼Œä½†ç”±äºå®ƒæ€§èƒ½ã€å®‰å…¨æ€§ç­‰åŸå› ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¢«ä½¿ç”¨åˆ°çš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Protostuffã€Hessian2ã€json åºåˆ—æ–¹å¼æ¯”è¾ƒå¤šï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›åºåˆ—åŒ–æ€§èƒ½éå¸¸å¥½çš„åºåˆ—åŒ–æ–¹å¼ä¹Ÿæ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼š

- ä¸“é—¨é’ˆå¯¹ Java è¯­è¨€çš„ï¼šKryoï¼ŒFST ç­‰ç­‰
- è·¨è¯­è¨€çš„ï¼šProtostuffï¼ˆåŸºäº protobuf å‘å±•è€Œæ¥ï¼‰ï¼ŒProtoBufï¼ŒThriftï¼ŒAvroï¼ŒMsgPack ç­‰ç­‰

> ç”±äºç¯‡å¹…é—®é¢˜ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­è¯¦ç»†åˆ†æä»‹ç»~~~

## Netty é•¿è¿æ¥ã€å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šTCP é•¿è¿æ¥å’ŒçŸ­è¿æ¥äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼šæˆ‘ä»¬çŸ¥é“ TCP åœ¨è¿›è¡Œè¯»å†™ä¹‹å‰ï¼Œserver ä¸ client ä¹‹é—´å¿…é¡»æå‰å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬å¸¸è¯´çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œé‡Šæ”¾/å…³é—­è¿æ¥çš„è¯éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ¶ˆè€—ç½‘ç»œèµ„æºå¹¶ä¸”æœ‰æ—¶é—´å»¶è¿Ÿçš„ã€‚

æ‰€è°“ï¼ŒçŸ­è¿æ¥è¯´çš„å°±æ˜¯ server ç«¯ ä¸ client ç«¯å»ºç«‹è¿æ¥ä¹‹åï¼Œè¯»å†™å®Œæˆä¹‹åå°±å…³é—­æ‰è¿æ¥ï¼Œå¦‚æœä¸‹ä¸€æ¬¡å†è¦äº’ç›¸å‘é€æ¶ˆæ¯ï¼Œå°±è¦é‡æ–°è¿æ¥ã€‚çŸ­è¿æ¥çš„æœ‰ç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ç®¡ç†å’Œå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯ä¸€æ¬¡çš„è¯»å†™éƒ½è¦å»ºç«‹è¿æ¥å¿…ç„¶ä¼šå¸¦æ¥å¤§é‡ç½‘ç»œèµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”è¿æ¥çš„å»ºç«‹ä¹Ÿéœ€è¦è€—è´¹æ—¶é—´ã€‚

é•¿è¿æ¥è¯´çš„å°±æ˜¯ client å‘ server åŒæ–¹å»ºç«‹è¿æ¥ä¹‹åï¼Œå³ä½¿ client ä¸ server å®Œæˆä¸€æ¬¡è¯»å†™ï¼Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥å¹¶ä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œåç»­çš„è¯»å†™æ“ä½œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚é•¿è¿æ¥çš„å¯ä»¥çœå»è¾ƒå¤šçš„ TCP å»ºç«‹å’Œå…³é—­çš„æ“ä½œï¼Œé™ä½å¯¹ç½‘ç»œèµ„æºçš„ä¾èµ–ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚å¯¹äºé¢‘ç¹è¯·æ±‚èµ„æºçš„å®¢æˆ·æ¥è¯´ï¼Œéå¸¸é€‚ç”¨é•¿è¿æ¥ã€‚

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³æœºåˆ¶ï¼ŸNetty ä¸­å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼š

åœ¨ TCP ä¿æŒé•¿è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æ–­ç½‘ç­‰ç½‘ç»œå¼‚å¸¸å‡ºç°ï¼Œå¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œ client ä¸ server ä¹‹é—´å¦‚æœæ²¡æœ‰äº¤äº’çš„è¯ï¼Œå®ƒä»¬æ˜¯æ— æ³•å‘ç°å¯¹æ–¹å·²ç»æ‰çº¿çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬å°±éœ€è¦å¼•å…¥ **å¿ƒè·³æœºåˆ¶** ã€‚

å¿ƒè·³æœºåˆ¶çš„å·¥ä½œåŸç†æ˜¯: åœ¨ client ä¸ server ä¹‹é—´åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº¤äº’æ—¶, å³å¤„äº idle çŠ¶æ€æ—¶, å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å°±ä¼šå‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åŒ…ç»™å¯¹æ–¹, å½“æ¥æ”¶æ–¹æ”¶åˆ°è¿™ä¸ªæ•°æ®æŠ¥æ–‡å, ä¹Ÿç«‹å³å‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®æŠ¥æ–‡, å›åº”å‘é€æ–¹, æ­¤å³ä¸€ä¸ª PING-PONG äº¤äº’ã€‚æ‰€ä»¥, å½“æŸä¸€ç«¯æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯å, å°±çŸ¥é“äº†å¯¹æ–¹ä»ç„¶åœ¨çº¿, è¿™å°±ç¡®ä¿ TCP è¿æ¥çš„æœ‰æ•ˆæ€§.

TCP å®é™…ä¸Šè‡ªå¸¦çš„å°±æœ‰é•¿è¿æ¥é€‰é¡¹ï¼Œæœ¬èº«æ˜¯ä¹Ÿæœ‰å¿ƒè·³åŒ…æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ TCP çš„é€‰é¡¹ï¼š`SO_KEEPALIVE`ã€‚ ä½†æ˜¯ï¼ŒTCP åè®®å±‚é¢çš„é•¿è¿æ¥çµæ´»æ€§ä¸å¤Ÿã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯åœ¨åº”ç”¨å±‚åè®®ä¸Šå®ç°è‡ªå®šä¹‰å¿ƒè·³æœºåˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ Netty å±‚é¢é€šè¿‡ç¼–ç å®ç°ã€‚é€šè¿‡ Netty å®ç°å¿ƒè·³æœºåˆ¶çš„è¯ï¼Œæ ¸å¿ƒç±»æ˜¯ `IdleStateHandler` ã€‚

## Netty çš„é›¶æ‹·è´äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šè®²è®² Netty çš„é›¶æ‹·è´ï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼š

ç»´åŸºç™¾ç§‘æ˜¯è¿™æ ·ä»‹ç»é›¶æ‹·è´çš„ï¼š

> é›¶å¤åˆ¶ï¼ˆè‹±è¯­ï¼šZero-copyï¼›ä¹Ÿè¯‘é›¶æ‹·è´ï¼‰æŠ€æœ¯æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡Œæ“ä½œæ—¶ï¼ŒCPU ä¸éœ€è¦å…ˆå°†æ•°æ®ä»æŸå¤„å†…å­˜å¤åˆ¶åˆ°å¦ä¸€ä¸ªç‰¹å®šåŒºåŸŸã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºé€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶æ—¶èŠ‚çœ CPU å‘¨æœŸå’Œå†…å­˜å¸¦å®½ã€‚

åœ¨ OS å±‚é¢ä¸Šçš„ `Zero-copy` é€šå¸¸æŒ‡é¿å…åœ¨ `ç”¨æˆ·æ€(User-space)` ä¸ `å†…æ ¸æ€(Kernel-space)` ä¹‹é—´æ¥å›æ‹·è´æ•°æ®ã€‚è€Œåœ¨ Netty å±‚é¢ ï¼Œé›¶æ‹·è´ä¸»è¦ä½“ç°åœ¨å¯¹äºæ•°æ®æ“ä½œçš„ä¼˜åŒ–ã€‚

Netty ä¸­çš„é›¶æ‹·è´ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢

1. ä½¿ç”¨ Netty æä¾›çš„ `CompositeByteBuf` ç±», å¯ä»¥å°†å¤šä¸ª`ByteBuf` åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ `ByteBuf`, é¿å…äº†å„ä¸ª `ByteBuf` ä¹‹é—´çš„æ‹·è´ã€‚
2. `ByteBuf` æ”¯æŒ slice æ“ä½œ, å› æ­¤å¯ä»¥å°† ByteBuf åˆ†è§£ä¸ºå¤šä¸ªå…±äº«åŒä¸€ä¸ªå­˜å‚¨åŒºåŸŸçš„ `ByteBuf`, é¿å…äº†å†…å­˜çš„æ‹·è´ã€‚
3. é€šè¿‡ `FileRegion` åŒ…è£…çš„`FileChannel.tranferTo` å®ç°æ–‡ä»¶ä¼ è¾“, å¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ `Channel`, é¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯ write æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜.

## å‚è€ƒ

- netty å­¦ä¹ ç³»åˆ—äºŒï¼šNIO Reactor æ¨¡å‹ & Netty çº¿ç¨‹æ¨¡å‹ï¼šhttps://www.jianshu.com/p/38b56531565d
- ã€ŠNetty å®æˆ˜ã€‹
- Netty é¢è¯•é¢˜æ•´ç†(2):https://metatronxl.github.io/2019/10/22/Netty-
- Nettyï¼ˆ3ï¼‰æºç  NioEventLoopGroup:https://www.cnblogs.com/qdhxhz/p/10075568.html
- å¯¹äº Netty ByteBuf çš„é›¶æ‹·è´(Zero Copy) çš„ç†è§£: https://www.cnblogs.com/xys1228/p/6088805.html